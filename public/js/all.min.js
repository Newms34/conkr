"use strict";function Voronoi(){this.vertices=null,this.edges=null,this.cells=null,this.toRecycle=null,this.beachsectionJunkyard=[],this.circleEventJunkyard=[],this.vertexJunkyard=[],this.edgeJunkyard=[],this.cellJunkyard=[]}var hints=[{txt:"Login or Register to get started!",bottom:20,point:"log-btn"},{txt:"Wanna chat with other players? Click here!",bottom:30,point:"chat-btn"},{txt:"Let&rsquo;s start by making a new map! Pick an average number of countries and a smoothing amount, and then click here.",bottom:30,point:"make-map"},{txt:"Go ahead and start a new game. Feel free to set a password if you want!",bottom:30,point:"start-new-game-btn"},{txt:'Your friends can join your game by clicking here, and then clicking the "Join Game" button. Note: You won&rsquo;t be able to join any games, since you&rsquo;re in one!',bottom:30,point:"load-game-tab"},{txt:"Now click the Menu button to get back to main menu.",bottom:30,point:"men-butt"},{txt:"Once you&rsquo;re ready to start, click My Games, and then click Start Game.",bottom:30,point:"my-games-tab"},{txt:"This is the play field. Right now, you&rsquo;re in Move Mode. In this mode, you can move your armies between occupied countries. You can move as many armies as you want, as long as the origin and destination countries share a border, <i>and</i> the origin country contains more than one (1) army. You can also attack across one ocean block.",bottom:30,point:"game-parts"},{txt:"Once you&rsquo;re done, click here to begin Attack Mode.",bottom:30,point:"move-mode-btn"},{txt:"You&rsquo;re now in Attack Mode! Click one of your armies, and then click another player in an adjacent country. Click Attack, and you&rsquo;ll be prompted for how many armies you wish to involve in the attack. As in Move Mode, you must have at least two armies in order to attack, and your armies must share a border with the target country!",bottom:30,point:"game-parts"},{txt:"Once you&rsquo;re done laying waste to those foolish enough to stand in your way, click here to let the next player go. Keep in mind that before their turn, each player will be given additional armies based on how many territories they own.",bottom:30,point:"end-turn-btn"}],remHint=function(f,cb){var bg=document.querySelector("#hint-bg-div");f&&(localStorage.conkrHints=hints.length),bg.parentNode.removeChild(bg),"function"==typeof cb&&cb()},hintMaker=function(n,cb){if(!(localStorage.conkrHints&&parseInt(localStorage.conkrHints)>=n+1)){var bgDiv=document.createElement("div"),hintDiv=document.createElement("div"),leftPoint=document.querySelector("#"+hints[n].point).offsetLeft,topPoint=document.querySelector("#"+hints[n].point).offsetTop,pntr=document.createElement("div");hintDiv.innerHTML="<h3>&#128161; Hint</h3>"+hints[n].txt+'<hr/><small><input type="checkbox" id="no-more-hints"> No more hints, please!</small><hr/><button class="btn btn-primary" id="close-hint" onclick="remHint()">Got it!</button>',hintDiv.className="hint-msg",hintDiv.style.top=hints[n].bottom+"%",hintDiv.onclick=function(e){e.stopPropagation()},bgDiv.onclick=function(){remHint(document.querySelector("#no-more-hints").checked,cb)},bgDiv.className="hint-bg",bgDiv.style.height=window.outerHeight+"px",bgDiv.id="hint-bg-div",bgDiv.append(hintDiv),document.body.append(bgDiv);var pntrLen=Math.sqrt(Math.pow(Math.abs(leftPoint-hintDiv.offsetLeft),2)+Math.pow(Math.abs(topPoint-hintDiv.offsetTop),2));pntr.style.width=pntrLen+"px",pntr.className="hint-pointer";var amt=180*Math.asin((topPoint-hintDiv.offsetTop)/pntrLen)/Math.PI;leftPoint<hintDiv.offsetLeft&&(amt=180-amt),pntr.style.transform="rotate("+amt+"deg)",hintDiv.append(pntr);var arrowDiv=document.createElement("div");arrowDiv.className="hint-pnt-arrow",pntr.append(arrowDiv),document.querySelector("#hint-bg-div div.hint-msg button").onclick=function(e){e.stopPropagation(),remHint(document.querySelector("#no-more-hints").checked,cb)},localStorage.conkrHints=n+1}};!function(window){function QuadTree(bounds,pointQuad,maxDepth,maxChildren){var node;node=pointQuad?new Node(bounds,0,maxDepth,maxChildren):new BoundsNode(bounds,0,maxDepth,maxChildren),this.root=node}function Node(bounds,depth,maxDepth,maxChildren){this._bounds=bounds,this.children=[],this.nodes=[],maxChildren&&(this._maxChildren=maxChildren),maxDepth&&(this._maxDepth=maxDepth),depth&&(this._depth=depth)}function BoundsNode(bounds,depth,maxChildren,maxDepth){Node.call(this,bounds,depth,maxChildren,maxDepth),this._stuckChildren=[]}QuadTree.prototype.root=null,QuadTree.prototype.insert=function(item){if(item instanceof Array){var i,len=item.length;for(i=0;i<len;i++)this.root.insert(item[i])}else this.root.insert(item)},QuadTree.prototype.clear=function(){this.root.clear()},QuadTree.prototype.retrieve=function(item){var out=this.root.retrieve(item).slice(0);return out},Node.prototype.nodes=null,Node.prototype._classConstructor=Node,Node.prototype.children=null,Node.prototype._bounds=null,Node.prototype._depth=0,Node.prototype._maxChildren=4,Node.prototype._maxDepth=4,Node.TOP_LEFT=0,Node.TOP_RIGHT=1,Node.BOTTOM_LEFT=2,Node.BOTTOM_RIGHT=3,Node.prototype.insert=function(item){if(this.nodes.length){var index=this._findIndex(item);return void this.nodes[index].insert(item)}this.children.push(item);var len=this.children.length;if(!(this._depth>=this._maxDepth)&&len>this._maxChildren){this.subdivide();var i;for(i=0;i<len;i++)this.insert(this.children[i]);this.children.length=0}},Node.prototype.retrieve=function(item){if(this.nodes.length){var index=this._findIndex(item);return this.nodes[index].retrieve(item)}return this.children},Node.prototype._findIndex=function(item){var b=this._bounds,left=!(item.x>b.x+b.width/2),top=!(item.y>b.y+b.height/2),index=Node.TOP_LEFT;return left?top||(index=Node.BOTTOM_LEFT):index=top?Node.TOP_RIGHT:Node.BOTTOM_RIGHT,index},Node.prototype.subdivide=function(){var depth=this._depth+1,bx=this._bounds.x,by=this._bounds.y,b_w_h=this._bounds.width/2,b_h_h=this._bounds.height/2,bx_b_w_h=bx+b_w_h,by_b_h_h=by+b_h_h;this.nodes[Node.TOP_LEFT]=new this._classConstructor({x:bx,y:by,width:b_w_h,height:b_h_h},depth,this._maxDepth,this._maxChildren),this.nodes[Node.TOP_RIGHT]=new this._classConstructor({x:bx_b_w_h,y:by,width:b_w_h,height:b_h_h},depth,this._maxDepth,this._maxChildren),this.nodes[Node.BOTTOM_LEFT]=new this._classConstructor({x:bx,y:by_b_h_h,width:b_w_h,height:b_h_h},depth,this._maxDepth,this._maxChildren),this.nodes[Node.BOTTOM_RIGHT]=new this._classConstructor({x:bx_b_w_h,y:by_b_h_h,width:b_w_h,height:b_h_h},depth,this._maxDepth,this._maxChildren)},Node.prototype.clear=function(){this.children.length=0;var i,len=this.nodes.length;for(i=0;i<len;i++)this.nodes[i].clear();this.nodes.length=0},BoundsNode.prototype=new Node,BoundsNode.prototype._classConstructor=BoundsNode,BoundsNode.prototype._stuckChildren=null,BoundsNode.prototype._out=[],BoundsNode.prototype.insert=function(item){if(this.nodes.length){var index=this._findIndex(item),node=this.nodes[index];return void(item.x>=node._bounds.x&&item.x+item.width<=node._bounds.x+node._bounds.width&&item.y>=node._bounds.y&&item.y+item.height<=node._bounds.y+node._bounds.height?this.nodes[index].insert(item):this._stuckChildren.push(item))}this.children.push(item);var len=this.children.length;if(!(this._depth>=this._maxDepth)&&len>this._maxChildren){this.subdivide();var i;for(i=0;i<len;i++)this.insert(this.children[i]);this.children.length=0}},BoundsNode.prototype.getChildren=function(){return this.children.concat(this._stuckChildren)},BoundsNode.prototype.retrieve=function(item){var out=this._out;if(out.length=0,this.nodes.length){var index=this._findIndex(item),node=this.nodes[index];item.x>=node._bounds.x&&item.x+item.width<=node._bounds.x+node._bounds.width&&item.y>=node._bounds.y&&item.y+item.height<=node._bounds.y+node._bounds.height?out.push.apply(out,this.nodes[index].retrieve(item)):(item.x<=this.nodes[Node.TOP_RIGHT]._bounds.x&&(item.y<=this.nodes[Node.BOTTOM_LEFT]._bounds.y&&out.push.apply(out,this.nodes[Node.TOP_LEFT].getAllContent()),item.y+item.height>this.nodes[Node.BOTTOM_LEFT]._bounds.y&&out.push.apply(out,this.nodes[Node.BOTTOM_LEFT].getAllContent())),item.x+item.width>this.nodes[Node.TOP_RIGHT]._bounds.x&&(item.y<=this.nodes[Node.BOTTOM_RIGHT]._bounds.y&&out.push.apply(out,this.nodes[Node.TOP_RIGHT].getAllContent()),item.y+item.height>this.nodes[Node.BOTTOM_RIGHT]._bounds.y&&out.push.apply(out,this.nodes[Node.BOTTOM_RIGHT].getAllContent())))}return out.push.apply(out,this._stuckChildren),out.push.apply(out,this.children),out},BoundsNode.prototype.getAllContent=function(){var out=this._out;if(this.nodes.length){var i;for(i=0;i<this.nodes.length;i++)this.nodes[i].getAllContent()}return out.push.apply(out,this._stuckChildren),out.push.apply(out,this.children),out},BoundsNode.prototype.clear=function(){this._stuckChildren.length=0,this.children.length=0;var len=this.nodes.length;if(len){var i;for(i=0;i<len;i++)this.nodes[i].clear();this.nodes.length=0}},window.QuadTree=QuadTree}(window),Voronoi.prototype.reset=function(){if(this.beachline||(this.beachline=new this.RBTree),this.beachline.root)for(var beachsection=this.beachline.getFirst(this.beachline.root);beachsection;)this.beachsectionJunkyard.push(beachsection),beachsection=beachsection.rbNext;this.beachline.root=null,this.circleEvents||(this.circleEvents=new this.RBTree),this.circleEvents.root=this.firstCircleEvent=null,this.vertices=[],this.edges=[],this.cells=[]},Voronoi.prototype.sqrt=Math.sqrt,Voronoi.prototype.abs=Math.abs,Voronoi.prototype.EPSILON=1e-9,Voronoi.prototype.equalWithEpsilon=function(a,b){return this.abs(a-b)<1e-9},Voronoi.prototype.greaterThanWithEpsilon=function(a,b){return a-b>1e-9},Voronoi.prototype.greaterThanOrEqualWithEpsilon=function(a,b){return b-a<1e-9},Voronoi.prototype.lessThanWithEpsilon=function(a,b){return b-a>1e-9},Voronoi.prototype.lessThanOrEqualWithEpsilon=function(a,b){return a-b<1e-9},Voronoi.prototype.RBTree=function(){this.root=null},Voronoi.prototype.RBTree.prototype.rbInsertSuccessor=function(node,successor){var parent;if(node){if(successor.rbPrevious=node,successor.rbNext=node.rbNext,node.rbNext&&(node.rbNext.rbPrevious=successor),node.rbNext=successor,node.rbRight){for(node=node.rbRight;node.rbLeft;)node=node.rbLeft;node.rbLeft=successor}else node.rbRight=successor;parent=node}else this.root?(node=this.getFirst(this.root),successor.rbPrevious=null,successor.rbNext=node,node.rbPrevious=successor,node.rbLeft=successor,parent=node):(successor.rbPrevious=successor.rbNext=null,this.root=successor,parent=null);successor.rbLeft=successor.rbRight=null,successor.rbParent=parent,successor.rbRed=!0;var grandpa,uncle;for(node=successor;parent&&parent.rbRed;)grandpa=parent.rbParent,parent===grandpa.rbLeft?(uncle=grandpa.rbRight,uncle&&uncle.rbRed?(parent.rbRed=uncle.rbRed=!1,grandpa.rbRed=!0,node=grandpa):(node===parent.rbRight&&(this.rbRotateLeft(parent),node=parent,parent=node.rbParent),parent.rbRed=!1,grandpa.rbRed=!0,this.rbRotateRight(grandpa))):(uncle=grandpa.rbLeft,uncle&&uncle.rbRed?(parent.rbRed=uncle.rbRed=!1,grandpa.rbRed=!0,node=grandpa):(node===parent.rbLeft&&(this.rbRotateRight(parent),node=parent,parent=node.rbParent),parent.rbRed=!1,grandpa.rbRed=!0,this.rbRotateLeft(grandpa))),parent=node.rbParent;this.root.rbRed=!1},Voronoi.prototype.RBTree.prototype.rbRemoveNode=function(node){node.rbNext&&(node.rbNext.rbPrevious=node.rbPrevious),node.rbPrevious&&(node.rbPrevious.rbNext=node.rbNext),node.rbNext=node.rbPrevious=null;var next,parent=node.rbParent,left=node.rbLeft,right=node.rbRight;next=left?right?this.getFirst(right):left:right,parent?parent.rbLeft===node?parent.rbLeft=next:parent.rbRight=next:this.root=next;var isRed;if(left&&right?(isRed=next.rbRed,next.rbRed=node.rbRed,next.rbLeft=left,left.rbParent=next,next!==right?(parent=next.rbParent,next.rbParent=node.rbParent,node=next.rbRight,parent.rbLeft=node,next.rbRight=right,right.rbParent=next):(next.rbParent=parent,parent=next,node=next.rbRight)):(isRed=node.rbRed,node=next),node&&(node.rbParent=parent),!isRed){if(node&&node.rbRed)return void(node.rbRed=!1);var sibling;do{if(node===this.root)break;if(node===parent.rbLeft){if(sibling=parent.rbRight,sibling.rbRed&&(sibling.rbRed=!1,parent.rbRed=!0,this.rbRotateLeft(parent),sibling=parent.rbRight),sibling.rbLeft&&sibling.rbLeft.rbRed||sibling.rbRight&&sibling.rbRight.rbRed){sibling.rbRight&&sibling.rbRight.rbRed||(sibling.rbLeft.rbRed=!1,sibling.rbRed=!0,this.rbRotateRight(sibling),sibling=parent.rbRight),sibling.rbRed=parent.rbRed,parent.rbRed=sibling.rbRight.rbRed=!1,this.rbRotateLeft(parent),node=this.root;break}}else if(sibling=parent.rbLeft,sibling.rbRed&&(sibling.rbRed=!1,parent.rbRed=!0,this.rbRotateRight(parent),sibling=parent.rbLeft),sibling.rbLeft&&sibling.rbLeft.rbRed||sibling.rbRight&&sibling.rbRight.rbRed){sibling.rbLeft&&sibling.rbLeft.rbRed||(sibling.rbRight.rbRed=!1,sibling.rbRed=!0,this.rbRotateLeft(sibling),sibling=parent.rbLeft),sibling.rbRed=parent.rbRed,parent.rbRed=sibling.rbLeft.rbRed=!1,this.rbRotateRight(parent),node=this.root;break}sibling.rbRed=!0,node=parent,parent=parent.rbParent}while(!node.rbRed);node&&(node.rbRed=!1)}},Voronoi.prototype.RBTree.prototype.rbRotateLeft=function(node){var p=node,q=node.rbRight,parent=p.rbParent;parent?parent.rbLeft===p?parent.rbLeft=q:parent.rbRight=q:this.root=q,q.rbParent=parent,p.rbParent=q,p.rbRight=q.rbLeft,p.rbRight&&(p.rbRight.rbParent=p),q.rbLeft=p},Voronoi.prototype.RBTree.prototype.rbRotateRight=function(node){var p=node,q=node.rbLeft,parent=p.rbParent;parent?parent.rbLeft===p?parent.rbLeft=q:parent.rbRight=q:this.root=q,q.rbParent=parent,p.rbParent=q,p.rbLeft=q.rbRight,p.rbLeft&&(p.rbLeft.rbParent=p),q.rbRight=p},Voronoi.prototype.RBTree.prototype.getFirst=function(node){for(;node.rbLeft;)node=node.rbLeft;return node},Voronoi.prototype.RBTree.prototype.getLast=function(node){for(;node.rbRight;)node=node.rbRight;return node},Voronoi.prototype.Diagram=function(site){this.site=site},Voronoi.prototype.Cell=function(site){this.site=site,this.halfedges=[],this.closeMe=!1},Voronoi.prototype.Cell.prototype.init=function(site){return this.site=site,this.halfedges=[],this.closeMe=!1,this},Voronoi.prototype.createCell=function(site){var cell=this.cellJunkyard.pop();return cell?cell.init(site):new this.Cell(site)},Voronoi.prototype.Cell.prototype.prepareHalfedges=function(){for(var edge,halfedges=this.halfedges,iHalfedge=halfedges.length;iHalfedge--;)edge=halfedges[iHalfedge].edge,edge.vb&&edge.va||halfedges.splice(iHalfedge,1);return halfedges.sort(function(a,b){return b.angle-a.angle}),halfedges.length},Voronoi.prototype.Cell.prototype.getNeighborIds=function(){for(var edge,neighbors=[],iHalfedge=this.halfedges.length;iHalfedge--;)edge=this.halfedges[iHalfedge].edge,null!==edge.lSite&&edge.lSite.voronoiId!=this.site.voronoiId?neighbors.push(edge.lSite.voronoiId):null!==edge.rSite&&edge.rSite.voronoiId!=this.site.voronoiId&&neighbors.push(edge.rSite.voronoiId);return neighbors},Voronoi.prototype.Cell.prototype.getBbox=function(){for(var v,vx,vy,halfedges=this.halfedges,iHalfedge=halfedges.length,xmin=1/0,ymin=1/0,xmax=-(1/0),ymax=-(1/0);iHalfedge--;)v=halfedges[iHalfedge].getStartpoint(),vx=v.x,vy=v.y,vx<xmin&&(xmin=vx),vy<ymin&&(ymin=vy),vx>xmax&&(xmax=vx),vy>ymax&&(ymax=vy);return{x:xmin,y:ymin,width:xmax-xmin,height:ymax-ymin}},Voronoi.prototype.Cell.prototype.pointIntersection=function(x,y){for(var halfedge,p0,p1,r,halfedges=this.halfedges,iHalfedge=halfedges.length;iHalfedge--;){if(halfedge=halfedges[iHalfedge],p0=halfedge.getStartpoint(),p1=halfedge.getEndpoint(),r=(y-p0.y)*(p1.x-p0.x)-(x-p0.x)*(p1.y-p0.y),!r)return 0;if(r>0)return-1}return 1},Voronoi.prototype.Vertex=function(x,y){this.x=x,this.y=y},Voronoi.prototype.Edge=function(lSite,rSite){this.lSite=lSite,this.rSite=rSite,this.va=this.vb=null},Voronoi.prototype.Halfedge=function(edge,lSite,rSite){if(this.site=lSite,this.edge=edge,rSite)this.angle=Math.atan2(rSite.y-lSite.y,rSite.x-lSite.x);else{var va=edge.va,vb=edge.vb;this.angle=edge.lSite===lSite?Math.atan2(vb.x-va.x,va.y-vb.y):Math.atan2(va.x-vb.x,vb.y-va.y)}},Voronoi.prototype.createHalfedge=function(edge,lSite,rSite){return new this.Halfedge(edge,lSite,rSite)},Voronoi.prototype.Halfedge.prototype.getStartpoint=function(){return this.edge.lSite===this.site?this.edge.va:this.edge.vb},Voronoi.prototype.Halfedge.prototype.getEndpoint=function(){return this.edge.lSite===this.site?this.edge.vb:this.edge.va},Voronoi.prototype.createVertex=function(x,y){var v=this.vertexJunkyard.pop();return v?(v.x=x,v.y=y):v=new this.Vertex(x,y),this.vertices.push(v),v},Voronoi.prototype.createEdge=function(lSite,rSite,va,vb){var edge=this.edgeJunkyard.pop();return edge?(edge.lSite=lSite,edge.rSite=rSite,edge.va=edge.vb=null):edge=new this.Edge(lSite,rSite),this.edges.push(edge),va&&this.setEdgeStartpoint(edge,lSite,rSite,va),vb&&this.setEdgeEndpoint(edge,lSite,rSite,vb),this.cells[lSite.voronoiId].halfedges.push(this.createHalfedge(edge,lSite,rSite)),this.cells[rSite.voronoiId].halfedges.push(this.createHalfedge(edge,rSite,lSite)),edge},Voronoi.prototype.createBorderEdge=function(lSite,va,vb){var edge=this.edgeJunkyard.pop();return edge?(edge.lSite=lSite,edge.rSite=null):edge=new this.Edge(lSite,null),edge.va=va,edge.vb=vb,this.edges.push(edge),edge},Voronoi.prototype.setEdgeStartpoint=function(edge,lSite,rSite,vertex){edge.va||edge.vb?edge.lSite===rSite?edge.vb=vertex:edge.va=vertex:(edge.va=vertex,edge.lSite=lSite,edge.rSite=rSite)},Voronoi.prototype.setEdgeEndpoint=function(edge,lSite,rSite,vertex){this.setEdgeStartpoint(edge,rSite,lSite,vertex)},Voronoi.prototype.Beachsection=function(){},Voronoi.prototype.createBeachsection=function(site){var beachsection=this.beachsectionJunkyard.pop();return beachsection||(beachsection=new this.Beachsection),beachsection.site=site,beachsection},Voronoi.prototype.leftBreakPoint=function(arc,directrix){var site=arc.site,rfocx=site.x,rfocy=site.y,pby2=rfocy-directrix;if(!pby2)return rfocx;var lArc=arc.rbPrevious;if(!lArc)return-(1/0);site=lArc.site;var lfocx=site.x,lfocy=site.y,plby2=lfocy-directrix;if(!plby2)return lfocx;var hl=lfocx-rfocx,aby2=1/pby2-1/plby2,b=hl/plby2;return aby2?(-b+this.sqrt(b*b-2*aby2*(hl*hl/(-2*plby2)-lfocy+plby2/2+rfocy-pby2/2)))/aby2+rfocx:(rfocx+lfocx)/2},Voronoi.prototype.rightBreakPoint=function(arc,directrix){var rArc=arc.rbNext;if(rArc)return this.leftBreakPoint(rArc,directrix);var site=arc.site;return site.y===directrix?site.x:1/0},Voronoi.prototype.detachBeachsection=function(beachsection){this.detachCircleEvent(beachsection),this.beachline.rbRemoveNode(beachsection),this.beachsectionJunkyard.push(beachsection)},Voronoi.prototype.removeBeachsection=function(beachsection){var circle=beachsection.circleEvent,x=circle.x,y=circle.ycenter,vertex=this.createVertex(x,y),previous=beachsection.rbPrevious,next=beachsection.rbNext,disappearingTransitions=[beachsection],abs_fn=Math.abs;this.detachBeachsection(beachsection);for(var lArc=previous;lArc.circleEvent&&abs_fn(x-lArc.circleEvent.x)<1e-9&&abs_fn(y-lArc.circleEvent.ycenter)<1e-9;)previous=lArc.rbPrevious,disappearingTransitions.unshift(lArc),this.detachBeachsection(lArc),lArc=previous;disappearingTransitions.unshift(lArc),this.detachCircleEvent(lArc);for(var rArc=next;rArc.circleEvent&&abs_fn(x-rArc.circleEvent.x)<1e-9&&abs_fn(y-rArc.circleEvent.ycenter)<1e-9;)next=rArc.rbNext,disappearingTransitions.push(rArc),this.detachBeachsection(rArc),rArc=next;disappearingTransitions.push(rArc),this.detachCircleEvent(rArc);var iArc,nArcs=disappearingTransitions.length;for(iArc=1;iArc<nArcs;iArc++)rArc=disappearingTransitions[iArc],lArc=disappearingTransitions[iArc-1],this.setEdgeStartpoint(rArc.edge,lArc.site,rArc.site,vertex);lArc=disappearingTransitions[0],rArc=disappearingTransitions[nArcs-1],rArc.edge=this.createEdge(lArc.site,rArc.site,void 0,vertex),this.attachCircleEvent(lArc),this.attachCircleEvent(rArc)},Voronoi.prototype.addBeachsection=function(site){for(var lArc,rArc,dxl,dxr,x=site.x,directrix=site.y,node=this.beachline.root;node;)if(dxl=this.leftBreakPoint(node,directrix)-x,dxl>1e-9)node=node.rbLeft;else{if(dxr=x-this.rightBreakPoint(node,directrix),!(dxr>1e-9)){dxl>-1e-9?(lArc=node.rbPrevious,rArc=node):dxr>-1e-9?(lArc=node,rArc=node.rbNext):lArc=rArc=node;break}if(!node.rbRight){lArc=node;break}node=node.rbRight}var newArc=this.createBeachsection(site);if(this.beachline.rbInsertSuccessor(lArc,newArc),lArc||rArc){if(lArc===rArc)return this.detachCircleEvent(lArc),rArc=this.createBeachsection(lArc.site),this.beachline.rbInsertSuccessor(newArc,rArc),newArc.edge=rArc.edge=this.createEdge(lArc.site,newArc.site),this.attachCircleEvent(lArc),void this.attachCircleEvent(rArc);if(lArc&&!rArc)return void(newArc.edge=this.createEdge(lArc.site,newArc.site));if(lArc!==rArc){this.detachCircleEvent(lArc),this.detachCircleEvent(rArc);var lSite=lArc.site,ax=lSite.x,ay=lSite.y,bx=site.x-ax,by=site.y-ay,rSite=rArc.site,cx=rSite.x-ax,cy=rSite.y-ay,d=2*(bx*cy-by*cx),hb=bx*bx+by*by,hc=cx*cx+cy*cy,vertex=this.createVertex((cy*hb-by*hc)/d+ax,(bx*hc-cx*hb)/d+ay);return this.setEdgeStartpoint(rArc.edge,lSite,rSite,vertex),newArc.edge=this.createEdge(lSite,site,void 0,vertex),rArc.edge=this.createEdge(site,rSite,void 0,vertex),this.attachCircleEvent(lArc),void this.attachCircleEvent(rArc)}}},Voronoi.prototype.CircleEvent=function(){this.arc=null,this.rbLeft=null,this.rbNext=null,this.rbParent=null,this.rbPrevious=null,this.rbRed=!1,this.rbRight=null,this.site=null,this.x=this.y=this.ycenter=0},Voronoi.prototype.attachCircleEvent=function(arc){var lArc=arc.rbPrevious,rArc=arc.rbNext;if(lArc&&rArc){var lSite=lArc.site,cSite=arc.site,rSite=rArc.site;if(lSite!==rSite){var bx=cSite.x,by=cSite.y,ax=lSite.x-bx,ay=lSite.y-by,cx=rSite.x-bx,cy=rSite.y-by,d=2*(ax*cy-ay*cx);if(!(d>=-2e-12)){var ha=ax*ax+ay*ay,hc=cx*cx+cy*cy,x=(cy*ha-ay*hc)/d,y=(ax*hc-cx*ha)/d,ycenter=y+by,circleEvent=this.circleEventJunkyard.pop();circleEvent||(circleEvent=new this.CircleEvent),circleEvent.arc=arc,circleEvent.site=cSite,circleEvent.x=x+bx,circleEvent.y=ycenter+this.sqrt(x*x+y*y),circleEvent.ycenter=ycenter,arc.circleEvent=circleEvent;for(var predecessor=null,node=this.circleEvents.root;node;)if(circleEvent.y<node.y||circleEvent.y===node.y&&circleEvent.x<=node.x){if(!node.rbLeft){predecessor=node.rbPrevious;break}node=node.rbLeft}else{if(!node.rbRight){predecessor=node;break}node=node.rbRight}this.circleEvents.rbInsertSuccessor(predecessor,circleEvent),predecessor||(this.firstCircleEvent=circleEvent)}}}},Voronoi.prototype.detachCircleEvent=function(arc){var circleEvent=arc.circleEvent;circleEvent&&(circleEvent.rbPrevious||(this.firstCircleEvent=circleEvent.rbNext),this.circleEvents.rbRemoveNode(circleEvent),this.circleEventJunkyard.push(circleEvent),arc.circleEvent=null)},Voronoi.prototype.connectEdge=function(edge,bbox){var vb=edge.vb;if(vb)return!0;var fm,fb,va=edge.va,xl=bbox.xl,xr=bbox.xr,yt=bbox.yt,yb=bbox.yb,lSite=edge.lSite,rSite=edge.rSite,lx=lSite.x,ly=lSite.y,rx=rSite.x,ry=rSite.y,fx=(lx+rx)/2,fy=(ly+ry)/2;if(this.cells[lSite.voronoiId].closeMe=!0,this.cells[rSite.voronoiId].closeMe=!0,ry!==ly&&(fm=(lx-rx)/(ry-ly),fb=fy-fm*fx),void 0===fm){if(fx<xl||fx>=xr)return!1;if(lx>rx){if(va){if(va.y>=yb)return!1}else va=this.createVertex(fx,yt);vb=this.createVertex(fx,yb)}else{if(va){if(va.y<yt)return!1}else va=this.createVertex(fx,yb);vb=this.createVertex(fx,yt)}}else if(fm<-1||fm>1)if(lx>rx){if(va){if(va.y>=yb)return!1}else va=this.createVertex((yt-fb)/fm,yt);vb=this.createVertex((yb-fb)/fm,yb)}else{if(va){if(va.y<yt)return!1}else va=this.createVertex((yb-fb)/fm,yb);vb=this.createVertex((yt-fb)/fm,yt)}else if(ly<ry){if(va){if(va.x>=xr)return!1}else va=this.createVertex(xl,fm*xl+fb);vb=this.createVertex(xr,fm*xr+fb)}else{if(va){if(va.x<xl)return!1}else va=this.createVertex(xr,fm*xr+fb);vb=this.createVertex(xl,fm*xl+fb)}return edge.va=va,edge.vb=vb,!0},Voronoi.prototype.clipEdge=function(edge,bbox){var ax=edge.va.x,ay=edge.va.y,bx=edge.vb.x,by=edge.vb.y,t0=0,t1=1,dx=bx-ax,dy=by-ay,q=ax-bbox.xl;if(0===dx&&q<0)return!1;var r=-q/dx;if(dx<0){if(r<t0)return!1;r<t1&&(t1=r)}else if(dx>0){if(r>t1)return!1;r>t0&&(t0=r)}if(q=bbox.xr-ax,0===dx&&q<0)return!1;if(r=q/dx,dx<0){if(r>t1)return!1;r>t0&&(t0=r)}else if(dx>0){if(r<t0)return!1;r<t1&&(t1=r)}if(q=ay-bbox.yt,0===dy&&q<0)return!1;if(r=-q/dy,dy<0){if(r<t0)return!1;r<t1&&(t1=r)}else if(dy>0){if(r>t1)return!1;r>t0&&(t0=r)}if(q=bbox.yb-ay,0===dy&&q<0)return!1;if(r=q/dy,dy<0){if(r>t1)return!1;r>t0&&(t0=r)}else if(dy>0){if(r<t0)return!1;r<t1&&(t1=r)}return t0>0&&(edge.va=this.createVertex(ax+t0*dx,ay+t0*dy)),t1<1&&(edge.vb=this.createVertex(ax+t1*dx,ay+t1*dy)),(t0>0||t1<1)&&(this.cells[edge.lSite.voronoiId].closeMe=!0,this.cells[edge.rSite.voronoiId].closeMe=!0),!0},Voronoi.prototype.clipEdges=function(bbox){for(var edge,edges=this.edges,iEdge=edges.length,abs_fn=Math.abs;iEdge--;)edge=edges[iEdge],(!this.connectEdge(edge,bbox)||!this.clipEdge(edge,bbox)||abs_fn(edge.va.x-edge.vb.x)<1e-9&&abs_fn(edge.va.y-edge.vb.y)<1e-9)&&(edge.va=edge.vb=null,edges.splice(iEdge,1))},Voronoi.prototype.closeCells=function(bbox){for(var cell,iLeft,halfedges,nHalfedges,edge,va,vb,vz,lastBorderSegment,xl=bbox.xl,xr=bbox.xr,yt=bbox.yt,yb=bbox.yb,cells=this.cells,iCell=cells.length,abs_fn=Math.abs;iCell--;)if(cell=cells[iCell],cell.prepareHalfedges()&&cell.closeMe){for(halfedges=cell.halfedges,nHalfedges=halfedges.length,iLeft=0;iLeft<nHalfedges&&(va=halfedges[iLeft].getEndpoint(),vz=halfedges[(iLeft+1)%nHalfedges].getStartpoint(),!(abs_fn(va.x-vz.x)>=1e-9||abs_fn(va.y-vz.y)>=1e-9));)iLeft++;if(iLeft!==nHalfedges){switch(!0){case this.equalWithEpsilon(va.x,xl)&&this.lessThanWithEpsilon(va.y,yb):if(lastBorderSegment=this.equalWithEpsilon(vz.x,xl),vb=this.createVertex(xl,lastBorderSegment?vz.y:yb),edge=this.createBorderEdge(cell.site,va,vb),iLeft++,halfedges.splice(iLeft,0,this.createHalfedge(edge,cell.site,null)),lastBorderSegment)break;va=vb;case this.equalWithEpsilon(va.y,yb)&&this.lessThanWithEpsilon(va.x,xr):if(lastBorderSegment=this.equalWithEpsilon(vz.y,yb),vb=this.createVertex(lastBorderSegment?vz.x:xr,yb),edge=this.createBorderEdge(cell.site,va,vb),iLeft++,halfedges.splice(iLeft,0,this.createHalfedge(edge,cell.site,null)),lastBorderSegment)break;va=vb;case this.equalWithEpsilon(va.x,xr)&&this.greaterThanWithEpsilon(va.y,yt):if(lastBorderSegment=this.equalWithEpsilon(vz.x,xr),vb=this.createVertex(xr,lastBorderSegment?vz.y:yt),edge=this.createBorderEdge(cell.site,va,vb),iLeft++,halfedges.splice(iLeft,0,this.createHalfedge(edge,cell.site,null)),lastBorderSegment)break;va=vb;case this.equalWithEpsilon(va.y,yt)&&this.greaterThanWithEpsilon(va.x,xl):if(lastBorderSegment=this.equalWithEpsilon(vz.y,yt),vb=this.createVertex(lastBorderSegment?vz.x:xl,yt),edge=this.createBorderEdge(cell.site,va,vb),iLeft++,halfedges.splice(iLeft,0,this.createHalfedge(edge,cell.site,null)),lastBorderSegment)break;if(va=vb,lastBorderSegment=this.equalWithEpsilon(vz.x,xl),vb=this.createVertex(xl,lastBorderSegment?vz.y:yb),edge=this.createBorderEdge(cell.site,va,vb),iLeft++,halfedges.splice(iLeft,0,this.createHalfedge(edge,cell.site,null)),lastBorderSegment)break;if(va=vb,lastBorderSegment=this.equalWithEpsilon(vz.y,yb),vb=this.createVertex(lastBorderSegment?vz.x:xr,yb),edge=this.createBorderEdge(cell.site,va,vb),iLeft++,halfedges.splice(iLeft,0,this.createHalfedge(edge,cell.site,null)),lastBorderSegment)break;va=vb,lastBorderSegment=this.equalWithEpsilon(vz.x,xr),vb=this.createVertex(xr,lastBorderSegment?vz.y:yt),edge=this.createBorderEdge(cell.site,va,vb),iLeft++,halfedges.splice(iLeft,0,this.createHalfedge(edge,cell.site,null));break;default:throw"Voronoi.closeCells() > this makes no sense!"}if(abs_fn(vb.x-vz.x)>=1e-9||abs_fn(vb.y-vz.y)>=1e-9)throw"Voronoi.closeCells() > Could not close the Voronoi cell!\n  (See https://github.com/gorhill/Javascript-Voronoi/issues/15)"}}},Voronoi.prototype.quantizeSites=function(sites){for(var site,Îµ=this.EPSILON,n=sites.length;n--;)site=sites[n],site.x=Math.floor(site.x/Îµ)*Îµ,site.y=Math.floor(site.y/Îµ)*Îµ},Voronoi.prototype.recycle=function(diagram){if(diagram){if(!(diagram instanceof this.Diagram))throw"Voronoi.recycleDiagram() > Need a Diagram object.";this.toRecycle=diagram}},Voronoi.prototype.compute=function(sites,bbox){var startTime=new Date;this.reset(),this.toRecycle&&(this.vertexJunkyard=this.vertexJunkyard.concat(this.toRecycle.vertices),this.edgeJunkyard=this.edgeJunkyard.concat(this.toRecycle.edges),this.cellJunkyard=this.cellJunkyard.concat(this.toRecycle.cells),this.toRecycle=null);var siteEvents=sites.slice(0);siteEvents.sort(function(a,b){var r=b.y-a.y;return r?r:b.x-a.x});for(var xsitex,xsitey,circle,site=siteEvents.pop(),siteid=0,cells=this.cells;;)if(circle=this.firstCircleEvent,site&&(!circle||site.y<circle.y||site.y===circle.y&&site.x<circle.x))site.x===xsitex&&site.y===xsitey||(cells[siteid]=this.createCell(site),site.voronoiId=siteid++,this.addBeachsection(site),xsitey=site.y,xsitex=site.x),site=siteEvents.pop();else{if(!circle)break;this.removeBeachsection(circle.arc)}this.clipEdges(bbox),this.closeCells(bbox);var stopTime=new Date,diagram=new this.Diagram;return diagram.cells=this.cells,diagram.edges=this.edges,diagram.vertices=this.vertices,diagram.execTime=stopTime.getTime()-startTime.getTime(),this.reset(),diagram};var app=angular.module("conkr",["ngSanitize"]).controller("chatController",function($scope,mapFact,miscFact){$scope.prevSent=[],$scope.msgs=[{now:(new Date).toLocaleTimeString(),usr:"system",msg:'Welcome to Conkr! chat. "/inv": toggle color modes, "/time": toggle timestamp, "/l": switch to local chat (only works if you\'re in a game!), "/a": switch to all chat',local:!1}],$scope.user=null,$scope.msgInp="",miscFact.getUsr().then(function(r){if(!r.data||!r.data.name)throw new Error("User not found or not logged in!");$scope.user=r.data.name}),socket.on("newMsg",function(msg){msg.now=(new Date).toLocaleTimeString(),$scope.msgs.length>8&&$scope.msgs.shift(),$scope.msgs.push(msg),console.log($scope.msgs),$scope.$digest(),$(".chat-cont").scrollTop(parseInt($(".chat-cont").height()))}),$scope.sendMsg=function(){if("/time"==$scope.msgInp)$scope.timeStamp=!$scope.timeStamp;else if("/inv"==$scope.msgInp)$scope.invCol=!$scope.invCol;else if("/l"==$scope.msgInp&&$scope.$parent.gameId)$scope.chatLocal=!0;else if("/l"!=$scope.msgInp||$scope.$parent.gameId)if("/a"==$scope.msgInp)$scope.chatLocal=!1;else{if(""===$scope.msgInp)return!1;socket.emit("sendMsg",{msg:$scope.msgInp,usr:$scope.user,local:!!$scope.$parent.gameId})}else;$scope.prevSent.push($scope.msgInp),$scope.currPrevMsg=$scope.prevSent.length,$scope.msgInp="",$("#msgInp").focus()},document.querySelector("#msgInp").addEventListener("keyup",function(e){38==e.which?(e.preventDefault(),$scope.prevSent.length&&$scope.currPrevMsg>0&&($scope.currPrevMsg--,$scope.msgInp=$scope.prevSent[$scope.currPrevMsg]),$scope.$digest()):40==e.which?(e.preventDefault(),$scope.prevSent.length&&$scope.currPrevMsg<$scope.prevSent.length-1&&($scope.currPrevMsg++,$scope.msgInp=$scope.prevSent[$scope.currPrevMsg]),$scope.$digest()):27==e.which&&(e.preventDefault(),$scope.currPrevMsg=$scope.prevSent.length,$scope.msgInp="",$scope.$digest())}),$scope.switchTabs=function(dir){console.log($scope.$parent.gameId),$scope.chatLocal=!!$scope.$parent.gameId&&parseInt(dir)}});app.controller("loginCont",function($scope,miscFact,$timeout){$scope.logMode=!0,$scope.pwdStren=0,hintMaker(0),$scope.passGud={len:0,caps:!1,lower:!1,num:!1,symb:!1,badWrd:!1,sameUn:!1},$scope.dupUn=!1,$scope.checkDupUn=function(){return!!$scope.regUser&&void miscFact.checkUnDup($scope.regUser).then(function(r){$scope.dupUn="bad"==r.data})},$scope.getAbtHeight=function(){$timeout(function(){document.querySelector(".abt-bg").style.height=$("#abt-stuff").height()/.9+"px"},0,!1)},$scope.showAbt=!1,$scope.getPwdStren=function(){var str=0,pwd=$scope.regPwdOne,badWrds=["password","pass","123","abc","admin"];$scope.passGud={len:0,caps:!1,lower:!1,num:!1,symb:!1,badWrd:!1,sameUn:!1
},pwd.length>16?(str+=8,$scope.passGud.len=16):pwd.length>12?(str+=6,$scope.passGud.len=12):pwd.length>8?(str+=4,$scope.passGud.len=8):pwd.length>4?(str+=2,$scope.passGud.len=4):$scope.passGud.len=!1,pwd.match(/[A-Z]/)&&(str+=1,$scope.passGud.caps=!0),pwd.match(/[a-z]/)&&(str+=1,$scope.passGud.lower=!0),pwd.match(/[0-9]/)&&(str+=1,$scope.passGud.num=!0),pwd.match(/!|@|#|\$|%|\/|\\|\^|&|\*|-|_/)&&(str+=1,$scope.passGud.symb=!0),badWrds.forEach(function(w){str>1&&pwd.indexOf(w)>-1&&(str-=2,$scope.passGud.badWrd=!0)}),$scope.regUser==pwd&&str>2&&(str-=3,$scope.passGud.sameUn=!0),$scope.pwdStren=str},$scope.explPwd=function(){sandalchest.alert("Password Strength","Password Criteria:<ul class='pwd-list'><li><span id='pwd-len-btn' style='background:hsl("+120*$scope.passGud.len/16+",100%,40%);'></span> "+($scope.passGud.len?"At least "+$scope.passGud.len:"Less than 4")+" characters</li><li>"+($scope.passGud.caps?"&#10003;":"&#10007;")+" Contains a capital letter</li><li>"+($scope.passGud.lower?"&#10003;":"&#10007;")+" Contains a lowercase letter</li><li>"+($scope.passGud.num?"&#10003;":"&#10007;")+" Contains a number</li><li>"+($scope.passGud.symb?"&#10003;":"&#10007;")+" Contains a non-alphanumeric symbol (i.e., '@', or '#')</li><li>"+($scope.passGud.badWrd?"&#10007;":"&#10003;")+" Does <i>not</i> contain any common sequences, like 'abc' or '123' or 'password'.</li><li>"+($scope.passGud.sameUn?"&#10007;":"&#10003;")+" Is <i>not</i> the same as your username.</li></ul>")},$scope.newUsr=function(){miscFact.regNewUsr($scope.regUser,$scope.regPwdOne).then(function(r){"DUPLICATE"==r.data?sandalchest.alert("Registration Error","Uh oh! Something went horribly wrong!"):miscFact.login($scope.regUser,$scope.regPwdOne).then(function(d){"no"==d.data?sandalchest.alert("Registration Error","There was an error while checking your username/password. Please try again.",{speed:250}):sandalchest.alert("Registration Successful","Welcome!",function(p){window.location.assign("../")},{speed:250})})})},$scope.log=function(){miscFact.login($scope.logUsr,$scope.logPwd).then(function(d){"no"==d.data?sandalchest.alert("Login error","Please check your username and/or password<hr/><i>Note:</i> While Conkr is under development, data may be deleted at any time!",{speed:250}):localStorage.conkrNoWelcome?window.location.assign("../"):sandalchest.alert("Login Successful",'Welcome back!<br/><br/><small><input type="checkbox" id="noWelcome"/> Don&rsquo;t show this again</small>',function(p){document.querySelector("#noWelcome").checked&&(localStorage.conkrNoWelcome=!0),window.location.assign("../")},{speed:250})})}});var socket=io(),socketRoom=null;app.controller("conkrcon",function($scope,$http,fightFact,mapFact,miscFact,$sce){$scope.isDead=!1,miscFact.chkLoggedStatus().then(function(r){console.log("DATA",r.data),r.data.result||window.location.assign("./login"),$scope.user=r.data.name,hintMaker(1,function(){miscFact.checkInGame(r.data.name).then(function(m){m.data.game?($scope.reloadGame(m.data.game),$scope.gameSettingsPanel=2,$scope.isDead=!m.data.alive,$scope.canJoin=!1):hintMaker(2)})})}),$scope.btns=!0,$scope.allGames=[],$scope.usrGames=function(){return $scope.allGames.filter(function(g){return g.creator==$scope.user})},$scope.win={w:.95*$(window).width(),h:.95*$(window).height()},$scope.reloadGame=function(g){$scope.currGamePlayers={},g.players.forEach(function(p,i){$scope.currGamePlayers[p]=g.avas[i]}),$scope.gameId=g.gameId,console.log("GAME",g),mapFact.loadOneMap(g.mapId).then(function(m){console.log("result of attempt to get 1 map",m),$scope.pickMap(m.data.mapData,g.mapId,!0),$scope.gameReady=!0,hintMaker(7,function(){hintMaker(8)})})},$scope.logout=function(){miscFact.logout().then(function(){window.location.assign("./login")})},window.onkeyup=function(e){13==e.which&&$scope.showChat?$("#msgInp").focus():191==e.which&&($scope.showChat=!0,$scope.$digest(),$("#msgInp").focus())},$scope.gameMenu=!0,$scope.currGamePlayers={},$scope.gameIsReady=!0,$scope.gameSettingsPanel=0,$scope.newNew=!0,$scope.numCountries=20,$scope.map=null,$scope.gameId=null,$scope.canJoin=!0,$scope.potentialMaps=[],$scope.loadedMapImg=null,$scope.user=null,$scope.pStatShow=!1,$scope.newMap=function(){var smootz=101-$scope.smoothing,numZones=Math.round($scope.numCountries/.3);$scope.map=mapFact.GetVoronoi($scope.win.h,$scope.win.w,numZones,smootz),$scope.map.init(),$scope.gameMenu=!1,sandalchest.confirm("Confirm Map","Do you want to accept this map?",function(r){console.log("R FROM MAP CONFIRM",r),r?$scope.map.save().then(function(sr){console.log("ASKING IF NEW GAME"),sandalchest.dialog("Start Game","Do you want to start a new game with this map ("+sr.data.id+")?<hr/>Password: <input type='password' id='newGamePwd'> <button class='btn btn-danger' onclick=\"angular.element('body').scope().pwdExpl()\" id='start-new-game-btn'>?</button>",{buttons:[{text:"Create Game",close:!0,click:function(){var ngpwd=document.querySelector("#newGamePwd").value;hintMaker(4,function(){fightFact.newGame(sr.data.id,$scope.user,ngpwd).then(function(g){$scope.gameId=g.data.id,socket.emit("getGamePieces",{id:g.data.id}),console.log("Done! Game made!"),$scope.gameSettingsPanel=2,socket.emit("getGames",{x:!0}),hintMaker(5)})})}},{text:"Cancel",close:!0,click:function(){}}],speed:250}),hintMaker(3)}):($scope.map=null,$scope.gameMenu=!0,$scope.$digest())})},$scope.pwdExpl=function(){sandalchest.alert("Protected Games","If you include a password, only players who have that password can join. Leave this blank if you want a public game!",{rotation:-5})},socket.emit("getGames",{x:!0}),$scope.loadMaps=function(){mapFact.loadMaps().then(function(r){console.log("MAPS",r),$scope.potentialMaps=r.data})},socket.on("replaceMap",function(){$scope.loadMaps()}),socket.on("allGames",function(g){$scope.canJoin=!0,g.forEach(function(gi){gi.gameId==$scope.gameId&&($scope.canJoin=!1)}),$scope.canJoin&&($scope.gameId=null),console.log("FROM ALL GAMES",g),$scope.allGames=g,$scope.loadMaps(),$scope.$digest()}),socket.on("deadPlayer",function(p){p.player===$scope.player&&sandalchest.alert("Dead","Sorry, "+$scope.user+", you've died!",function(e){$scope.btns=!1})}),$scope.deleteMap=function(id){sandalchest.confirm("Delete Map","Are you sure you want to delete map "+id+"?",function(n){n&&mapFact.delMap(id).then(function(r){"logErr"==r.data})})},$scope.delGame=function(id){sandalchest.confirm("Delete Game","Are you sure you wanna delete this game? This isn't reversable!",function(delConf){delConf&&fightFact.delGame(id).then(function(r){console.log("back from delGame thing"),"wrongUser"==r.data?sandalchest.alert("Hey! You can't delete that game!"):(console.log("REMOVED GAME! REFRESHING DATA"),socket.emit("getGames",{x:!0}))})})},$scope.pickTarg=!1,$scope.moveArmies=!0;var debugMode=!1;$scope.pickCell=function(ap){if($scope.srcCell&&$scope.map.diagram.cells[$scope.srcCell].country==ap.country&&ap.status>0)return ap.status=0,$scope.srcCell=null,$scope.targCell=null,$scope.pickTarg=!1,!0;if(!$scope.pickTarg&&ap.usr==$scope.user)return $scope.armyPieces.forEach(function(p){p.status=0}),$scope.srcCell=$scope.map.getCellNumByName(ap.country),ap.status=1,$scope.targCell=null,$scope.pickTarg=!0,!0;if($scope.moveArmies)if($scope.pickTarg&&ap.usr==$scope.user){if(!mapFact.isNeighbor($scope.map.diagram.cells,$scope.srcCell,$scope.map.getCellNumByName(ap.country)))return sandalchest.alert("Uh Oh!","Hey! You can't move armies to "+ap.country+" from "+$scope.map.diagram.cells[$scope.srcCell].country+"! It's too far away!",{speed:250}),!1;var srcNum=$scope.getAPByName($scope.map.diagram.cells[$scope.srcCell].country).num;if(srcNum<2)return sandalchest.alert("Uh Oh!","You have too few armies in the source country to move armies (less than two). You cannot desert a country!",{speed:250}),!1;sandalchest.dialog({buttons:[{text:"Move em!",close:!0,click:function(){console.log("wanna move",{num:parseInt(document.querySelector("#reqNumMove").value),usr:$scope.user,src:$scope.getAPByName($scope.map.diagram.cells[$scope.srcCell].country),targ:ap,game:$scope.gameId}),socket.emit("moveArmies",{num:parseInt(document.querySelector("#reqNumMove").value),usr:$scope.user,src:$scope.getAPByName($scope.map.diagram.cells[$scope.srcCell].country),targ:ap,game:$scope.gameId}),$scope.getAPByName($scope.map.diagram.cells[$scope.srcCell].country).status=0,$scope.srcCell=null,$scope.targCell=null,ap.status=0,$scope.pickTarg=!1}},{text:"Cancel",close:!0,click:function(){$scope.getAPByName($scope.map.diagram.cells[$scope.srcCell].country).status=0,$scope.srcCell=null,$scope.targCell=null,ap.status=0,$scope.pickTarg=!1}}],speed:250},"Army Movement","How many armies do you want to move from "+$scope.map.diagram.cells[$scope.srcCell].country+" to "+ap.country+"? You can move a maximum of "+srcNum+" armies. <br/> <input type=\"number\" id=\"reqNumMove\" value='1' min='1' max='"+srcNum+"'>")}else $scope.pickTarg&&ap.usr!=$scope.user&&sandalchest.alert("Uh Oh!",ap.country+" is currently occupied by another player. You'll need to conquer it first to move your armies there!");else if($scope.pickTarg&&(ap.usr!=$scope.user||debugMode)){if(!mapFact.isNeighbor($scope.map.diagram.cells,$scope.srcCell,$scope.map.getCellNumByName(ap.country)))return sandalchest.alert("Uh Oh!","Hey! You can't attack "+ap.country+" from "+$scope.map.diagram.cells[$scope.srcCell].country+"! It's too far away!",{speed:250}),!1;$scope.targCell=$scope.map.getCellNumByName(ap.country),ap.status=2,$scope.pickTarg=!1}else $scope.pickTarg&&ap.usr==$scope.user&&sandalchest.alert("Uh Oh!","Hey! You can't attack yourself at "+ap.country+"!",{speed:250})},$scope.joinGame=function(g,pwd){fightFact.joinGame(g,$scope.user,pwd).then(function(r){return"gameLogErr"==r.data?(sandalchest.alert("Join Error","This game's private, and you've unfortunately entered the wrong password!"),!1):(console.log("JOINED GAME:",r),void socket.emit("getGames",{x:!0}))})},$scope.neighborTest=function(s,d){console.log("tested cells are neighbors: ",mapFact.isNeighbor($scope.map.diagram.cells,s,d))},$scope.switchPlayMode=function(){sandalchest.confirm("Switch Modes","Are you sure you wanna stop moving armies and begin the attack phase?",function(res){res&&null!==res&&($scope.moveArmies=!1,$scope.$digest(),hintMaker(9))})},$scope.checkMenuHint=function(){hintMaker(6)},$scope.pickMap=function(m,n,old){console.log("pikmap data",m,n,old),$scope.map=mapFact.GetVoronoi(m.bbox.yb,m.bbox.xr,m.countryNames.length,20);for(var p in m)$scope.map[p]=m[p];$scope.map.initLoad(m.img),$scope.gameMenu=!1,old?(socket.emit("putInRoom",{id:$scope.gameId}),$scope.armyPieces=[]):(sandalchest.dialog("New Game","Making a new game!<hr/> Password (optional): <input type='password' id='newGamePwd'> <button class='btn btn-danger' onclick=\"angular.element('body').scope().pwdExpl()\">?</button>",{buttons:[{text:"Create Game",close:!0,click:function(){var ngpwd=document.querySelector("#newGamePwd").value;hintMaker(4,function(){fightFact.newGame(n,$scope.user,ngpwd).then(function(g){$scope.gameId=g.data.id,socket.emit("getGamePieces",{id:g.data.id}),console.log("Done! Game made!"),$scope.gameSettingsPanel=2,socket.emit("getGames",{x:!0}),hintMaker(5)})}),$scope.armyPieces=[]}},{text:"Cancel",close:!0,click:function(){}}],speed:250}),hintMaker(3))},socket.on("updateArmies",function(d){console.log("UPDATE ARMIES",d),d.players.forEach(function(p,i){$scope.currGamePlayers[p]=d.avas[i]}),$scope.armyPieces=fightFact.placeArmies($scope.map,d.armies,$scope.currGamePlayers),$scope.$digest()}),socket.on("gameReady",function(d){$scope.gameIsReady=!0,socket.emit("getGamePieces",d),console.log("AT GAMEREADY, D IS",d)}),$scope.toggleNewMode=function(n){$scope.newNew=n>0,$scope.newNew||$scope.loadMaps()},$scope.startGame=function(id){sandalchest.confirm("Start Game "+id,"Are you sure you wanna start game "+id+"? Starting a game is not reversable, and prevents any more players from joining.",function(r){r&&fightFact.startGame(id).then(function(r){socket.emit("gameStarted",r),window.location.reload()})})},socket.on("putInGame",function(c){console.log("PUT IN GAME",c),c.data.players.indexOf($scope.user)>-1&&socket.emit("putInRoom",c.data)}),$scope.avgCounInfo=function(){sandalchest.alert("Country Number","Because of how the map is generated, the actual number of countries may or may not be exactly the number here.")},$scope.smoothInfo=function(){sandalchest.alert("Map Smoothing",'Without smoothing, the shapes generated by the map algorithm (a <a href="https://en.wikipedia.org/wiki/Voronoi_diagram" target="_blank">Voronoi Diagram</a>) are very random. Smoothing \'pushes\' the shapes towards being equal size.')},$scope.doAttack=function(s,d,ra){for(var rd=null,dname=$scope.map.diagram.cells[d].name,i=0;i<$scope.armyPieces.length;i++)if($scope.armyPieces[i].country==dname){rd=$scope.armyPieces[i].num<3?$scope.armyPieces[i].num:2;break}rd>ra&&(ra=rd),mapFact.isNeighbor($scope.map.diagram.cells,s,d)&&fightFact.doFight($scope.user,$scope.getAPByName($scope.map.diagram.cells[s].name),$scope.getAPByName($scope.map.diagram.cells[d].name),ra,rd,$scope.gameId)},$scope.getAPByName=function(name){for(var i=0;i<$scope.armyPieces.length;i++)if($scope.armyPieces[i].country==name)return $scope.armyPieces[i];return!1},$scope.startAttack=function(){if(console.log("SOURCE CELL",$scope.map.diagram.cells[$scope.srcCell]),!$scope.srcCell&&0!==$scope.srcCell||!$scope.targCell&&0!==$scope.targCell)sandalchest.alert("Attack Issue","You need both an attacker and a target!");else if($scope.getAPByName($scope.map.diagram.cells[$scope.srcCell].name)&&$scope.getAPByName($scope.map.diagram.cells[$scope.srcCell].name).num<2)sandalchest.alert("Not Enough Armies","You can't attack from "+$scope.map.diagram.cells[$scope.srcCell].name+"! Attacking countries need at least two armies: One to attack, and one to stay home!");else{var maxPain=$scope.getAPByName($scope.map.diagram.cells[$scope.srcCell].name).num<5?$scope.getAPByName($scope.map.diagram.cells[$scope.srcCell].name).num-1:3;sandalchest.prompt("Army Strength","How many armies do you wanna attack with? You can attack with at most "+maxPain+" armies.",function(res){return res=parseInt(res),!isNaN(res)&&0!==res&&(console.log($scope.map.diagram.cells[$scope.srcCell].name,"attacking",$scope.map.diagram.cells[$scope.targCell].name,"with",res,"armies."),void $scope.doAttack($scope.srcCell,$scope.targCell,res))}),hintMaker(10)}},socket.on("rcvDoFight",function(res){var defr=$scope.getAPByName(res.cd.country),atkr=$scope.getAPByName(res.ca.country),replProps=["usr","lbl","num"];res.status&&(res.cd.usr=res.ca.usr),console.log("from rcvDoFight, we get",defr,atkr),replProps.forEach(function(p){defr[p]=res.cd[p],atkr[p]=res.ca[p]}),$scope.$apply()}),$scope.nextTurn=function(){sandalchest.confirm("End Turn","Are you sure you want to end your turn?",function(res){console.log(res),res&&null!==res&&fightFact.nextTurn($scope.map,$scope.gameId,$scope.user)})}}),app.controller("statCon",function($scope,miscFact){$scope.pStats=[],document.querySelector("#stat-main").onclick=function(e){e.stopPropagation()},$scope.getScores=function(){miscFact.getAllUsers().then(function(r){r=r.sort(function(a,b){return b.totalScore-a.totalScore}),console.log("Users:",r);var currPlace=1,prevScore=r[0].totalScore,currPlayers=[];r.forEach(function(pl){pl.totalScore<prevScore&&($scope.pStats.push({names:currPlayers.join(","),place:currPlace,score:prevScore}),currPlayers=[],currPlace++,prevScore=pl.totalScore),currPlayers.push(pl.name)}),$scope.pStats.push({names:currPlayers.join(", "),place:currPlace,score:prevScore})})},socket.on("newScores",function(r){$scope.getScore()}),$scope.getScores()}),app.factory("fightFact",function($rootScope,$http){var getCellCoords=function(m,c){console.log("Getting cell coords for",c);for(var i=0;i<m.length;i++)if(m[i].name==c)return m[i].site;return!1};return{getMaxArmy:function(c,m){var attackPenalty=m?1:0;return Math.floor(c.army.num-attackPenalty)},delGame:function(id){return $http.get("/game/del/"+id).then(function(r){return console.log("factory back from back end game del"),r})},doFight:function(usr,ca,cd,ra,rd,id){socket.emit("sendDoFight",{user:usr,ca:ca,cd:cd,ra:ra,rd:rd,gameId:id})},nextTurn:function(map,game,usr){socket.emit("nextTurn",{conts:map.getContinents(),game:game,usr:usr})},newGame:function(n,p,pwd){return $http.post("/game/new",{id:n,player:p,pwd:pwd}).then(function(p){return p})},placeArmies:function(m,a,l){for(var pieces=[],n=0;n<a.length;n++){var site=getCellCoords(m.diagram.cells,a[n].country),boxwid=1.2*document.querySelector("canvas").getContext("2d").measureText(a[n].country).width;pieces.push({country:a[n].country,num:a[n].num,lbl:l[a[n].user],usr:a[n].user,x:site.x-boxwid/2-8,y:site.y,fullName:a[n].user+" - "+a[n].country+" - "+a[n].num+(a[n].num>1?" armies":" army"),wid:boxwid,status:0})}return pieces},joinGame:function(m,p,pwd){return $http.post("/game/join",{gameId:m,player:p,pwd:pwd},function(p){return p})},addArmies:function(game){socket.emit("sendAddArmies",{game:game})},saveGame:function(id,map){if(id){var gameData={gameId:id,armies:[],mapId:map.id};return map.diagram.cells.forEach(function(c,i){c.name&&gameData.armies.push({user:c.army.usr,country:c.name,num:c.army.num})}),$http.post("/game/saveGame",gameData)}sandalchest.alert("Map save error: no map id!",function(){return!1})},startGame:function(id){return $http.get("/game/startGame/"+id).then(function(r){return r})}}}),app.factory("mapFact",function($rootScope,$http){String.prototype.capit=function(){return this.slice(0,1).toUpperCase()+this.slice(1)};var countries=[["b","c","d","f","g","h","i","j","k","l","m","n","p","q","r","s","t","v","w","x","y","z","","","","",""],["a","e","i","o","u"],["br","cr","dr","fr","gr","pr","str","tr","bl","cl","fl","gl","pl","sl","sc","sk","sm","sn","sp","st","sw","ch","sh","th","wh"],["ae","ai","ao","au","a","ay","ea","ei","eo","eu","e","ey","ua","ue","ui","uo","u","uy","ia","ie","iu","io","iy","oa","oe","ou","oi","o","oy"],["stan","dor","vania","nia","lor","cor","dal","bar","sal","ra","la","lia","jan","rus","ze","tan","wana","sil","so","na","le","bia","ca","ji","ce","ton","ssau","sau","sia","ca","ya","ye","yae","tho","stein","ria","nia","burg","nia","gro","que","gua","qua","rhiel","cia","les","dan","nga","land"],["ia","a","en","ar","istan","aria","ington","ua","ijan","ain","ium","us","esh","os","ana","il","ad","or","ea","eau","ax","on","ana","ary","ya","ye","yae","ait","ein","urg","al","ines","ela"]],countryPrefs=["Republic of","Kingdom of","Empire of","United Lands of","Dominion of","Holy empire of"];return{loadMaps:function(){return $http.get("/map/loadMaps").then(function(r){return r})},loadOneMap:function(id){return console.log("attempting to get map",id),$http.get("/map/loadMap/"+id).then(function(r){return r})},isBorderNeighbor:function(c,s,d){if(!c[s]||!c[d])throw new Error("cells not found!");console.log("Cells",c,"source cell",c[s],"target",c[d]);for(var i=0;i<c[s].halfedges.length;i++)if(c[s].halfedges[i].edge.lSite&&c[s].halfedges[i].edge.rSite&&(c[s].halfedges[i].edge.lSite.x==c[d].site.x&&c[s].halfedges[i].edge.lSite.y==c[d].site.y||c[s].halfedges[i].edge.rSite.x==c[d].site.x&&c[s].halfedges[i].edge.rSite.y==c[d].site.y))return!0;return!1},isWater:function(c,x,y){for(var i=0;i<c.length;i++)if(c[i].site.x==x&&c[i].site.y==y&&!c[i].isLand)return i;return!1},isNeighbor:function(c,s,d){if(!c[s]||!c[d])throw new Error("cells not found!");for(var startSite={x:c[s].site.x,y:c[s].site.y},testSite={x:null,y:null},surroundingOceanCandidates=[],i=0;i<c[s].halfedges.length;i++)if(c[s].halfedges[i].edge.lSite&&c[s].halfedges[i].edge.rSite){if(c[s].halfedges[i].edge.lSite.x==startSite.x&&c[s].halfedges[i].edge.lSite.y==startSite.y?(testSite.x=c[s].halfedges[i].edge.rSite.x,testSite.y=c[s].halfedges[i].edge.rSite.y):(testSite.x=c[s].halfedges[i].edge.lSite.x,testSite.y=c[s].halfedges[i].edge.lSite.y),testSite.x==c[d].site.x&&testSite.y==c[d].site.y)return!0;surroundingOceanCandidates.push(this.isWater(c,testSite.x,testSite.y))}for(i=0;i<surroundingOceanCandidates.length;i++)if(surroundingOceanCandidates[i]||0===surroundingOceanCandidates[i]){startSite.x=c[surroundingOceanCandidates[i]].site.x,startSite.y=c[surroundingOceanCandidates[i]].site.y;for(var j=0;j<c[surroundingOceanCandidates[i]].halfedges.length;j++)if(c[surroundingOceanCandidates[i]].halfedges[j].edge.lSite&&c[surroundingOceanCandidates[i]].halfedges[j].edge.rSite&&(c[surroundingOceanCandidates[i]].halfedges[j].edge.lSite.x==startSite.x&&c[surroundingOceanCandidates[i]].halfedges[j].edge.lSite.y==startSite.y?(testSite.x=c[surroundingOceanCandidates[i]].halfedges[j].edge.rSite.x,testSite.y=c[surroundingOceanCandidates[i]].halfedges[j].edge.rSite.y):(testSite.x=c[surroundingOceanCandidates[i]].halfedges[j].edge.lSite.x,testSite.y=c[surroundingOceanCandidates[i]].halfedges[j].edge.lSite.y),testSite.x==c[d].site.x&&testSite.y==c[d].site.y))return!0}return!1},delMap:function(id){return $http.delete("/map/del/"+id,function(r){return r})},GetVoronoi:function(hi,wid,numCells,schmooz){var newVor={voronoi:new Voronoi,diagram:null,margin:.1,canvas:null,bbox:{xl:0,xr:wid,yt:0,yb:hi},sites:[],countryNames:[],cellCenters:[],timeoutDelay:30,numsRelaxed:100,init:function(){this.canvas=document.querySelector("canvas"),this.clearMap(),this.randomSites(numCells,!0)},save:function(){var mapData={countryNames:this.countryNames,bbox:this.bbox,sites:this.sites,numsRelaxed:this.numsRelaxed,diagram:this.diagram,doneCouns:this.doneCouns,currCont:this.currCont,cellCenters:this.cellCenters,img:this.canvas.toDataURL()};return console.log("TO SAVE:",mapData),$http.post("/map/newMap",mapData).then(function(r){return r})},clearSites:function(){this.compute([])},randomSites:function(n,clear){var sites=[];clear||(sites=this.sites.slice(0));for(var xmargin=this.canvas.width*this.margin,ymargin=this.canvas.height*this.margin,xo=xmargin,dx=this.canvas.width-2*xmargin,yo=ymargin,dy=this.canvas.height-2*ymargin,i=0;i<n;i++)sites.push({x:self.Math.round(10*(xo+self.Math.random()*dx))/10,y:self.Math.round(10*(yo+self.Math.random()*dy))/10});this.compute(sites),this.timeout&&(clearTimeout(this.timeout),this.timeout=null);var me=this;this.timeout=setTimeout(function(){me.relaxSites()},this.timeoutDelay)},relaxSites:function(){if(this.diagram){for(var cell,site,rn,dist,cells=this.diagram.cells,iCell=cells.length,sites=[],again=!1,p=1/iCell*.1;iCell--;)cell=cells[iCell],rn=Math.random(),rn<p||(site=this.cellCentroid(cell),dist=this.distance(site,cell.site),this.numsRelaxed-=1/(numCells/schmooz),again=this.numsRelaxed>0,dist>2&&(site.x=(site.x+cell.site.x)/2,site.y=(site.y+cell.site.y)/2),rn>1-p&&(dist/=2,sites.push({x:site.x+(site.x-cell.site.x)/dist,y:site.y+(site.y-cell.site.y)/dist})),sites.push(site));if(this.compute(sites),again){var me=this;this.timeout=setTimeout(function(){me.relaxSites()},this.timeoutDelay)}else this.render()}},doCellSites:function(){var _this=this;this.diagram.cells.forEach(function(c){(c.name||c.country)&&_this.cellCenters.push({x:c.site.x,y:c.site.y,name:c.name||c.country})})},initLoad:function(im){this.canvas=document.querySelector("canvas"),this.clearMap(),this.getCellNames();var ctx=this.canvas.getContext("2d"),img=new Image,canv=this.canvas;img.onload=function(){canv.width=img.width,canv.height=img.height,ctx.drawImage(img,0,0)},img.src=im},makeAName:function(){var nm="",whichPtrn=Math.floor(5*Math.random());switch(whichPtrn){case 0:nm=countries[0][Math.floor(Math.random()*countries[0].length)]+countries[1][Math.floor(Math.random()*countries[1].length)]+countries[2][Math.floor(Math.random()*countries[2].length)]+countries[3][Math.floor(Math.random()*countries[3].length)]+countries[4][Math.floor(Math.random()*countries[4].length)];break;case 1:nm=countries[0][Math.floor(Math.random()*countries[0].length)]+countries[1][Math.floor(Math.random()*countries[1].length)]+countries[2][Math.floor(Math.random()*countries[2].length)]+countries[5][Math.floor(Math.random()*countries[5].length)];break;case 2:nm=countries[2][Math.floor(Math.random()*countries[2].length)]+countries[3][Math.floor(Math.random()*countries[3].length)]+countries[4][Math.floor(Math.random()*countries[4].length)];break;case 3:nm=countries[1][Math.floor(Math.random()*countries[1].length)]+countries[2][Math.floor(Math.random()*countries[2].length)]+countries[5][Math.floor(Math.random()*countries[5].length)];break;default:nm=countries[2][Math.floor(Math.random()*countries[2].length)]+countries[3][Math.floor(Math.random()*countries[3].length)]+countries[0][Math.floor(Math.random()*countries[0].length)]+countries[2][Math.floor(Math.random()*countries[2].length)]+countries[5][Math.floor(Math.random()*countries[5].length)]}return nm},makeCellNames:function(){for(var n=0;n<this.diagram.cells.length;n++){var cell=this.diagram.cells[n],newName=null;if(cell.isLand){for(var isUnique=!1;!isUnique;)newName=this.makeAName().capit(),Math.random()>.7&&(newName=countryPrefs[Math.floor(Math.random()*countryPrefs.length)]+" "+newName),isUnique=this.countryNames.indexOf(newName)<0,cell.name=newName;this.countryNames.push(newName)}}},distance:function(a,b){var dx=a.x-b.x,dy=a.y-b.y;return Math.sqrt(dx*dx+dy*dy)},cellArea:function(cell){for(var halfedge,p1,p2,area=0,halfedges=cell.halfedges,iHalfedge=halfedges.length;iHalfedge--;)halfedge=halfedges[iHalfedge],p1=this.getStartpoint(halfedge),p2=this.getEndpoint(halfedge),area+=p1.x*p2.y,area-=p1.y*p2.x;return area/=2},cellCentroid:function(cell){for(var halfedge,v,p1,p2,x=0,y=0,halfedges=cell.halfedges,iHalfedge=halfedges.length;iHalfedge--;)halfedge=halfedges[iHalfedge],p1=this.getStartpoint(halfedge),p2=this.getEndpoint(halfedge),v=p1.x*p2.y-p2.x*p1.y,x+=(p1.x+p2.x)*v,y+=(p1.y+p2.y)*v;return v=6*this.cellArea(cell),{x:x/v,y:y/v}},compute:function(sites){this.sites=sites,this.voronoi.recycle(this.diagram),this.diagram=this.voronoi.compute(sites,this.bbox);for(var i=0;i<this.diagram.cells.length;i++)Math.random()>.7?(this.diagram.cells[i].isLand=!0,console.log("cell",i,"is land")):this.diagram.cells[i].isLand=!1},clearMap:function(){var ctx=this.canvas.getContext("2d");ctx.globalAlpha=1,ctx.rect(0,0,this.canvas.width,this.canvas.height),ctx.fillStyle="white",ctx.fill()},render:function(){var ctx=this.canvas.getContext("2d"),waterImg=new Image,me=this;waterImg.src="../img/water.jpg",waterImg.onload=function(){if(ctx.rect(0,0,me.canvas.width,me.canvas.height),ctx.fillStyle=ctx.createPattern(this,"repeat"),ctx.fill(),ctx.globalAlpha=1,ctx.beginPath(),ctx.strokeStyle="#888",ctx.stroke(),me.diagram){ctx.lineWidth=2;for(var edge,v,edges=me.diagram.edges,iEdge=edges.length;iEdge--;)ctx.beginPath(),edge=edges[iEdge],ctx.strokeStyle="#003259",v=edge.va,ctx.moveTo(v.x,v.y),v=edge.vb,ctx.lineTo(v.x,v.y),ctx.stroke();me.doAllCells()}}},getCellNames:function(){for(var ctx=this.canvas.getContext("2d"),n=0;n<this.diagram.cells.length;n++){var cell=this.diagram.cells[n];if(cell.name&&cell.isLand){console.log("creating country ",cell.name);var textBoxWid=ctx.measureText(cell.name).width+4;ctx.fillStyle="#fed",ctx.fillRect(Math.floor(cell.site.x-textBoxWid/2-2),Math.floor(cell.site.y-13),textBoxWid,13),ctx.fillStyle="#000",ctx.font="12px Arial",ctx.fillText(cell.name,cell.site.x-textBoxWid/2,cell.site.y-2),cell.country=cell.name}cell.army={num:0,usr:null}}},findCell:function(x,y){for(var i=0;i<this.diagram.cells.length;i++)if(this.diagram.cells[i].site.x==x&&this.diagram.cells[i].site.y==y)return this.diagram.cells[i];return!1},buildTreemap:function(){for(var treemap=new QuadTree({x:this.bbox.xl,y:this.bbox.yt,width:this.bbox.xr-this.bbox.xl,height:this.bbox.yb-this.bbox.yt}),cells=this.diagram.cells,iCell=cells.length;iCell--;)bbox=cells[iCell].getBbox(),bbox.cellid=iCell,treemap.insert(bbox);return treemap},pointIntersection:function(cell,x,y){for(var halfedge,p0,p1,r,halfedges=cell.halfedges,iHalfedge=halfedges.length;iHalfedge--;){if(halfedge=halfedges[iHalfedge],p0=this.getStartpoint(halfedge),p1=this.getEndpoint(halfedge),r=(y-p0.y)*(p1.x-p0.x)-(x-p0.x)*(p1.y-p0.y),!r)return 0;if(r>0)return-1}return 1},getStartpoint:function(h){return h.edge.lSite===h.site?h.edge.va:h.edge.vb},getEndpoint:function(h){return h.edge.lSite===h.site?h.edge.vb:h.edge.va},cellIdFromPoint:function(x,y){this.treemap=this.buildTreemap(),console.log("Treez",this.treemap);var cell,cellid,items=this.treemap.retrieve({x:x,y:y}),iItem=items.length,cells=this.diagram.cells;for(this.diagram.cells.length;iItem--;)if(cellid=items[iItem].cellid,cell=cells[cellid],this.pointIntersection(cell,x,y)>0)return cellid},cellByPoint:function(x,y){for(var cell,cells=this.diagram.cells,cellNum=this.diagram.cells.length;--cellNum;)if(cell=cells[cellNum],this.pointIntersection(cell,x,y)>0)return cellNum},renderCell:function(id){if(void 0!==id&&this.diagram){var cell=this.diagram.cells[id];if(cell){var ctx=this.canvas.getContext("2d");console.log("RENDERING CELL",id,"FOR CONTEXT",ctx),ctx.globalAlpha=1,ctx.beginPath();var halfedges=cell.halfedges,nHalfedges=halfedges.length,v=this.getStartpoint(halfedges[0]);ctx.moveTo(v.x,v.y);for(var iHalfedge=0;iHalfedge<nHalfedges;iHalfedge++)v=this.getEndpoint(halfedges[iHalfedge]),ctx.lineTo(v.x,v.y);ctx.fillStyle=this.landPattern,ctx.strokeStyle="#AB9B69",ctx.fill(),ctx.stroke(),v=cell.site,ctx.fillStyle="#44f",ctx.beginPath(),ctx.rect(v.x-2/3,v.y-2/3,2,2),ctx.fill()}}},doAllCells:function(){var landImg=new Image,me=this,ctx=this.canvas.getContext("2d");landImg.src="../img/grass.jpg",landImg.onload=function(){me.landPattern=ctx.createPattern(this,"repeat");for(var n=0;n<me.diagram.cells.length;n++)me.diagram.cells[n].isLand&&me.renderCell(n);me.makeCellNames(),me.getCellNames(),me.doCellSites()}},getCellByName:function(n){for(var i=0;i<this.diagram.cells.length;i++)if(this.diagram.cells[i].name==n)return this.diagram.cells[i];return!1},getCellNumByName:function(n){for(var i=0;i<this.diagram.cells.length;i++)if(this.diagram.cells[i].name==n)return i;return!1},getContinents:function(){this.doneCouns=[],this.allConts=[];for(var i=0;i<this.diagram.cells.length;i++)this.findNeighbors(i,!0);return console.log(this.allConts),this.allConts},doneCouns:[],currCont:[],allConts:[],findNeighbors:function(c,mode){mode&&(this.currCont&&this.currCont.length&&this.allConts.push(this.currCont),this.currCont=[]),m=!1;var names=[this.diagram.cells[c].name];if(console.log("for cell",c,"names starts as",names),this.diagram.cells[c].name){if(this.doneCouns.indexOf(this.diagram.cells[c].name)>-1)return console.log("cell",this.diagram.cells[c].name,"already recorded.",this.doneCouns),names;this.doneCouns.push(this.diagram.cells[c].name),this.currCont.push(this.diagram.cells[c].name);for(var kids=[],i=0;i<this.diagram.cells[c].halfedges.length;i++)if(this.diagram.cells[c].halfedges[i].edge.rSite&&this.diagram.cells[c].halfedges[i].edge.lSite){var neighborNum=this.cellByPoint(this.diagram.cells[c].halfedges[i].edge.rSite.x,this.diagram.cells[c].halfedges[i].edge.rSite.y);this.diagram.cells[neighborNum]&&this.diagram.cells[c].name==this.diagram.cells[neighborNum].name&&(neighborNum=this.cellByPoint(this.diagram.cells[c].halfedges[i].edge.lSite.x,this.diagram.cells[c].halfedges[i].edge.lSite.y)),"undefined"!=typeof neighborNum&&this.diagram.cells[neighborNum]&&this.diagram.cells[neighborNum].name&&this.doneCouns.indexOf(this.diagram.cells[neighborNum].name)==-1&&kids.push(neighborNum)}kids.length?console.log("cell",c,'has neighbors ("kids")',kids):console.log("cell",c,"has NO kids");var me=this;return kids.forEach(function(k){var naybz=me.findNeighbors(k);naybz.forEach(function(n){me.doneCouns.indexOf(n)==-1&&names.push(n)})}),names}},findNaybz:function(c,m){return findNeighbors(c,m)}};return newVor}}}),app.factory("miscFact",function($rootScope,$http){return{getUsr:function(){return $http.get("/user/currUsrData").then(function(r){return r})},chkLoggedStatus:function(){return $http.get("/user/chkLog").then(function(r){return r})},checkUnDup:function(u){
return $http.get("/user/nameOkay/"+u).then(function(r){return r})},regNewUsr:function(u,p){return $http.post("/user/new",{user:u,password:p}).then(function(r){return r})},login:function(u,p){return $http.post("/user/login",{user:u,password:p}).then(function(r){return r})},logout:function(u,p){return $http.get("/user/logout",{user:u,password:p}).then(function(r){return r})},checkInGame:function(u){return $http.get("/user/checkInGame/"+u).then(function(r){return r})},getAllUsers:function(){return $http.get("/user/allUsers/").then(function(usrs){return usrs.data})}}}),app.factory("socket",function($rootScope){console.log("socket factory!");var socket=io.connect();return console.log("socket factory!"),{on:function(eventName,callback){socket.on(eventName,function(){var args=arguments;$rootScope.$apply(function(){callback.apply(socket,args)})})},emit:function(eventName,data,callback){socket.emit(eventName,data,function(){var args=arguments;$rootScope.$apply(function(){callback&&callback.apply(socket,args)})})}}});