"use strict";function Voronoi(){this.vertices=null,this.edges=null,this.cells=null,this.toRecycle=null,this.beachsectionJunkyard=[],this.circleEventJunkyard=[],this.vertexJunkyard=[],this.edgeJunkyard=[],this.cellJunkyard=[]}var hints=[{txt:"Login or Register to get started!",bottom:20,point:"log-btn"},{txt:"Wanna chat with other players? Click here!",bottom:30,point:"chat-btn"},{txt:"Let&rsquo;s start by making a new map! Pick an average number of countries and a smoothing amount, and then click here.",bottom:30,point:"make-map"},{txt:"Go ahead and start a new game. Feel free to set a password if you want!",bottom:30,point:"start-new-game-btn"},{txt:'Your friends can join your game by clicking here, and then clicking the "Join Game" button. Note: You won&rsquo;t be able to join any games, since you&rsquo;re in one!',bottom:30,point:"load-game-tab"},{txt:"Now click the Menu button to get back to main menu.",bottom:30,point:"men-butt"},{txt:"Once you&rsquo;re ready to start, click My Games, and then click Start Game.",bottom:30,point:"my-games-tab"},{txt:"This is the play field. Right now, you&rsquo;re in Move Mode. In this mode, you can move your armies between occupied countries. You can move as many armies as you want, as long as the origin and destination countries share a border, <i>and</i> the origin country contains more than one (1) army. You can also attack across one ocean block.",bottom:30,point:"game-parts"},{txt:"Once you&rsquo;re done, click here to begin Attack Mode.",bottom:30,point:"move-mode-btn"},{txt:"You&rsquo;re now in Attack Mode! Click one of your armies, and then click another player in an adjacent country. Click Attack, and you&rsquo;ll be prompted for how many armies you wish to involve in the attack. As in Move Mode, you must have at least two armies in order to attack, and your armies must share a border with the target country!",bottom:30,point:"game-parts"},{txt:"Once you&rsquo;re done laying waste to those foolish enough to stand in your way, click here to let the next player go. Keep in mind that before their turn, each player will be given additional armies based on how many territories they own.",bottom:30,point:"end-turn-btn"}],remHint=function(e,t){var n=document.querySelector("#hint-bg-div");e&&(localStorage.conkrHints=hints.length),n.parentNode.removeChild(n),"function"==typeof t&&t()},hintMaker=function(e,t){if(localStorage.conkrHints&&parseInt(localStorage.conkrHints)>=e+1)return void("function"==typeof t&&t());var n=document.createElement("div"),r=document.createElement("div"),o=document.querySelector("#"+hints[e].point).offsetLeft,a=document.querySelector("#"+hints[e].point).offsetTop,i=document.createElement("div");r.innerHTML="<h3>&#128161; Hint</h3>"+hints[e].txt+'<hr/><small><input type="checkbox" id="no-more-hints"> No more hints, please!</small><hr/><button class="btn btn-primary" id="close-hint" onclick="remHint()">Got it!</button>',r.className="hint-msg",r.style.top=hints[e].bottom+"%",r.onclick=function(e){e.stopPropagation()},n.onclick=function(){remHint(document.querySelector("#no-more-hints").checked,t)},n.className="hint-bg",n.style.height=window.outerHeight+"px",n.id="hint-bg-div",n.append(r),document.body.append(n);var s=Math.sqrt(Math.pow(Math.abs(o-r.offsetLeft),2)+Math.pow(Math.abs(a-r.offsetTop),2));i.style.width=s+"px",i.className="hint-pointer";var l=180*Math.asin((a-r.offsetTop)/s)/Math.PI;o<r.offsetLeft&&(l=180-l),i.style.transform="rotate("+l+"deg)",r.append(i);var c=document.createElement("div");c.className="hint-pnt-arrow",i.append(c),document.querySelector("#hint-bg-div div.hint-msg button").onclick=function(e){e.stopPropagation(),remHint(document.querySelector("#no-more-hints").checked,t)},localStorage.conkrHints=e+1};!function(e){function t(e,t,o,a){var i;i=t?new n(e,0,o,a):new r(e,0,o,a),this.root=i}function n(e,t,n,r){this._bounds=e,this.children=[],this.nodes=[],r&&(this._maxChildren=r),n&&(this._maxDepth=n),t&&(this._depth=t)}function r(e,t,r,o){n.call(this,e,t,r,o),this._stuckChildren=[]}t.prototype.root=null,t.prototype.insert=function(e){if(e instanceof Array){var t,n=e.length;for(t=0;t<n;t++)this.root.insert(e[t])}else this.root.insert(e)},t.prototype.clear=function(){this.root.clear()},t.prototype.retrieve=function(e){var t=this.root.retrieve(e).slice(0);return t},n.prototype.nodes=null,n.prototype._classConstructor=n,n.prototype.children=null,n.prototype._bounds=null,n.prototype._depth=0,n.prototype._maxChildren=4,n.prototype._maxDepth=4,n.TOP_LEFT=0,n.TOP_RIGHT=1,n.BOTTOM_LEFT=2,n.BOTTOM_RIGHT=3,n.prototype.insert=function(e){if(this.nodes.length){var t=this._findIndex(e);return void this.nodes[t].insert(e)}this.children.push(e);var n=this.children.length;if(!(this._depth>=this._maxDepth)&&n>this._maxChildren){this.subdivide();var r;for(r=0;r<n;r++)this.insert(this.children[r]);this.children.length=0}},n.prototype.retrieve=function(e){if(this.nodes.length){var t=this._findIndex(e);return this.nodes[t].retrieve(e)}return this.children},n.prototype._findIndex=function(e){var t=this._bounds,r=!(e.x>t.x+t.width/2),o=!(e.y>t.y+t.height/2),a=n.TOP_LEFT;return r?o||(a=n.BOTTOM_LEFT):a=o?n.TOP_RIGHT:n.BOTTOM_RIGHT,a},n.prototype.subdivide=function(){var e=this._depth+1,t=this._bounds.x,r=this._bounds.y,o=this._bounds.width/2,a=this._bounds.height/2,i=t+o,s=r+a;this.nodes[n.TOP_LEFT]=new this._classConstructor({x:t,y:r,width:o,height:a},e,this._maxDepth,this._maxChildren),this.nodes[n.TOP_RIGHT]=new this._classConstructor({x:i,y:r,width:o,height:a},e,this._maxDepth,this._maxChildren),this.nodes[n.BOTTOM_LEFT]=new this._classConstructor({x:t,y:s,width:o,height:a},e,this._maxDepth,this._maxChildren),this.nodes[n.BOTTOM_RIGHT]=new this._classConstructor({x:i,y:s,width:o,height:a},e,this._maxDepth,this._maxChildren)},n.prototype.clear=function(){this.children.length=0;var e,t=this.nodes.length;for(e=0;e<t;e++)this.nodes[e].clear();this.nodes.length=0},r.prototype=new n,r.prototype._classConstructor=r,r.prototype._stuckChildren=null,r.prototype._out=[],r.prototype.insert=function(e){if(this.nodes.length){var t=this._findIndex(e),n=this.nodes[t];return void(e.x>=n._bounds.x&&e.x+e.width<=n._bounds.x+n._bounds.width&&e.y>=n._bounds.y&&e.y+e.height<=n._bounds.y+n._bounds.height?this.nodes[t].insert(e):this._stuckChildren.push(e))}this.children.push(e);var r=this.children.length;if(!(this._depth>=this._maxDepth)&&r>this._maxChildren){this.subdivide();var o;for(o=0;o<r;o++)this.insert(this.children[o]);this.children.length=0}},r.prototype.getChildren=function(){return this.children.concat(this._stuckChildren)},r.prototype.retrieve=function(e){var t=this._out;if(t.length=0,this.nodes.length){var r=this._findIndex(e),o=this.nodes[r];e.x>=o._bounds.x&&e.x+e.width<=o._bounds.x+o._bounds.width&&e.y>=o._bounds.y&&e.y+e.height<=o._bounds.y+o._bounds.height?t.push.apply(t,this.nodes[r].retrieve(e)):(e.x<=this.nodes[n.TOP_RIGHT]._bounds.x&&(e.y<=this.nodes[n.BOTTOM_LEFT]._bounds.y&&t.push.apply(t,this.nodes[n.TOP_LEFT].getAllContent()),e.y+e.height>this.nodes[n.BOTTOM_LEFT]._bounds.y&&t.push.apply(t,this.nodes[n.BOTTOM_LEFT].getAllContent())),e.x+e.width>this.nodes[n.TOP_RIGHT]._bounds.x&&(e.y<=this.nodes[n.BOTTOM_RIGHT]._bounds.y&&t.push.apply(t,this.nodes[n.TOP_RIGHT].getAllContent()),e.y+e.height>this.nodes[n.BOTTOM_RIGHT]._bounds.y&&t.push.apply(t,this.nodes[n.BOTTOM_RIGHT].getAllContent())))}return t.push.apply(t,this._stuckChildren),t.push.apply(t,this.children),t},r.prototype.getAllContent=function(){var e=this._out;if(this.nodes.length){var t;for(t=0;t<this.nodes.length;t++)this.nodes[t].getAllContent()}return e.push.apply(e,this._stuckChildren),e.push.apply(e,this.children),e},r.prototype.clear=function(){this._stuckChildren.length=0,this.children.length=0;var e=this.nodes.length;if(e){var t;for(t=0;t<e;t++)this.nodes[t].clear();this.nodes.length=0}},e.QuadTree=t}(window),Voronoi.prototype.reset=function(){if(this.beachline||(this.beachline=new this.RBTree),this.beachline.root)for(var e=this.beachline.getFirst(this.beachline.root);e;)this.beachsectionJunkyard.push(e),e=e.rbNext;this.beachline.root=null,this.circleEvents||(this.circleEvents=new this.RBTree),this.circleEvents.root=this.firstCircleEvent=null,this.vertices=[],this.edges=[],this.cells=[]},Voronoi.prototype.sqrt=Math.sqrt,Voronoi.prototype.abs=Math.abs,Voronoi.prototype.EPSILON=1e-9,Voronoi.prototype.equalWithEpsilon=function(e,t){return this.abs(e-t)<1e-9},Voronoi.prototype.greaterThanWithEpsilon=function(e,t){return e-t>1e-9},Voronoi.prototype.greaterThanOrEqualWithEpsilon=function(e,t){return t-e<1e-9},Voronoi.prototype.lessThanWithEpsilon=function(e,t){return t-e>1e-9},Voronoi.prototype.lessThanOrEqualWithEpsilon=function(e,t){return e-t<1e-9},Voronoi.prototype.RBTree=function(){this.root=null},Voronoi.prototype.RBTree.prototype.rbInsertSuccessor=function(e,t){var n;if(e){if(t.rbPrevious=e,t.rbNext=e.rbNext,e.rbNext&&(e.rbNext.rbPrevious=t),e.rbNext=t,e.rbRight){for(e=e.rbRight;e.rbLeft;)e=e.rbLeft;e.rbLeft=t}else e.rbRight=t;n=e}else this.root?(e=this.getFirst(this.root),t.rbPrevious=null,t.rbNext=e,e.rbPrevious=t,e.rbLeft=t,n=e):(t.rbPrevious=t.rbNext=null,this.root=t,n=null);t.rbLeft=t.rbRight=null,t.rbParent=n,t.rbRed=!0;var r,o;for(e=t;n&&n.rbRed;)r=n.rbParent,n===r.rbLeft?(o=r.rbRight,o&&o.rbRed?(n.rbRed=o.rbRed=!1,r.rbRed=!0,e=r):(e===n.rbRight&&(this.rbRotateLeft(n),e=n,n=e.rbParent),n.rbRed=!1,r.rbRed=!0,this.rbRotateRight(r))):(o=r.rbLeft,o&&o.rbRed?(n.rbRed=o.rbRed=!1,r.rbRed=!0,e=r):(e===n.rbLeft&&(this.rbRotateRight(n),e=n,n=e.rbParent),n.rbRed=!1,r.rbRed=!0,this.rbRotateLeft(r))),n=e.rbParent;this.root.rbRed=!1},Voronoi.prototype.RBTree.prototype.rbRemoveNode=function(e){e.rbNext&&(e.rbNext.rbPrevious=e.rbPrevious),e.rbPrevious&&(e.rbPrevious.rbNext=e.rbNext),e.rbNext=e.rbPrevious=null;var t,n=e.rbParent,r=e.rbLeft,o=e.rbRight;t=r?o?this.getFirst(o):r:o,n?n.rbLeft===e?n.rbLeft=t:n.rbRight=t:this.root=t;var a;if(r&&o?(a=t.rbRed,t.rbRed=e.rbRed,t.rbLeft=r,r.rbParent=t,t!==o?(n=t.rbParent,t.rbParent=e.rbParent,e=t.rbRight,n.rbLeft=e,t.rbRight=o,o.rbParent=t):(t.rbParent=n,n=t,e=t.rbRight)):(a=e.rbRed,e=t),e&&(e.rbParent=n),!a){if(e&&e.rbRed)return void(e.rbRed=!1);var i;do{if(e===this.root)break;if(e===n.rbLeft){if(i=n.rbRight,i.rbRed&&(i.rbRed=!1,n.rbRed=!0,this.rbRotateLeft(n),i=n.rbRight),i.rbLeft&&i.rbLeft.rbRed||i.rbRight&&i.rbRight.rbRed){i.rbRight&&i.rbRight.rbRed||(i.rbLeft.rbRed=!1,i.rbRed=!0,this.rbRotateRight(i),i=n.rbRight),i.rbRed=n.rbRed,n.rbRed=i.rbRight.rbRed=!1,this.rbRotateLeft(n),e=this.root;break}}else if(i=n.rbLeft,i.rbRed&&(i.rbRed=!1,n.rbRed=!0,this.rbRotateRight(n),i=n.rbLeft),i.rbLeft&&i.rbLeft.rbRed||i.rbRight&&i.rbRight.rbRed){i.rbLeft&&i.rbLeft.rbRed||(i.rbRight.rbRed=!1,i.rbRed=!0,this.rbRotateLeft(i),i=n.rbLeft),i.rbRed=n.rbRed,n.rbRed=i.rbLeft.rbRed=!1,this.rbRotateRight(n),e=this.root;break}i.rbRed=!0,e=n,n=n.rbParent}while(!e.rbRed);e&&(e.rbRed=!1)}},Voronoi.prototype.RBTree.prototype.rbRotateLeft=function(e){var t=e,n=e.rbRight,r=t.rbParent;r?r.rbLeft===t?r.rbLeft=n:r.rbRight=n:this.root=n,n.rbParent=r,t.rbParent=n,t.rbRight=n.rbLeft,t.rbRight&&(t.rbRight.rbParent=t),n.rbLeft=t},Voronoi.prototype.RBTree.prototype.rbRotateRight=function(e){var t=e,n=e.rbLeft,r=t.rbParent;r?r.rbLeft===t?r.rbLeft=n:r.rbRight=n:this.root=n,n.rbParent=r,t.rbParent=n,t.rbLeft=n.rbRight,t.rbLeft&&(t.rbLeft.rbParent=t),n.rbRight=t},Voronoi.prototype.RBTree.prototype.getFirst=function(e){for(;e.rbLeft;)e=e.rbLeft;return e},Voronoi.prototype.RBTree.prototype.getLast=function(e){for(;e.rbRight;)e=e.rbRight;return e},Voronoi.prototype.Diagram=function(e){this.site=e},Voronoi.prototype.Cell=function(e){this.site=e,this.halfedges=[],this.closeMe=!1},Voronoi.prototype.Cell.prototype.init=function(e){return this.site=e,this.halfedges=[],this.closeMe=!1,this},Voronoi.prototype.createCell=function(e){var t=this.cellJunkyard.pop();return t?t.init(e):new this.Cell(e)},Voronoi.prototype.Cell.prototype.prepareHalfedges=function(){for(var e,t=this.halfedges,n=t.length;n--;)e=t[n].edge,e.vb&&e.va||t.splice(n,1);return t.sort(function(e,t){return t.angle-e.angle}),t.length},Voronoi.prototype.Cell.prototype.getNeighborIds=function(){for(var e,t=[],n=this.halfedges.length;n--;)e=this.halfedges[n].edge,null!==e.lSite&&e.lSite.voronoiId!=this.site.voronoiId?t.push(e.lSite.voronoiId):null!==e.rSite&&e.rSite.voronoiId!=this.site.voronoiId&&t.push(e.rSite.voronoiId);return t},Voronoi.prototype.Cell.prototype.getBbox=function(){for(var e,t,n,r=this.halfedges,o=r.length,a=1/0,i=1/0,s=-(1/0),l=-(1/0);o--;)e=r[o].getStartpoint(),t=e.x,n=e.y,t<a&&(a=t),n<i&&(i=n),t>s&&(s=t),n>l&&(l=n);return{x:a,y:i,width:s-a,height:l-i}},Voronoi.prototype.Cell.prototype.pointIntersection=function(e,t){for(var n,r,o,a,i=this.halfedges,s=i.length;s--;){if(n=i[s],r=n.getStartpoint(),o=n.getEndpoint(),a=(t-r.y)*(o.x-r.x)-(e-r.x)*(o.y-r.y),!a)return 0;if(a>0)return-1}return 1},Voronoi.prototype.Vertex=function(e,t){this.x=e,this.y=t},Voronoi.prototype.Edge=function(e,t){this.lSite=e,this.rSite=t,this.va=this.vb=null},Voronoi.prototype.Halfedge=function(e,t,n){if(this.site=t,this.edge=e,n)this.angle=Math.atan2(n.y-t.y,n.x-t.x);else{var r=e.va,o=e.vb;this.angle=e.lSite===t?Math.atan2(o.x-r.x,r.y-o.y):Math.atan2(r.x-o.x,o.y-r.y)}},Voronoi.prototype.createHalfedge=function(e,t,n){return new this.Halfedge(e,t,n)},Voronoi.prototype.Halfedge.prototype.getStartpoint=function(){return this.edge.lSite===this.site?this.edge.va:this.edge.vb},Voronoi.prototype.Halfedge.prototype.getEndpoint=function(){return this.edge.lSite===this.site?this.edge.vb:this.edge.va},Voronoi.prototype.createVertex=function(e,t){var n=this.vertexJunkyard.pop();return n?(n.x=e,n.y=t):n=new this.Vertex(e,t),this.vertices.push(n),n},Voronoi.prototype.createEdge=function(e,t,n,r){var o=this.edgeJunkyard.pop();return o?(o.lSite=e,o.rSite=t,o.va=o.vb=null):o=new this.Edge(e,t),this.edges.push(o),n&&this.setEdgeStartpoint(o,e,t,n),r&&this.setEdgeEndpoint(o,e,t,r),this.cells[e.voronoiId].halfedges.push(this.createHalfedge(o,e,t)),this.cells[t.voronoiId].halfedges.push(this.createHalfedge(o,t,e)),o},Voronoi.prototype.createBorderEdge=function(e,t,n){var r=this.edgeJunkyard.pop();return r?(r.lSite=e,r.rSite=null):r=new this.Edge(e,null),r.va=t,r.vb=n,this.edges.push(r),r},Voronoi.prototype.setEdgeStartpoint=function(e,t,n,r){e.va||e.vb?e.lSite===n?e.vb=r:e.va=r:(e.va=r,e.lSite=t,e.rSite=n)},Voronoi.prototype.setEdgeEndpoint=function(e,t,n,r){this.setEdgeStartpoint(e,n,t,r)},Voronoi.prototype.Beachsection=function(){},Voronoi.prototype.createBeachsection=function(e){var t=this.beachsectionJunkyard.pop();return t||(t=new this.Beachsection),t.site=e,t},Voronoi.prototype.leftBreakPoint=function(e,t){var n=e.site,r=n.x,o=n.y,a=o-t;if(!a)return r;var i=e.rbPrevious;if(!i)return-(1/0);n=i.site;var s=n.x,l=n.y,c=l-t;if(!c)return s;var h=s-r,u=1/a-1/c,d=h/c;return u?(-d+this.sqrt(d*d-2*u*(h*h/(-2*c)-l+c/2+o-a/2)))/u+r:(r+s)/2},Voronoi.prototype.rightBreakPoint=function(e,t){var n=e.rbNext;if(n)return this.leftBreakPoint(n,t);var r=e.site;return r.y===t?r.x:1/0},Voronoi.prototype.detachBeachsection=function(e){this.detachCircleEvent(e),this.beachline.rbRemoveNode(e),this.beachsectionJunkyard.push(e)},Voronoi.prototype.removeBeachsection=function(e){var t=e.circleEvent,n=t.x,r=t.ycenter,o=this.createVertex(n,r),a=e.rbPrevious,i=e.rbNext,s=[e],l=Math.abs;this.detachBeachsection(e);for(var c=a;c.circleEvent&&l(n-c.circleEvent.x)<1e-9&&l(r-c.circleEvent.ycenter)<1e-9;)a=c.rbPrevious,s.unshift(c),this.detachBeachsection(c),c=a;s.unshift(c),this.detachCircleEvent(c);for(var h=i;h.circleEvent&&l(n-h.circleEvent.x)<1e-9&&l(r-h.circleEvent.ycenter)<1e-9;)i=h.rbNext,s.push(h),this.detachBeachsection(h),h=i;s.push(h),this.detachCircleEvent(h);var u,d=s.length;for(u=1;u<d;u++)h=s[u],c=s[u-1],this.setEdgeStartpoint(h.edge,c.site,h.site,o);c=s[0],h=s[d-1],h.edge=this.createEdge(c.site,h.site,void 0,o),this.attachCircleEvent(c),this.attachCircleEvent(h)},Voronoi.prototype.addBeachsection=function(e){for(var t,n,r,o,a=e.x,i=e.y,s=this.beachline.root;s;)if(r=this.leftBreakPoint(s,i)-a,r>1e-9)s=s.rbLeft;else{if(o=a-this.rightBreakPoint(s,i),!(o>1e-9)){r>-1e-9?(t=s.rbPrevious,n=s):o>-1e-9?(t=s,n=s.rbNext):t=n=s;break}if(!s.rbRight){t=s;break}s=s.rbRight}var l=this.createBeachsection(e);if(this.beachline.rbInsertSuccessor(t,l),t||n){if(t===n)return this.detachCircleEvent(t),n=this.createBeachsection(t.site),this.beachline.rbInsertSuccessor(l,n),l.edge=n.edge=this.createEdge(t.site,l.site),this.attachCircleEvent(t),void this.attachCircleEvent(n);if(t&&!n)return void(l.edge=this.createEdge(t.site,l.site));if(t!==n){this.detachCircleEvent(t),this.detachCircleEvent(n);var c=t.site,h=c.x,u=c.y,d=e.x-h,g=e.y-u,m=n.site,f=m.x-h,p=m.y-u,y=2*(d*p-g*f),b=d*d+g*g,v=f*f+p*p,x=this.createVertex((p*b-g*v)/y+h,(d*v-f*b)/y+u);return this.setEdgeStartpoint(n.edge,c,m,x),l.edge=this.createEdge(c,e,void 0,x),n.edge=this.createEdge(e,m,void 0,x),this.attachCircleEvent(t),void this.attachCircleEvent(n)}}},Voronoi.prototype.CircleEvent=function(){this.arc=null,this.rbLeft=null,this.rbNext=null,this.rbParent=null,this.rbPrevious=null,this.rbRed=!1,this.rbRight=null,this.site=null,this.x=this.y=this.ycenter=0},Voronoi.prototype.attachCircleEvent=function(e){var t=e.rbPrevious,n=e.rbNext;if(t&&n){var r=t.site,o=e.site,a=n.site;if(r!==a){var i=o.x,s=o.y,l=r.x-i,c=r.y-s,h=a.x-i,u=a.y-s,d=2*(l*u-c*h);if(!(d>=-2e-12)){var g=l*l+c*c,m=h*h+u*u,f=(u*g-c*m)/d,p=(l*m-h*g)/d,y=p+s,b=this.circleEventJunkyard.pop();b||(b=new this.CircleEvent),b.arc=e,b.site=o,b.x=f+i,b.y=y+this.sqrt(f*f+p*p),b.ycenter=y,e.circleEvent=b;for(var v=null,x=this.circleEvents.root;x;)if(b.y<x.y||b.y===x.y&&b.x<=x.x){if(!x.rbLeft){v=x.rbPrevious;break}x=x.rbLeft}else{if(!x.rbRight){v=x;break}x=x.rbRight}this.circleEvents.rbInsertSuccessor(v,b),v||(this.firstCircleEvent=b)}}}},Voronoi.prototype.detachCircleEvent=function(e){var t=e.circleEvent;t&&(t.rbPrevious||(this.firstCircleEvent=t.rbNext),this.circleEvents.rbRemoveNode(t),this.circleEventJunkyard.push(t),e.circleEvent=null)},Voronoi.prototype.connectEdge=function(e,t){var n=e.vb;if(n)return!0;var r,o,a=e.va,i=t.xl,s=t.xr,l=t.yt,c=t.yb,h=e.lSite,u=e.rSite,d=h.x,g=h.y,m=u.x,f=u.y,p=(d+m)/2,y=(g+f)/2;if(this.cells[h.voronoiId].closeMe=!0,this.cells[u.voronoiId].closeMe=!0,f!==g&&(r=(d-m)/(f-g),o=y-r*p),void 0===r){if(p<i||p>=s)return!1;if(d>m){if(a){if(a.y>=c)return!1}else a=this.createVertex(p,l);n=this.createVertex(p,c)}else{if(a){if(a.y<l)return!1}else a=this.createVertex(p,c);n=this.createVertex(p,l)}}else if(r<-1||r>1)if(d>m){if(a){if(a.y>=c)return!1}else a=this.createVertex((l-o)/r,l);n=this.createVertex((c-o)/r,c)}else{if(a){if(a.y<l)return!1}else a=this.createVertex((c-o)/r,c);n=this.createVertex((l-o)/r,l)}else if(g<f){if(a){if(a.x>=s)return!1}else a=this.createVertex(i,r*i+o);n=this.createVertex(s,r*s+o)}else{if(a){if(a.x<i)return!1}else a=this.createVertex(s,r*s+o);n=this.createVertex(i,r*i+o)}return e.va=a,e.vb=n,!0},Voronoi.prototype.clipEdge=function(e,t){var n=e.va.x,r=e.va.y,o=e.vb.x,a=e.vb.y,i=0,s=1,l=o-n,c=a-r,h=n-t.xl;if(0===l&&h<0)return!1;var u=-h/l;if(l<0){if(u<i)return!1;u<s&&(s=u)}else if(l>0){if(u>s)return!1;u>i&&(i=u)}if(h=t.xr-n,0===l&&h<0)return!1;if(u=h/l,l<0){if(u>s)return!1;u>i&&(i=u)}else if(l>0){if(u<i)return!1;u<s&&(s=u)}if(h=r-t.yt,0===c&&h<0)return!1;if(u=-h/c,c<0){if(u<i)return!1;u<s&&(s=u)}else if(c>0){if(u>s)return!1;u>i&&(i=u)}if(h=t.yb-r,0===c&&h<0)return!1;if(u=h/c,c<0){if(u>s)return!1;u>i&&(i=u)}else if(c>0){if(u<i)return!1;u<s&&(s=u)}return i>0&&(e.va=this.createVertex(n+i*l,r+i*c)),s<1&&(e.vb=this.createVertex(n+s*l,r+s*c)),(i>0||s<1)&&(this.cells[e.lSite.voronoiId].closeMe=!0,this.cells[e.rSite.voronoiId].closeMe=!0),!0},Voronoi.prototype.clipEdges=function(e){for(var t,n=this.edges,r=n.length,o=Math.abs;r--;)t=n[r],(!this.connectEdge(t,e)||!this.clipEdge(t,e)||o(t.va.x-t.vb.x)<1e-9&&o(t.va.y-t.vb.y)<1e-9)&&(t.va=t.vb=null,n.splice(r,1))},Voronoi.prototype.closeCells=function(e){for(var t,n,r,o,a,i,s,l,c,h=e.xl,u=e.xr,d=e.yt,g=e.yb,m=this.cells,f=m.length,p=Math.abs;f--;)if(t=m[f],t.prepareHalfedges()&&t.closeMe){for(r=t.halfedges,o=r.length,n=0;n<o&&(i=r[n].getEndpoint(),l=r[(n+1)%o].getStartpoint(),!(p(i.x-l.x)>=1e-9||p(i.y-l.y)>=1e-9));)n++;if(n!==o){switch(!0){case this.equalWithEpsilon(i.x,h)&&this.lessThanWithEpsilon(i.y,g):if(c=this.equalWithEpsilon(l.x,h),s=this.createVertex(h,c?l.y:g),a=this.createBorderEdge(t.site,i,s),n++,r.splice(n,0,this.createHalfedge(a,t.site,null)),c)break;i=s;case this.equalWithEpsilon(i.y,g)&&this.lessThanWithEpsilon(i.x,u):if(c=this.equalWithEpsilon(l.y,g),s=this.createVertex(c?l.x:u,g),a=this.createBorderEdge(t.site,i,s),n++,r.splice(n,0,this.createHalfedge(a,t.site,null)),c)break;i=s;case this.equalWithEpsilon(i.x,u)&&this.greaterThanWithEpsilon(i.y,d):if(c=this.equalWithEpsilon(l.x,u),s=this.createVertex(u,c?l.y:d),a=this.createBorderEdge(t.site,i,s),n++,r.splice(n,0,this.createHalfedge(a,t.site,null)),c)break;i=s;case this.equalWithEpsilon(i.y,d)&&this.greaterThanWithEpsilon(i.x,h):if(c=this.equalWithEpsilon(l.y,d),s=this.createVertex(c?l.x:h,d),a=this.createBorderEdge(t.site,i,s),n++,r.splice(n,0,this.createHalfedge(a,t.site,null)),c)break;if(i=s,c=this.equalWithEpsilon(l.x,h),s=this.createVertex(h,c?l.y:g),a=this.createBorderEdge(t.site,i,s),n++,r.splice(n,0,this.createHalfedge(a,t.site,null)),c)break;if(i=s,c=this.equalWithEpsilon(l.y,g),s=this.createVertex(c?l.x:u,g),a=this.createBorderEdge(t.site,i,s),n++,r.splice(n,0,this.createHalfedge(a,t.site,null)),c)break;i=s,c=this.equalWithEpsilon(l.x,u),s=this.createVertex(u,c?l.y:d),a=this.createBorderEdge(t.site,i,s),n++,r.splice(n,0,this.createHalfedge(a,t.site,null));break;default:throw"Voronoi.closeCells() > this makes no sense!"}if(p(s.x-l.x)>=1e-9||p(s.y-l.y)>=1e-9)throw"Voronoi.closeCells() > Could not close the Voronoi cell!\n  (See https://github.com/gorhill/Javascript-Voronoi/issues/15)"}}},Voronoi.prototype.quantizeSites=function(e){for(var t,n=this.EPSILON,r=e.length;r--;)t=e[r],t.x=Math.floor(t.x/n)*n,t.y=Math.floor(t.y/n)*n},Voronoi.prototype.recycle=function(e){if(e){if(!(e instanceof this.Diagram))throw"Voronoi.recycleDiagram() > Need a Diagram object.";this.toRecycle=e}},Voronoi.prototype.compute=function(e,t){var n=new Date;this.reset(),this.toRecycle&&(this.vertexJunkyard=this.vertexJunkyard.concat(this.toRecycle.vertices),this.edgeJunkyard=this.edgeJunkyard.concat(this.toRecycle.edges),this.cellJunkyard=this.cellJunkyard.concat(this.toRecycle.cells),this.toRecycle=null);var r=e.slice(0);r.sort(function(e,t){var n=t.y-e.y;return n?n:t.x-e.x});for(var o,a,i,s=r.pop(),l=0,c=this.cells;;)if(i=this.firstCircleEvent,s&&(!i||s.y<i.y||s.y===i.y&&s.x<i.x))s.x===o&&s.y===a||(c[l]=this.createCell(s),s.voronoiId=l++,this.addBeachsection(s),a=s.y,o=s.x),s=r.pop();else{if(!i)break;this.removeBeachsection(i.arc)}this.clipEdges(t),this.closeCells(t);var h=new Date,u=new this.Diagram;return u.cells=this.cells,u.edges=this.edges,u.vertices=this.vertices,u.execTime=h.getTime()-n.getTime(),this.reset(),u};var app=angular.module("conkr",["ngSanitize","ui.bootstrap.contextMenu"]).controller("chatController",["$scope","mapFact","miscFact",function(e,t,n){e.prevSent=[],e.msgs=[{now:(new Date).toLocaleTimeString(),usr:"system",msg:'Welcome to Conkr! chat. "/inv": toggle color modes, "/time": toggle timestamp, "/l": switch to local chat (only works if you\'re in a game!), "/a": switch to all chat',local:!1}],e.user=null,e.msgInp="",n.getUsr().then(function(t){if(!t.data||!t.data.name)throw new Error("User not found or not logged in!");e.user=t.data.name}),socket.on("newMsg",function(t){t.now=(new Date).toLocaleTimeString(),e.msgs.length>8&&e.msgs.shift(),e.msgs.push(t),e.$digest(),console.log("new message",t),e.$parent.$parent.showChat||($("#chat-btn").addClass("chat-blink btn-lg"),setTimeout(function(){$("#chat-btn").removeClass("chat-blink btn-lg")},250)),$(".chat-cont").scrollTop(parseInt($(".chat-cont").height()))}),e.sendMsg=function(){if("/time"==e.msgInp)e.timeStamp=!e.timeStamp;else if("/inv"==e.msgInp)e.invCol=!e.invCol;else if("/l"==e.msgInp&&e.$parent.gameId)e.chatLocal=!0;else if("/l"!=e.msgInp||e.$parent.gameId)if("/a"==e.msgInp)e.chatLocal=!1;else{if(""===e.msgInp)return!1;socket.emit("sendMsg",{msg:e.msgInp,usr:e.user,local:!!e.$parent.gameId&&e.chatLocal})}else;e.prevSent.push(e.msgInp),e.currPrevMsg=e.prevSent.length,e.msgInp="",$("#msgInp").focus()},document.querySelector("#msgInp").addEventListener("keyup",function(t){38==t.which?(t.preventDefault(),e.prevSent.length&&e.currPrevMsg>0&&(e.currPrevMsg--,e.msgInp=e.prevSent[e.currPrevMsg]),e.$digest()):40==t.which?(t.preventDefault(),e.prevSent.length&&e.currPrevMsg<e.prevSent.length-1&&(e.currPrevMsg++,e.msgInp=e.prevSent[e.currPrevMsg]),e.$digest()):27==t.which&&(t.preventDefault(),e.currPrevMsg=e.prevSent.length,e.msgInp="",e.$digest())}),e.switchTabs=function(t){console.log(e.$parent.gameId),e.chatLocal=!!e.$parent.gameId&&parseInt(t)}}]);app.controller("loginCont",["$scope","miscFact","$timeout",function(e,t,n){e.logMode=!0,e.pwdStren=0,hintMaker(0),e.passGud={len:0,caps:!1,lower:!1,num:!1,symb:!1,badWrd:!1,sameUn:!1},e.dupUn=!1,e.checkDupUn=function(){return!!e.regUser&&void t.checkUnDup(e.regUser).then(function(t){e.dupUn="bad"==t.data})},e.getAbtHeight=function(){n(function(){document.querySelector(".abt-bg").style.height=$("#abt-stuff").height()/.9+"px"},0,!1)},e.showAbt=!1,e.getPwdStren=function(){var t=0,n=e.regPwdOne,r=["password","pass","123","abc","admin"];e.passGud={len:0,caps:!1,lower:!1,num:!1,symb:!1,badWrd:!1,sameUn:!1},n.length>16?(t+=8,e.passGud.len=16):n.length>12?(t+=6,e.passGud.len=12):n.length>8?(t+=4,e.passGud.len=8):n.length>4?(t+=2,e.passGud.len=4):e.passGud.len=!1,n.match(/[A-Z]/)&&(t+=1,e.passGud.caps=!0),n.match(/[a-z]/)&&(t+=1,e.passGud.lower=!0),n.match(/[0-9]/)&&(t+=1,e.passGud.num=!0),n.match(/!|@|#|\$|%|\/|\\|\^|&|\*|-|_/)&&(t+=1,e.passGud.symb=!0),r.forEach(function(r){t>1&&n.indexOf(r)>-1&&(t-=2,e.passGud.badWrd=!0)}),e.regUser==n&&t>2&&(t-=3,e.passGud.sameUn=!0),e.pwdStren=t},e.explPwd=function(){sandalchest.alert("Password Strength","Password Criteria:<ul class='pwd-list'><li><span id='pwd-len-btn' style='background:hsl("+120*e.passGud.len/16+",100%,40%);'></span> "+(e.passGud.len?"At least "+e.passGud.len:"Less than 4")+" characters</li><li>"+(e.passGud.caps?"&#10003;":"&#10007;")+" Contains a capital letter</li><li>"+(e.passGud.lower?"&#10003;":"&#10007;")+" Contains a lowercase letter</li><li>"+(e.passGud.num?"&#10003;":"&#10007;")+" Contains a number</li><li>"+(e.passGud.symb?"&#10003;":"&#10007;")+" Contains a non-alphanumeric symbol (i.e., '@', or '#')</li><li>"+(e.passGud.badWrd?"&#10007;":"&#10003;")+" Does <i>not</i> contain any common sequences, like 'abc' or '123' or 'password'.</li><li>"+(e.passGud.sameUn?"&#10007;":"&#10003;")+" Is <i>not</i> the same as your username.</li></ul>")},e.newUsr=function(){t.regNewUsr(e.regUser,e.regPwdOne).then(function(n){"DUPLICATE"==n.data?sandalchest.alert("Registration Error","Uh oh! Something went horribly wrong!"):t.login(e.regUser,e.regPwdOne).then(function(e){"no"==e.data?sandalchest.alert("Registration Error","There was an error while checking your username/password. Please try again.",{speed:250}):sandalchest.alert("Registration Successful","Welcome!",function(e){window.location.assign("../")},{speed:250})})})},e.log=function(){t.login(e.logUsr,e.logPwd).then(function(e){"no"==e.data?sandalchest.alert("Login error","Please check your username and/or password<hr/><i>Note:</i> While Conkr is under development, data may be deleted at any time!",{speed:250}):localStorage.conkrNoWelcome?window.location.assign("../"):sandalchest.alert("Login Successful",'Welcome back!<br/><br/><small><input type="checkbox" id="noWelcome"/> Don&rsquo;t show this again</small>',function(e){document.querySelector("#noWelcome").checked&&(localStorage.conkrNoWelcome=!0),window.location.assign("../")},{speed:250})})}}]);var socket=io(),socketRoom=null;app.controller("conkrcon",["$scope","$http","fightFact","mapFact","miscFact","$sce",function(e,t,n,r,o,a){e.isDead=!1,e.loading=!0,e.playerStats=[{h:0,name:"ed",num:20,numPerc:33},{h:20,name:"edd",num:10,numPerc:16},{h:40,name:"eddy",num:30,numPerc:50}],o.chkLoggedStatus().then(function(t){console.log("DATA",t.data),t.data.result||window.location.assign("./login"),e.user=t.data.name,hintMaker(1,function(){o.checkInGame(t.data.name).then(function(t){t.data.game?(e.reloadGame(t.data.game),e.gameSettingsPanel=2,e.isDead=!t.data.alive,e.canJoin=!1):(e.loading=!1,e.$digest(),hintMaker(2))})})}),e.biomeTypes={warm:["city","swamp","forest","plains","hills"],cold:["frozen city","frozen swamp","boreal forest","tundra","mountain"]},e.isInvis=function(e){return"city"==e.terr||"forest"==e.terr||"hills"==e.terr||"frozen city"==e.terr||"boreal forest"==e.terr||"mountain"==e.terr},e.btns=!0,e.allGames=[],e.usrGames=function(){return e.allGames.filter(function(t){return t.creator==e.user})},e.win={w:.95*$(window).width(),h:.95*$(window).height()},e.reloadGame=function(t){e.currGamePlayers={},t.players.forEach(function(n,r){e.currGamePlayers[n]=t.avas[r]}),e.gameId=t.gameId,console.log("GAME",t),r.loadOneMap(t.mapId).then(function(n){console.log("result of attempt to get 1 map",n),e.pickMap(n.data.mapData,t.mapId,!0),e.loading=!1,e.$digest(),e.gameReady=!0,hintMaker(7,function(){hintMaker(8)})})},e.logout=function(){o.logout().then(function(){window.location.assign("./login")})},window.onkeyup=function(t){13==t.which&&e.showChat?$("#msgInp").focus():191==t.which&&(e.showChat=!0,e.$digest(),$("#msgInp").focus())},e.getTerrStats=function(e){var t={swamp:"&#128065; &#128737; &#9760;",plains:"&#128065; &#128481;",forest:"&#10006; &#128059;",hills:"&#10006; &#128737;",city:"&#10006; &#128481; &#128587;","frozen swamp":"&#10052; &#128065; &#128737; &#9760;",tundra:"&#10052; &#128065; &#128481;","boreal forest":"&#10052; &#10006; &#128059;",mountain:"&#10052; &#10006; &#128737;","frozen city":"&#10052; &#10006; &#128481; &#128587;"};return t[e]},e.gameMenu=!0,e.currGamePlayers={},e.gameIsReady=!0,e.gameSettingsPanel=0,e.newNew=!0,e.numCountries=20,e.map=null,e.gameId=null,e.canJoin=!0,e.potentialMaps=[],e.loadedMapImg=null,e.user=null,e.pStatShow=!1,e.newMap=function(){var t=101-e.smoothing,o=Math.round(e.numCountries/.3);e.map=r.GetVoronoi(e.win.h,e.win.w,o,t),e.map.init(),e.gameMenu=!1,sandalchest.confirm("Confirm Map","Do you want to accept this map?",function(t){console.log("R FROM MAP CONFIRM",t),t?e.map.save().then(function(t){console.log("ASKING IF NEW GAME"),sandalchest.dialog("Start Game","Do you want to start a new game with this map ("+t.data.id+")?<hr/>Password: <input type='password' id='newGamePwd'> <button class='btn btn-danger' onclick=\"angular.element('body').scope().pwdExpl()\" id='start-new-game-btn'>?</button>",{buttons:[{text:"Create Game",close:!0,click:function(){var r=document.querySelector("#newGamePwd").value;hintMaker(4,function(){n.newGame(t.data.id,e.user,r).then(function(t){e.gameId=t.data.id,socket.emit("getGamePieces",{id:t.data.id}),console.log("Done! Game made!"),e.gameSettingsPanel=2,socket.emit("getGames",{x:!0}),hintMaker(5)})})}},{text:"Cancel",close:!0,click:function(){}}],speed:250}),hintMaker(3)}):(e.map=null,e.gameMenu=!0,e.$digest())})},e.pwdExpl=function(){sandalchest.alert("Protected Games","If you include a password, only players who have that password can join. Leave this blank if you want a public game!",{rotation:-5})},socket.emit("getGames",{x:!0}),e.loadMaps=function(){r.loadMaps().then(function(t){console.log("MAPS",t),e.potentialMaps=t.data})},socket.on("replaceMap",function(){e.loadMaps()}),socket.on("allGames",function(t){e.canJoin=!0,t.forEach(function(t){t.gameId==e.gameId&&(e.canJoin=!1)}),e.canJoin&&(e.gameId=null),console.log("FROM ALL GAMES",t),e.allGames=t,e.loadMaps(),e.$digest()}),socket.on("deadPlayer",function(t){t.player===e.player&&sandalchest.alert("Dead","Sorry, "+e.user+", you've died!",function(t){
e.btns=!1})}),e.armyRightClick=function(e){var t={hills:["&#128737; Defensive bonus - Increased chance for defender to win a conflict","&#10006; No Visibility - Defending army number hidden"],city:["&#128481; Offensive bonus - Increased chance for attacker to win a conflict","&#10006; No Visibility - Defending army numbers hidden","&#128587; Recruiting - Small chance for defender to gain +1 army each turn (max of 10 armies)"],swamp:["&#128737; Defensive bonus - Increased chance for defender to win a conflict","&#128065; Visibility - Defending army numbers known","&#9760; Swamp Gas - Small chance for defender to lose 1 army per turn (may not lose all armies)"],plains:["&#128481; Offensive bonus - Increased chance for attacker to win a conflict","&#128065; Visibility - Defending army numbers known"],forest:["&#10006; No Visibility - Defending army number hidden","&#128059; Animal attacks - Small chance for defender to lose 1 army per turn (may not lose all armies)"],mountain:["&#128737; Defensive bonus - Increased chance for defender to win a conflict","&#10006; No Visibility - Defending army number hidden","&#10052; Cold Weather - Chance for both attacker and defender to lose one army after attack"],"frozen city":["&#128481; Offensive bonus - Increased chance for attacker to win a conflict","&#10006; No Visibility - Defending army numbers hidden","&#128587; Recruiting - Small chance for defender to gain +1 army each turn (max of 10 armies)","&#10052; Cold Weather - Chance for both attacker and defender to lose one army after attack"],"frozen swamp":["&#128737; Defensive bonus - Increased chance for defender to win a conflict","&#128065; Visibility - Defending army numbers known","&#9760; Swamp Gas - Small chance for defender to lose 1 army per turn (may not lose all armies)","&#10052; Cold Weather - Chance for both attacker and defender to lose one army after attack"],tundra:["&#128481; Offensive bonus - Increased chance for attacker to win a conflict","&#128065; Visibility - Defending army numbers known","&#10052; Cold Weather - Chance for both attacker and defender to lose one army after attack"],"boreal forest":["&#10006; No Visibility - Defending army number hidden","&#128059; Animal attacks - Small chance for defender to lose 1 army per turn (may not lose all armies)","&#10052; Cold Weather - Chance for both attacker and defender to lose one army after attack"]};return[[function(){return"<strong>Country:</strong> "+e.country}],[function(){return"<strong>Player:</strong> &#"+e.lbl+"; "+e.usr}],[function(){return"<strong>Number of Armies:</strong> "+e.num}],[function(){return"<strong>Terrain:</strong> "+e.terr}],[function(){var n="<ul>";return t[e.terr].forEach(function(e){n+="<li>"+e+"</li>"}),console.log(n),n+"</ul>"}]]},e.deleteMap=function(e){sandalchest.confirm("Delete Map","Are you sure you want to delete map "+e+"?",function(t){t&&r.delMap(e).then(function(e){"logErr"==e.data})})},e.delGame=function(e){sandalchest.confirm("Delete Game","Are you sure you wanna delete this game? This isn't reversable!",function(t){t&&n.delGame(e).then(function(e){console.log("back from delGame thing"),"wrongUser"==e.data?sandalchest.alert("Hey! You can't delete that game!"):(console.log("REMOVED GAME! REFRESHING DATA"),socket.emit("getGames",{x:!0}))})})},e.pickTarg=!1,e.moveArmies=!0;var i=!1;e.pickCell=function(t){if(e.currPlayer&&e.currPlayer!=e.user)return!0;if(e.addMode&&t.usr==e.user)return sandalchest.dialog({buttons:[{text:"Add em!",close:!0,click:function(){var n=parseInt(document.querySelector("#numNewArms").value);t.num+=n,e.newArmies-=n,e.newArmies?e.$digest():(e.addMode=!1,console.log("emitting to back end, new armies:",e.armyPieces),socket.emit("armiesAdded",{gameId:e.gameId,armies:e.armyPieces}))}},{text:"Cancel",close:!0,click:function(){}}],speed:250},"Add Armies","How many armies do you want to add to "+t.country+"?<br/><input type='number' id='numNewArms' max='"+e.newArmies+"'"),!0;if(e.srcCell&&e.map.diagram.cells[e.srcCell].country==t.country&&t.status>0)return t.status=0,e.srcCell=null,e.targCell=null,e.pickTarg=!1,!0;if(!e.pickTarg&&t.usr==e.user)return e.armyPieces.forEach(function(e){e.status=0}),e.srcCell=e.map.getCellNumByName(t.country),t.status=1,e.targCell=null,e.pickTarg=!0,!0;if(e.moveArmies)if(e.pickTarg&&t.usr==e.user){if(!r.isNeighbor(e.map.diagram.cells,e.srcCell,e.map.getCellNumByName(t.country)))return sandalchest.alert("Uh Oh!","Hey! You can't move armies to "+t.country+" from "+e.map.diagram.cells[e.srcCell].country+"! It's too far away!",{speed:250}),!1;var n=e.getAPByName(e.map.diagram.cells[e.srcCell].country).num;if(n<2)return sandalchest.alert("Uh Oh!","You have too few armies in the source country to move armies (less than two). You cannot desert a country!",{speed:250}),!1;"noRecruit"==t.debuff&&sandalchest.alert("No Recruiting","Low morale in "+t.country+" means you cannot move armies into that country this turn."),sandalchest.dialog({buttons:[{text:"Move em!",close:!0,click:function(){console.log("wanna move",{num:parseInt(document.querySelector("#reqNumMove").value),usr:e.user,src:e.getAPByName(e.map.diagram.cells[e.srcCell].country),targ:t,game:e.gameId}),socket.emit("moveArmies",{num:parseInt(document.querySelector("#reqNumMove").value),usr:e.user,src:e.getAPByName(e.map.diagram.cells[e.srcCell].country),targ:t,game:e.gameId}),e.getAPByName(e.map.diagram.cells[e.srcCell].country).status=0,e.srcCell=null,e.targCell=null,t.status=0,e.pickTarg=!1}},{text:"Cancel",close:!0,click:function(){e.getAPByName(e.map.diagram.cells[e.srcCell].country).status=0,e.srcCell=null,e.targCell=null,t.status=0,e.pickTarg=!1}}],speed:250},"Army Movement","How many armies do you want to move from "+e.map.diagram.cells[e.srcCell].country+" to "+t.country+"? You can move a maximum of "+n+" armies. <br/> <input type=\"number\" id=\"reqNumMove\" value='1' min='1' max='"+n+"'>")}else e.pickTarg&&t.usr!=e.user&&sandalchest.alert("Uh Oh!",t.country+" is currently occupied by another player. You'll need to conquer it first to move your armies there!");else if(e.pickTarg&&(t.usr!=e.user||i)){if(!r.isNeighbor(e.map.diagram.cells,e.srcCell,e.map.getCellNumByName(t.country)))return sandalchest.alert("Uh Oh!","Hey! You can't attack "+t.country+" from "+e.map.diagram.cells[e.srcCell].country+"! It's too far away!",{speed:250}),!1;e.targCell=e.map.getCellNumByName(t.country),t.status=2,e.pickTarg=!1}else e.pickTarg&&t.usr==e.user&&sandalchest.alert("Uh Oh!","Hey! You can't attack yourself at "+t.country+"!",{speed:250})},e.joinGame=function(t,r){n.joinGame(t,e.user,r).then(function(e){return"gameLogErr"==e.data?(sandalchest.alert("Join Error","This game's private, and you've unfortunately entered the wrong password!"),!1):void window.location.reload()})},e.neighborTest=function(t,n){console.log("tested cells are neighbors: ",r.isNeighbor(e.map.diagram.cells,t,n))},e.switchPlayMode=function(){sandalchest.confirm("Switch Modes","Are you sure you wanna stop moving armies and begin the attack phase?",function(t){t&&null!==t&&(e.moveArmies=!1,e.$digest(),hintMaker(9))})},e.checkMenuHint=function(){hintMaker(6)},e.pickMap=function(t,o,a){console.log("pikmap data",t,o,a),e.map=r.GetVoronoi(t.bbox.yb,t.bbox.xr,t.countryNames.length,20);for(var i in t)e.map[i]=t[i];e.map.initLoad(t.img),e.gameMenu=!1,a?(socket.emit("putInRoom",{id:e.gameId}),e.armyPieces=[]):(sandalchest.dialog("New Game","Making a new game!<hr/> Password (optional): <input type='password' id='newGamePwd'> <button class='btn btn-danger' onclick=\"angular.element('body').scope().pwdExpl()\">?</button>",{buttons:[{text:"Create Game",close:!0,click:function(){var t=document.querySelector("#newGamePwd").value;hintMaker(4,function(){n.newGame(o,e.user,t).then(function(t){e.gameId=t.data.id,socket.emit("getGamePieces",{id:t.data.id}),console.log("Done! Game made!"),e.gameSettingsPanel=2,socket.emit("getGames",{x:!0}),hintMaker(5)})}),e.armyPieces=[]}},{text:"Cancel",close:!0,click:function(){}}],speed:250}),hintMaker(3))},e.getPStats=function(t,n,r){e.playerStats=[];for(var o=0,a=0;a<n.length;a++){for(var i=360*a/n.length,s={num:0,h:i,name:"&#"+r[a]+"; "+n[a],numPerc:0},l=0;l<t.length;l++)t[l].user==n[a]&&(o++,s.num++);e.playerStats.push(s)}for(var c=0;c<e.playerStats.length;c++)e.playerStats[c].numPerc=100*e.playerStats[c].num/o;console.log("PLAYER STATS:",e.playerStats,"TOTAL",o)},socket.on("updateArmies",function(t){console.log("UPDATE ARMIES",t),t.players.forEach(function(n,r){e.currGamePlayers[n]=t.avas[r]}),e.armyPieces=n.placeArmies(e.map,t.armies,e.currGamePlayers),e.currPlayer=t.players[t.turn],e.getPStats(t.armies,t.players,t.avas),e.$digest()}),socket.on("gameReady",function(t){e.gameIsReady=!0,socket.emit("getGamePieces",t),console.log("AT GAMEREADY, D IS",t)}),e.toggleNewMode=function(t){e.newNew=t>0,e.newNew||e.loadMaps()},e.startGame=function(e){sandalchest.confirm("Start Game "+e,"Are you sure you wanna start game "+e+"? Starting a game is not reversable, and prevents any more players from joining.",function(t){t&&n.startGame(e).then(function(e){socket.emit("gameStarted",e),window.location.reload()})})},socket.on("putInGame",function(t){console.log("PUT IN GAME",t),t.data.players.indexOf(e.user)>-1&&socket.emit("putInRoom",t.data)}),e.avgCounInfo=function(){sandalchest.alert("Country Number","Because of how the map is generated, the actual number of countries may or may not be exactly the number here.")},e.smoothInfo=function(){sandalchest.alert("Map Smoothing",'Without smoothing, the shapes generated by the map algorithm (a <a href="https://en.wikipedia.org/wiki/Voronoi_diagram" target="_blank">Voronoi Diagram</a>) are very random. Smoothing \'pushes\' the shapes towards being equal size.')},e.doAttack=function(t,o,a){for(var i=null,s=e.map.diagram.cells[o].name,l=0;l<e.armyPieces.length;l++)if(e.armyPieces[l].country==s){i=e.armyPieces[l].num<3?e.armyPieces[l].num:2;break}i>a&&(a=i),r.isNeighbor(e.map.diagram.cells,t,o)&&(n.doFight(e.user,e.getAPByName(e.map.diagram.cells[t].name),e.getAPByName(e.map.diagram.cells[o].name),a,i,e.gameId),e.srcCell=null,e.targCell=null)},e.getAPByName=function(t){for(var n=0;n<e.armyPieces.length;n++)if(e.armyPieces[n].country==t)return e.armyPieces[n];return!1},e.startAttack=function(){if(console.log("SOURCE CELL",e.map.diagram.cells[e.srcCell]),!e.srcCell&&0!==e.srcCell||!e.targCell&&0!==e.targCell)sandalchest.alert("Attack Issue","You need both an attacker and a target!");else if("noAttack"==e.getAPByName(e.map.diagram.cells[e.srcCell].name).debuff)sandalchest.alert("Can't Attack","Due to a natural disaster, your armies in "+e.map.diagram.cells[e.srcCell].name+" are in disarray! You can't attack from there this turn.");else if(e.getAPByName(e.map.diagram.cells[e.srcCell].name)&&e.getAPByName(e.map.diagram.cells[e.srcCell].name).num<2)sandalchest.alert("Not Enough Armies","You can't attack from "+e.map.diagram.cells[e.srcCell].name+"! Attacking countries need at least two armies: One to attack, and one to stay home!");else{var t=e.getAPByName(e.map.diagram.cells[e.srcCell].name).num<5?e.getAPByName(e.map.diagram.cells[e.srcCell].name).num-1:3;sandalchest.prompt("Army Strength","How many armies do you wanna attack with? You can attack with at most "+t+" armies.",function(t){return t=parseInt(t),!isNaN(t)&&0!==t&&(console.log(e.map.diagram.cells[e.srcCell].name,"attacking",e.map.diagram.cells[e.targCell].name,"with",t,"armies."),void e.doAttack(e.srcCell,e.targCell,t))}),hintMaker(10)}},socket.on("rcvDoFight",function(t){var n=e.getAPByName(t.cd.country),r=e.getAPByName(t.ca.country),o=["usr","lbl","num"];t.status&&(t.cd.usr=t.ca.usr,socket.emit("getGamePieces",{id:e.gameId})),console.log("from rcvDoFight, we get",t,n,r),o.forEach(function(e){n[e]=t.cd[e],r[e]=t.ca[e]}),e.$apply()}),e.nextTurn=function(){sandalchest.confirm("End Turn","Are you sure you want to end your turn?",function(t){t&&null!==t&&n.nextTurn(e.map,e.gameId,e.user)})},socket.on("turnSwitch",function(t){if(e.currPlayer=t.usr,t.usr==e.user&&(e.newArmies=t.newA,e.addMode=!0,sandalchest.alert("new armies:",t.newA.toString())),console.log("turnSwitch data:",t),t.dis.length){var n="<li>"+t.dis.join("</li><li>")+"</li>";sandalchest.alert("Disaster has struck!","<ul>"+n+"</ul>");var r=0;e.armyPieces=e.armyPieces.map(function(e){for(r=0;r<t.armies.length;r++)if(t.armies[r].country==e.country)return e.num=t.armies[r].num,e.terr=t.armies[r].terr,e;return e})}e.$digest()})}]),app.controller("statCon",["$scope","miscFact",function(e,t){e.pStats=[],document.querySelector("#stat-main").onclick=function(e){e.stopPropagation()},e.getScores=function(){t.getAllUsers().then(function(t){t=t.sort(function(e,t){return t.totalScore-e.totalScore}),console.log("Users:",t);var n=1,r=t[0].totalScore,o=[];t.forEach(function(t){t.totalScore<r&&(e.pStats.push({names:o.join(","),place:n,score:r}),o=[],n++,r=t.totalScore),o.push(t.name)}),e.pStats.push({names:o.join(", "),place:n,score:r})})},socket.on("newScores",function(t){e.getScore()}),e.getScores()}]),app.factory("fightFact",["$rootScope","$http",function(e,t){var n=function(e,t){console.log("Getting cell coords for",t);for(var n=0;n<e.length;n++)if(e[n].name==t)return e[n].site;return!1};return{getMaxArmy:function(e,t){var n=t?1:0;return Math.floor(e.army.num-n)},delGame:function(e){return t.get("/game/del/"+e).then(function(e){return console.log("factory back from back end game del"),e})},doFight:function(e,t,n,r,o,a){socket.emit("sendDoFight",{user:e,ca:t,cd:n,ra:r,rd:o,gameId:a})},nextTurn:function(e,t,n){console.log("in fightfact, next turn",e,t,n,e.getContinents()),socket.emit("nextTurn",{conts:e.getContinents(),game:t,usr:n})},newGame:function(e,n,r){return t.post("/game/new",{id:e,player:n,pwd:r}).then(function(e){return e})},placeArmies:function(e,t,r){for(var o=[],a=0;a<t.length;a++){var i=n(e.diagram.cells,t[a].country),s=1.2*document.querySelector("canvas").getContext("2d").measureText(t[a].country).width,l={country:t[a].country,num:t[a].num,lbl:r[t[a].user],usr:t[a].user,x:i.x-s/2-8,y:i.y,fullName:t[a].user+" - "+t[a].country+" - "+t[a].num+(t[a].num>1?" armies":" army"),hideName:t[a].user+" - "+t[a].country+" - Unknown armies",wid:s,terr:t[a].terr,status:0};o.push(l)}return o},joinGame:function(e,n,r){return t.post("/game/join",{gameId:e,player:n,pwd:r},function(e){return e})},addArmies:function(e){socket.emit("sendAddArmies",{game:e})},saveGame:function(e,n){if(e){var r={gameId:e,armies:[],mapId:n.id};return n.diagram.cells.forEach(function(e,t){e.name&&r.armies.push({user:e.army.usr,country:e.name,num:e.army.num})}),t.post("/game/saveGame",r)}sandalchest.alert("Map save error: no map id!",function(){return!1})},startGame:function(e){return t.get("/game/startGame/"+e).then(function(e){return e})}}}]),app.factory("mapFact",["$rootScope","$http","$q",function(e,t,n){String.prototype.capit=function(){return this.slice(0,1).toUpperCase()+this.slice(1)};var r=[["b","c","d","f","g","h","i","j","k","l","m","n","p","q","r","s","t","v","w","x","y","z","","","","",""],["a","e","i","o","u"],["br","cr","dr","fr","gr","pr","str","tr","bl","cl","fl","gl","pl","sl","sc","sk","sm","sn","sp","st","sw","ch","sh","th","wh"],["ae","ai","ao","au","a","ay","ea","ei","eo","eu","e","ey","ua","ue","ui","uo","u","uy","ia","ie","iu","io","iy","oa","oe","ou","oi","o","oy"],["stan","dor","vania","nia","lor","cor","dal","bar","sal","ra","la","lia","jan","rus","ze","tan","wana","sil","so","na","le","bia","ca","ji","ce","ton","ssau","sau","sia","ca","ya","ye","yae","tho","stein","ria","nia","burg","nia","gro","que","gua","qua","rhiel","cia","les","dan","nga","land"],["ia","a","en","ar","istan","aria","ington","ua","ijan","ain","ium","us","esh","os","ana","il","ad","or","ea","eau","ax","on","ana","ary","ya","ye","yae","ait","ein","urg","al","ines","ela"]],o=["Republic of","Kingdom of","Empire of","United Lands of","Dominion of","Holy empire of"],a={warm:["city","swamp","forest","plains","hills"],cold:["frozen city","frozen swamp","boreal forest","tundra","mountain"]},i=[],s=[];return allConts=[],justCouns=[],{loadMaps:function(){return t.get("/map/loadMaps").then(function(e){return e})},loadOneMap:function(e){return console.log("attempting to get map",e),t.get("/map/loadMap/"+e).then(function(e){return e})},isBorderNeighbor:function(e,t,n){if(!e[t]||!e[n])throw new Error("cells not found!");console.log("Cells",e,"source cell",e[t],"target",e[n]);for(var r=0;r<e[t].halfedges.length;r++)if(e[t].halfedges[r].edge.lSite&&e[t].halfedges[r].edge.rSite&&(e[t].halfedges[r].edge.lSite.x==e[n].site.x&&e[t].halfedges[r].edge.lSite.y==e[n].site.y||e[t].halfedges[r].edge.rSite.x==e[n].site.x&&e[t].halfedges[r].edge.rSite.y==e[n].site.y))return!0;return!1},isWater:function(e,t,n){for(var r=0;r<e.length;r++)if(e[r].site.x==t&&e[r].site.y==n&&!e[r].isLand)return r;return!1},isNeighbor:function(e,t,n){if(!e[t]||!e[n])throw new Error("cells not found!");for(var r={x:e[t].site.x,y:e[t].site.y},o={x:null,y:null},a=[],i=0;i<e[t].halfedges.length;i++)if(e[t].halfedges[i].edge.lSite&&e[t].halfedges[i].edge.rSite){if(e[t].halfedges[i].edge.lSite.x==r.x&&e[t].halfedges[i].edge.lSite.y==r.y?(o.x=e[t].halfedges[i].edge.rSite.x,o.y=e[t].halfedges[i].edge.rSite.y):(o.x=e[t].halfedges[i].edge.lSite.x,o.y=e[t].halfedges[i].edge.lSite.y),o.x==e[n].site.x&&o.y==e[n].site.y)return!0;a.push(this.isWater(e,o.x,o.y))}for(i=0;i<a.length;i++)if(a[i]||0===a[i]){r.x=e[a[i]].site.x,r.y=e[a[i]].site.y;for(var s=0;s<e[a[i]].halfedges.length;s++)if(e[a[i]].halfedges[s].edge.lSite&&e[a[i]].halfedges[s].edge.rSite&&(e[a[i]].halfedges[s].edge.lSite.x==r.x&&e[a[i]].halfedges[s].edge.lSite.y==r.y?(o.x=e[a[i]].halfedges[s].edge.rSite.x,o.y=e[a[i]].halfedges[s].edge.rSite.y):(o.x=e[a[i]].halfedges[s].edge.lSite.x,o.y=e[a[i]].halfedges[s].edge.lSite.y),o.x==e[n].site.x&&o.y==e[n].site.y))return!0}return!1},delMap:function(e){return t.delete("/map/del/"+e,function(e){return e})},GetVoronoi:function(e,n,l,c){var h={voronoi:new Voronoi,diagram:null,margin:.1,canvas:null,bbox:{xl:0,xr:n,yt:0,yb:e},sites:[],countryNames:[],cellCenters:[],timeoutDelay:30,numsRelaxed:100,init:function(){this.canvas=document.querySelector("canvas"),this.clearMap(),this.randomSites(l,!0)},save:function(){var e={countryNames:this.countryNames,bbox:this.bbox,sites:this.sites,numsRelaxed:this.numsRelaxed,diagram:this.diagram,doneCouns:i,currCont:s,cellCenters:this.cellCenters,img:this.canvas.toDataURL()};return console.log("TO SAVE:",e),t.post("/map/newMap",e).then(function(e){return e})},clearSites:function(){this.compute([])},randomSites:function(e,t){var n=[];t||(n=this.sites.slice(0));for(var r=this.canvas.width*this.margin,o=this.canvas.height*this.margin,a=r,i=this.canvas.width-2*r,s=o,l=this.canvas.height-2*o,c=0;c<e;c++)n.push({x:self.Math.round(10*(a+self.Math.random()*i))/10,y:self.Math.round(10*(s+self.Math.random()*l))/10});this.compute(n),this.timeout&&(clearTimeout(this.timeout),this.timeout=null);var h=this;this.timeout=setTimeout(function(){h.relaxSites()},this.timeoutDelay)},relaxSites:function(){if(this.diagram){for(var e,t,n,r,o=this.diagram.cells,a=o.length,i=[],s=!1,h=1/a*.1;a--;)e=o[a],n=Math.random(),n<h||(t=this.cellCentroid(e),r=this.distance(t,e.site),this.numsRelaxed-=1/(l/c),s=this.numsRelaxed>0,r>2&&(t.x=(t.x+e.site.x)/2,t.y=(t.y+e.site.y)/2),n>1-h&&(r/=2,i.push({x:t.x+(t.x-e.site.x)/r,y:t.y+(t.y-e.site.y)/r})),i.push(t));if(this.compute(i),s){var u=this;this.timeout=setTimeout(function(){u.relaxSites()},this.timeoutDelay)}else this.render()}},doCellSites:function(){var e=this;this.diagram.cells.forEach(function(t){(t.name||t.country)&&e.cellCenters.push({x:t.site.x,y:t.site.y,name:t.name||t.country,terr:t.terrType||"plains"})})},initLoad:function(e){this.canvas=document.querySelector("canvas"),this.clearMap(),this.getCellNames();var t=this.canvas.getContext("2d"),n=new Image,r=this.canvas;n.onload=function(){r.width=n.width,r.height=n.height,t.drawImage(n,0,0)},n.src=e},makeAName:function(){var e="",t=Math.floor(5*Math.random());switch(t){case 0:e=r[0][Math.floor(Math.random()*r[0].length)]+r[1][Math.floor(Math.random()*r[1].length)]+r[2][Math.floor(Math.random()*r[2].length)]+r[3][Math.floor(Math.random()*r[3].length)]+r[4][Math.floor(Math.random()*r[4].length)];break;case 1:e=r[0][Math.floor(Math.random()*r[0].length)]+r[1][Math.floor(Math.random()*r[1].length)]+r[2][Math.floor(Math.random()*r[2].length)]+r[5][Math.floor(Math.random()*r[5].length)];break;case 2:e=r[2][Math.floor(Math.random()*r[2].length)]+r[3][Math.floor(Math.random()*r[3].length)]+r[4][Math.floor(Math.random()*r[4].length)];break;case 3:e=r[1][Math.floor(Math.random()*r[1].length)]+r[2][Math.floor(Math.random()*r[2].length)]+r[5][Math.floor(Math.random()*r[5].length)];break;default:e=r[2][Math.floor(Math.random()*r[2].length)]+r[3][Math.floor(Math.random()*r[3].length)]+r[0][Math.floor(Math.random()*r[0].length)]+r[2][Math.floor(Math.random()*r[2].length)]+r[5][Math.floor(Math.random()*r[5].length)]}return e},makeCellNames:function(){console.log("CELL LENGTH",this.diagram.cells.length);for(var e=0;e<this.diagram.cells.length;e++){var t=this.diagram.cells[e],n=null;if(t.isLand){for(var r=!1;!r;)n=this.makeAName().capit(),Math.random()>.7&&(n=o[Math.floor(Math.random()*o.length)]+" "+n),r=this.countryNames.indexOf(n)<0,t.name=n;this.countryNames.push(n),console.log("Cell",n,"has terrain",t.terrType)}}},distance:function(e,t){var n=e.x-t.x,r=e.y-t.y;return Math.sqrt(n*n+r*r)},cellArea:function(e){for(var t,n,r,o=0,a=e.halfedges,i=a.length;i--;)t=a[i],n=this.getStartpoint(t),r=this.getEndpoint(t),o+=n.x*r.y,o-=n.y*r.x;return o/=2},cellCentroid:function(e){for(var t,n,r,o,a=0,i=0,s=e.halfedges,l=s.length;l--;)t=s[l],r=this.getStartpoint(t),o=this.getEndpoint(t),n=r.x*o.y-o.x*r.y,a+=(r.x+o.x)*n,i+=(r.y+o.y)*n;return n=6*this.cellArea(e),{x:a/n,y:i/n}},compute:function(e){this.sites=e,this.voronoi.recycle(this.diagram),this.diagram=this.voronoi.compute(e,this.bbox);for(var t=0;t<this.diagram.cells.length;t++)if(Math.random()>.7){this.diagram.cells[t].isLand=!0;var n=Math.abs(this.diagram.cells[t].site.y/this.canvas.height-.5)>.25&&Math.abs(this.diagram.cells[t].site.y/this.canvas.height-.5)-.25>Math.random()/4;console.log("CELL",t,"FROZEN?",n),n?this.diagram.cells[t].terrType=a.cold[Math.floor(Math.random()*a.cold.length)]:this.diagram.cells[t].terrType=a.warm[Math.floor(Math.random()*a.warm.length)]}else this.diagram.cells[t].terrType="water",this.diagram.cells[t].isLand=!1},clearMap:function(){var e=this.canvas.getContext("2d");e.globalAlpha=1,e.rect(0,0,this.canvas.width,this.canvas.height),e.fillStyle="white",e.fill()},render:function(){var e=this.canvas.getContext("2d"),t=new Image,n=this;t.src="../img/water.jpg",t.onload=function(){if(e.rect(0,0,n.canvas.width,n.canvas.height),e.fillStyle=e.createPattern(this,"repeat"),e.fill(),e.globalAlpha=1,e.beginPath(),e.strokeStyle="#888",e.stroke(),n.diagram){e.lineWidth=2;for(var t,r,o=n.diagram.edges,a=o.length;a--;)e.beginPath(),t=o[a],e.strokeStyle="#003259",r=t.va,e.moveTo(r.x,r.y),r=t.vb,e.lineTo(r.x,r.y),e.stroke();n.doAllCells()}}},getCellNames:function(){for(var e=this.canvas.getContext("2d"),t=0;t<this.diagram.cells.length;t++){var n=this.diagram.cells[t];if(n.name&&n.isLand){console.log("creating country ",n.name);var r=e.measureText(n.name).width+4;e.fillStyle="#fed",e.fillRect(Math.floor(n.site.x-r/2-2),Math.floor(n.site.y-13),r,13),e.fillStyle="#000",e.font="12px Arial",e.fillText(n.name,n.site.x-r/2,n.site.y-2),n.country=n.name}n.army={num:0,usr:null}}},findCell:function(e,t){for(var n=0;n<this.diagram.cells.length;n++)if(this.diagram.cells[n].site.x==e&&this.diagram.cells[n].site.y==t)return this.diagram.cells[n];return!1},buildTreemap:function(){for(var e=new QuadTree({x:this.bbox.xl,y:this.bbox.yt,width:this.bbox.xr-this.bbox.xl,height:this.bbox.yb-this.bbox.yt}),t=this.diagram.cells,n=t.length;n--;)bbox=t[n].getBbox(),bbox.cellid=n,e.insert(bbox);return e},pointIntersection:function(e,t,n){for(var r,o,a,i,s=e.halfedges,l=s.length;l--;){if(r=s[l],o=this.getStartpoint(r),a=this.getEndpoint(r),i=(n-o.y)*(a.x-o.x)-(t-o.x)*(a.y-o.y),!i)return 0;if(i>0)return-1}return 1},getStartpoint:function(e){return e.edge.lSite===e.site?e.edge.va:e.edge.vb},getEndpoint:function(e){return e.edge.lSite===e.site?e.edge.vb:e.edge.va},cellIdFromPoint:function(e,t){this.treemap=this.buildTreemap(),console.log("Treez",this.treemap);var n,r,o=this.treemap.retrieve({x:e,y:t}),a=o.length,i=this.diagram.cells;for(this.diagram.cells.length;a--;)if(r=o[a].cellid,n=i[r],this.pointIntersection(n,e,t)>0)return r},cellByPoint:function(e,t){for(var n,r=this.diagram.cells,o=this.diagram.cells.length;--o;)if(n=r[o],this.pointIntersection(n,e,t)>0)return o},renderCell:function(e,t){if(void 0!==e&&this.diagram){var n=this.diagram.cells[e];if(n){var r=this.canvas.getContext("2d");console.log("RENDERING CELL",e,"FOR CONTEXT",r,"WITH PATTERN",t),r.globalAlpha=1,r.beginPath();var o=n.halfedges,a=o.length,i=this.getStartpoint(o[0]);r.moveTo(i.x,i.y);for(var s=0;s<a;s++)i=this.getEndpoint(o[s]),r.lineTo(i.x,i.y);r.fillStyle=t,r.strokeStyle="#AB9B69",r.fill(),r.stroke(),i=n.site,r.fillStyle="#44f",r.beginPath(),r.rect(i.x-2/3,i.y-2/3,2,2),r.fill()}}},doAllCells:function(){for(var e=a.warm.concat(a.cold),t=[],n=this,r=this.canvas.getContext("2d"),o=0,i=0;i<e.length;i++)t[i]=new Image,t[i].src="../img/terrains/"+e[i].replace(/\s/,"_")+".jpg",t[i].onload=function(){for(var t=r.createPattern(this,"repeat"),a=this.src.slice(this.src.lastIndexOf("/")+1,this.src.lastIndexOf(".")).replace("_"," ")||"plains",i=0;i<n.diagram.cells.length;i++)n.diagram.cells[i].isLand&&n.diagram.cells[i].terrType==a&&n.renderCell(i,t);o++,console.log("IMAGES DONE:",o,"of",e.length),o==e.length&&(n.makeCellNames(),n.getCellNames(),n.doCellSites())}},getCellByName:function(e){for(var t=0;t<this.diagram.cells.length;t++)if(this.diagram.cells[t].name==e)return this.diagram.cells[t];return!1},getCellNumByName:function(e){for(var t=0;t<this.diagram.cells.length;t++)if(this.diagram.cells[t].name==e)return t;return!1},getContinents:function(){i=[],allConts=[],justCouns=this.diagram.cells.filter(function(e){return!!e.name}),console.log("num countries",justCouns.length);for(var e=0;e<justCouns.length;e++)justCouns[e].name&&i.indexOf(justCouns[e].name)<0&&(this.findNeighbors(e,!0),allConts.push(s));console.log("Countries:",i);var t=[];return allConts.forEach(function(e){var n=[];e.forEach(function(e){n.indexOf(e)<0&&n.push(e)}),t.push(n)}),t},findNeighbors:function(e,t){var n=this;t&&(s=[]),t=!1,s.push(justCouns[e].name),console.log("pushing",justCouns[e].name,"into array!"),i.push(justCouns[e].name);for(var r=[],o=0;o<justCouns.length;o++)if(justCouns[o].name&&o!=e&&i.indexOf(justCouns[o].name)<0)for(var a=justCouns[e].site.x,l=justCouns[e].site.y,c=0;c<justCouns[e].halfedges.length;c++)justCouns[e].halfedges[c].edge.rSite&&justCouns[e].halfedges[c].edge.lSite&&(justCouns[e].halfedges[c].edge.rSite.x==a&&justCouns[e].halfedges[c].edge.rSite.y==l?justCouns[e].halfedges[c].edge.lSite.x==justCouns[o].site.x&&justCouns[e].halfedges[c].edge.lSite.y==justCouns[o].site.y&&(console.log(justCouns[o].name,"is a neighbor of",justCouns[e].name),r.push(o)):justCouns[e].halfedges[c].edge.rSite.x==justCouns[o].site.x&&justCouns[e].halfedges[c].edge.rSite.y==justCouns[o].site.y&&(console.log(justCouns[o].name,"is a neighbor of",justCouns[e].name),r.push(o)));r.forEach(function(e){n.findNeighbors(e)})},findNeighborsOld:function(e,t){t&&(s&&s.length&&allConts.push(s),s=[]);var n=[this.diagram.cells[e].name];if(console.log("for cell",e,"names starts as",n),this.diagram.cells[e].name){if(this.indexOf(this.diagram.cells[e].name)>-1)return console.log("cell",this.diagram.cells[e].name,"already doneCouns"),n;this.push(this.diagram.cells[e].name),s.push(this.diagram.cells[e].name);for(var r=[],o=0;o<this.diagram.cells[e].halfedges.length;o++)if(this.diagram.cells[e].halfedges[o].edge.rSite&&this.diagram.cells[e].halfedges[o].edge.lSite){var a=this.cellByPoint(this.diagram.cells[e].halfedges[o].edge.rSite.x,this.diagram.cells[e].halfedges[o].edge.rSite.y);this.diagram.cells[a]&&this.diagram.cells[e].name==this.diagram.cells[a].name&&(a=this.cellByPoint(this.diagram.cells[e].halfedges[o].edge.lSite.x,this.diagram.cells[e].halfedges[o].edge.lSite.y)),"undefined"!=typeof a&&this.diagram.cells[a]&&this.diagram.cells[a].name&&this.doneCouns.indexOf(this.diagram.cells[a].name)==-1&&r.push(a)}r.length?console.log("cell",e,'has neighbors ("kids")',r):console.log("cell",e,"has NO kids");var i=this;return r.forEach(function(e){var t=i.findNeighbors(e);t.forEach(function(e){i.doneCouns.indexOf(e)==-1&&n.push(e)})}),n}},findNaybz:function(e,t){return findNeighbors(e,t)}};return h}}}]),app.factory("miscFact",["$rootScope","$http",function(e,t){return{getUsr:function(){return t.get("/user/currUsrData").then(function(e){return e})},chkLoggedStatus:function(){return t.get("/user/chkLog").then(function(e){return e})},checkUnDup:function(e){return t.get("/user/nameOkay/"+e).then(function(e){return e})},regNewUsr:function(e,n){return t.post("/user/new",{user:e,password:n}).then(function(e){return e})},login:function(e,n){return t.post("/user/login",{user:e,password:n}).then(function(e){return e})},logout:function(e,n){return t.get("/user/logout",{user:e,password:n}).then(function(e){return e})},checkInGame:function(e){return t.get("/user/checkInGame/"+e).then(function(e){return e})},getAllUsers:function(){return t.get("/user/allUsers/").then(function(e){return e.data})}}}]),app.factory("socket",["$rootScope",function(e){console.log("socket factory!");var t=io.connect();return console.log("socket factory!"),{on:function(n,r){t.on(n,function(){var n=arguments;e.$apply(function(){r.apply(t,n)})})},emit:function(n,r,o){t.emit(n,r,function(){var n=arguments;e.$apply(function(){o&&o.apply(t,n)})})}}}]);