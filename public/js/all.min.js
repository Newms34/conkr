function Voronoi(){this.vertices=null,this.edges=null,this.cells=null,this.toRecycle=null,this.beachsectionJunkyard=[],this.circleEventJunkyard=[],this.vertexJunkyard=[],this.edgeJunkyard=[],this.cellJunkyard=[]}!function(window){"use strict";function QuadTree(bounds,pointQuad,maxDepth,maxChildren){var node;node=pointQuad?new Node(bounds,0,maxDepth,maxChildren):new BoundsNode(bounds,0,maxDepth,maxChildren),this.root=node}function Node(bounds,depth,maxDepth,maxChildren){this._bounds=bounds,this.children=[],this.nodes=[],maxChildren&&(this._maxChildren=maxChildren),maxDepth&&(this._maxDepth=maxDepth),depth&&(this._depth=depth)}function BoundsNode(bounds,depth,maxChildren,maxDepth){Node.call(this,bounds,depth,maxChildren,maxDepth),this._stuckChildren=[]}QuadTree.prototype.root=null,QuadTree.prototype.insert=function(item){if(item instanceof Array){var i,len=item.length;for(i=0;i<len;i++)this.root.insert(item[i])}else this.root.insert(item)},QuadTree.prototype.clear=function(){this.root.clear()},QuadTree.prototype.retrieve=function(item){var out=this.root.retrieve(item).slice(0);return out},Node.prototype.nodes=null,Node.prototype._classConstructor=Node,Node.prototype.children=null,Node.prototype._bounds=null,Node.prototype._depth=0,Node.prototype._maxChildren=4,Node.prototype._maxDepth=4,Node.TOP_LEFT=0,Node.TOP_RIGHT=1,Node.BOTTOM_LEFT=2,Node.BOTTOM_RIGHT=3,Node.prototype.insert=function(item){if(this.nodes.length){var index=this._findIndex(item);return void this.nodes[index].insert(item)}this.children.push(item);var len=this.children.length;if(!(this._depth>=this._maxDepth)&&len>this._maxChildren){this.subdivide();var i;for(i=0;i<len;i++)this.insert(this.children[i]);this.children.length=0}},Node.prototype.retrieve=function(item){if(this.nodes.length){var index=this._findIndex(item);return this.nodes[index].retrieve(item)}return this.children},Node.prototype._findIndex=function(item){var b=this._bounds,left=!(item.x>b.x+b.width/2),top=!(item.y>b.y+b.height/2),index=Node.TOP_LEFT;return left?top||(index=Node.BOTTOM_LEFT):index=top?Node.TOP_RIGHT:Node.BOTTOM_RIGHT,index},Node.prototype.subdivide=function(){var depth=this._depth+1,bx=this._bounds.x,by=this._bounds.y,b_w_h=this._bounds.width/2,b_h_h=this._bounds.height/2,bx_b_w_h=bx+b_w_h,by_b_h_h=by+b_h_h;this.nodes[Node.TOP_LEFT]=new this._classConstructor({x:bx,y:by,width:b_w_h,height:b_h_h},depth,this._maxDepth,this._maxChildren),this.nodes[Node.TOP_RIGHT]=new this._classConstructor({x:bx_b_w_h,y:by,width:b_w_h,height:b_h_h},depth,this._maxDepth,this._maxChildren),this.nodes[Node.BOTTOM_LEFT]=new this._classConstructor({x:bx,y:by_b_h_h,width:b_w_h,height:b_h_h},depth,this._maxDepth,this._maxChildren),this.nodes[Node.BOTTOM_RIGHT]=new this._classConstructor({x:bx_b_w_h,y:by_b_h_h,width:b_w_h,height:b_h_h},depth,this._maxDepth,this._maxChildren)},Node.prototype.clear=function(){this.children.length=0;var i,len=this.nodes.length;for(i=0;i<len;i++)this.nodes[i].clear();this.nodes.length=0},BoundsNode.prototype=new Node,BoundsNode.prototype._classConstructor=BoundsNode,BoundsNode.prototype._stuckChildren=null,BoundsNode.prototype._out=[],BoundsNode.prototype.insert=function(item){if(this.nodes.length){var index=this._findIndex(item),node=this.nodes[index];return void(item.x>=node._bounds.x&&item.x+item.width<=node._bounds.x+node._bounds.width&&item.y>=node._bounds.y&&item.y+item.height<=node._bounds.y+node._bounds.height?this.nodes[index].insert(item):this._stuckChildren.push(item))}this.children.push(item);var len=this.children.length;if(!(this._depth>=this._maxDepth)&&len>this._maxChildren){this.subdivide();var i;for(i=0;i<len;i++)this.insert(this.children[i]);this.children.length=0}},BoundsNode.prototype.getChildren=function(){return this.children.concat(this._stuckChildren)},BoundsNode.prototype.retrieve=function(item){var out=this._out;if(out.length=0,this.nodes.length){var index=this._findIndex(item),node=this.nodes[index];item.x>=node._bounds.x&&item.x+item.width<=node._bounds.x+node._bounds.width&&item.y>=node._bounds.y&&item.y+item.height<=node._bounds.y+node._bounds.height?out.push.apply(out,this.nodes[index].retrieve(item)):(item.x<=this.nodes[Node.TOP_RIGHT]._bounds.x&&(item.y<=this.nodes[Node.BOTTOM_LEFT]._bounds.y&&out.push.apply(out,this.nodes[Node.TOP_LEFT].getAllContent()),item.y+item.height>this.nodes[Node.BOTTOM_LEFT]._bounds.y&&out.push.apply(out,this.nodes[Node.BOTTOM_LEFT].getAllContent())),item.x+item.width>this.nodes[Node.TOP_RIGHT]._bounds.x&&(item.y<=this.nodes[Node.BOTTOM_RIGHT]._bounds.y&&out.push.apply(out,this.nodes[Node.TOP_RIGHT].getAllContent()),item.y+item.height>this.nodes[Node.BOTTOM_RIGHT]._bounds.y&&out.push.apply(out,this.nodes[Node.BOTTOM_RIGHT].getAllContent())))}return out.push.apply(out,this._stuckChildren),out.push.apply(out,this.children),out},BoundsNode.prototype.getAllContent=function(){var out=this._out;if(this.nodes.length){var i;for(i=0;i<this.nodes.length;i++)this.nodes[i].getAllContent()}return out.push.apply(out,this._stuckChildren),out.push.apply(out,this.children),out},BoundsNode.prototype.clear=function(){this._stuckChildren.length=0,this.children.length=0;var len=this.nodes.length;if(len){var i;for(i=0;i<len;i++)this.nodes[i].clear();this.nodes.length=0}},window.QuadTree=QuadTree}(window),Voronoi.prototype.reset=function(){if(this.beachline||(this.beachline=new this.RBTree),this.beachline.root)for(var beachsection=this.beachline.getFirst(this.beachline.root);beachsection;)this.beachsectionJunkyard.push(beachsection),beachsection=beachsection.rbNext;this.beachline.root=null,this.circleEvents||(this.circleEvents=new this.RBTree),this.circleEvents.root=this.firstCircleEvent=null,this.vertices=[],this.edges=[],this.cells=[]},Voronoi.prototype.sqrt=Math.sqrt,Voronoi.prototype.abs=Math.abs,Voronoi.prototype.EPSILON=1e-9,Voronoi.prototype.equalWithEpsilon=function(a,b){return this.abs(a-b)<1e-9},Voronoi.prototype.greaterThanWithEpsilon=function(a,b){return a-b>1e-9},Voronoi.prototype.greaterThanOrEqualWithEpsilon=function(a,b){return b-a<1e-9},Voronoi.prototype.lessThanWithEpsilon=function(a,b){return b-a>1e-9},Voronoi.prototype.lessThanOrEqualWithEpsilon=function(a,b){return a-b<1e-9},Voronoi.prototype.RBTree=function(){this.root=null},Voronoi.prototype.RBTree.prototype.rbInsertSuccessor=function(node,successor){var parent;if(node){if(successor.rbPrevious=node,successor.rbNext=node.rbNext,node.rbNext&&(node.rbNext.rbPrevious=successor),node.rbNext=successor,node.rbRight){for(node=node.rbRight;node.rbLeft;)node=node.rbLeft;node.rbLeft=successor}else node.rbRight=successor;parent=node}else this.root?(node=this.getFirst(this.root),successor.rbPrevious=null,successor.rbNext=node,node.rbPrevious=successor,node.rbLeft=successor,parent=node):(successor.rbPrevious=successor.rbNext=null,this.root=successor,parent=null);successor.rbLeft=successor.rbRight=null,successor.rbParent=parent,successor.rbRed=!0;var grandpa,uncle;for(node=successor;parent&&parent.rbRed;)grandpa=parent.rbParent,parent===grandpa.rbLeft?(uncle=grandpa.rbRight,uncle&&uncle.rbRed?(parent.rbRed=uncle.rbRed=!1,grandpa.rbRed=!0,node=grandpa):(node===parent.rbRight&&(this.rbRotateLeft(parent),node=parent,parent=node.rbParent),parent.rbRed=!1,grandpa.rbRed=!0,this.rbRotateRight(grandpa))):(uncle=grandpa.rbLeft,uncle&&uncle.rbRed?(parent.rbRed=uncle.rbRed=!1,grandpa.rbRed=!0,node=grandpa):(node===parent.rbLeft&&(this.rbRotateRight(parent),node=parent,parent=node.rbParent),parent.rbRed=!1,grandpa.rbRed=!0,this.rbRotateLeft(grandpa))),parent=node.rbParent;this.root.rbRed=!1},Voronoi.prototype.RBTree.prototype.rbRemoveNode=function(node){node.rbNext&&(node.rbNext.rbPrevious=node.rbPrevious),node.rbPrevious&&(node.rbPrevious.rbNext=node.rbNext),node.rbNext=node.rbPrevious=null;var next,parent=node.rbParent,left=node.rbLeft,right=node.rbRight;next=left?right?this.getFirst(right):left:right,parent?parent.rbLeft===node?parent.rbLeft=next:parent.rbRight=next:this.root=next;var isRed;if(left&&right?(isRed=next.rbRed,next.rbRed=node.rbRed,next.rbLeft=left,left.rbParent=next,next!==right?(parent=next.rbParent,next.rbParent=node.rbParent,node=next.rbRight,parent.rbLeft=node,next.rbRight=right,right.rbParent=next):(next.rbParent=parent,parent=next,node=next.rbRight)):(isRed=node.rbRed,node=next),node&&(node.rbParent=parent),!isRed){if(node&&node.rbRed)return void(node.rbRed=!1);var sibling;do{if(node===this.root)break;if(node===parent.rbLeft){if(sibling=parent.rbRight,sibling.rbRed&&(sibling.rbRed=!1,parent.rbRed=!0,this.rbRotateLeft(parent),sibling=parent.rbRight),sibling.rbLeft&&sibling.rbLeft.rbRed||sibling.rbRight&&sibling.rbRight.rbRed){sibling.rbRight&&sibling.rbRight.rbRed||(sibling.rbLeft.rbRed=!1,sibling.rbRed=!0,this.rbRotateRight(sibling),sibling=parent.rbRight),sibling.rbRed=parent.rbRed,parent.rbRed=sibling.rbRight.rbRed=!1,this.rbRotateLeft(parent),node=this.root;break}}else if(sibling=parent.rbLeft,sibling.rbRed&&(sibling.rbRed=!1,parent.rbRed=!0,this.rbRotateRight(parent),sibling=parent.rbLeft),sibling.rbLeft&&sibling.rbLeft.rbRed||sibling.rbRight&&sibling.rbRight.rbRed){sibling.rbLeft&&sibling.rbLeft.rbRed||(sibling.rbRight.rbRed=!1,sibling.rbRed=!0,this.rbRotateLeft(sibling),sibling=parent.rbLeft),sibling.rbRed=parent.rbRed,parent.rbRed=sibling.rbLeft.rbRed=!1,this.rbRotateRight(parent),node=this.root;break}sibling.rbRed=!0,node=parent,parent=parent.rbParent}while(!node.rbRed);node&&(node.rbRed=!1)}},Voronoi.prototype.RBTree.prototype.rbRotateLeft=function(node){var p=node,q=node.rbRight,parent=p.rbParent;parent?parent.rbLeft===p?parent.rbLeft=q:parent.rbRight=q:this.root=q,q.rbParent=parent,p.rbParent=q,p.rbRight=q.rbLeft,p.rbRight&&(p.rbRight.rbParent=p),q.rbLeft=p},Voronoi.prototype.RBTree.prototype.rbRotateRight=function(node){var p=node,q=node.rbLeft,parent=p.rbParent;parent?parent.rbLeft===p?parent.rbLeft=q:parent.rbRight=q:this.root=q,q.rbParent=parent,p.rbParent=q,p.rbLeft=q.rbRight,p.rbLeft&&(p.rbLeft.rbParent=p),q.rbRight=p},Voronoi.prototype.RBTree.prototype.getFirst=function(node){for(;node.rbLeft;)node=node.rbLeft;return node},Voronoi.prototype.RBTree.prototype.getLast=function(node){for(;node.rbRight;)node=node.rbRight;return node},Voronoi.prototype.Diagram=function(site){this.site=site},Voronoi.prototype.Cell=function(site){this.site=site,this.halfedges=[],this.closeMe=!1},Voronoi.prototype.Cell.prototype.init=function(site){return this.site=site,this.halfedges=[],this.closeMe=!1,this},Voronoi.prototype.createCell=function(site){var cell=this.cellJunkyard.pop();return cell?cell.init(site):new this.Cell(site)},Voronoi.prototype.Cell.prototype.prepareHalfedges=function(){for(var edge,halfedges=this.halfedges,iHalfedge=halfedges.length;iHalfedge--;)edge=halfedges[iHalfedge].edge,edge.vb&&edge.va||halfedges.splice(iHalfedge,1);return halfedges.sort(function(a,b){return b.angle-a.angle}),halfedges.length},Voronoi.prototype.Cell.prototype.getNeighborIds=function(){for(var edge,neighbors=[],iHalfedge=this.halfedges.length;iHalfedge--;)edge=this.halfedges[iHalfedge].edge,null!==edge.lSite&&edge.lSite.voronoiId!=this.site.voronoiId?neighbors.push(edge.lSite.voronoiId):null!==edge.rSite&&edge.rSite.voronoiId!=this.site.voronoiId&&neighbors.push(edge.rSite.voronoiId);return neighbors},Voronoi.prototype.Cell.prototype.getBbox=function(){for(var v,vx,vy,halfedges=this.halfedges,iHalfedge=halfedges.length,xmin=1/0,ymin=1/0,xmax=-(1/0),ymax=-(1/0);iHalfedge--;)v=halfedges[iHalfedge].getStartpoint(),vx=v.x,vy=v.y,vx<xmin&&(xmin=vx),vy<ymin&&(ymin=vy),vx>xmax&&(xmax=vx),vy>ymax&&(ymax=vy);return{x:xmin,y:ymin,width:xmax-xmin,height:ymax-ymin}},Voronoi.prototype.Cell.prototype.pointIntersection=function(x,y){for(var halfedge,p0,p1,r,halfedges=this.halfedges,iHalfedge=halfedges.length;iHalfedge--;){if(halfedge=halfedges[iHalfedge],p0=halfedge.getStartpoint(),p1=halfedge.getEndpoint(),r=(y-p0.y)*(p1.x-p0.x)-(x-p0.x)*(p1.y-p0.y),!r)return 0;if(r>0)return-1}return 1},Voronoi.prototype.Vertex=function(x,y){this.x=x,this.y=y},Voronoi.prototype.Edge=function(lSite,rSite){this.lSite=lSite,this.rSite=rSite,this.va=this.vb=null},Voronoi.prototype.Halfedge=function(edge,lSite,rSite){if(this.site=lSite,this.edge=edge,rSite)this.angle=Math.atan2(rSite.y-lSite.y,rSite.x-lSite.x);else{var va=edge.va,vb=edge.vb;this.angle=edge.lSite===lSite?Math.atan2(vb.x-va.x,va.y-vb.y):Math.atan2(va.x-vb.x,vb.y-va.y)}},Voronoi.prototype.createHalfedge=function(edge,lSite,rSite){return new this.Halfedge(edge,lSite,rSite)},Voronoi.prototype.Halfedge.prototype.getStartpoint=function(){return this.edge.lSite===this.site?this.edge.va:this.edge.vb},Voronoi.prototype.Halfedge.prototype.getEndpoint=function(){return this.edge.lSite===this.site?this.edge.vb:this.edge.va},Voronoi.prototype.createVertex=function(x,y){var v=this.vertexJunkyard.pop();return v?(v.x=x,v.y=y):v=new this.Vertex(x,y),this.vertices.push(v),v},Voronoi.prototype.createEdge=function(lSite,rSite,va,vb){var edge=this.edgeJunkyard.pop();return edge?(edge.lSite=lSite,edge.rSite=rSite,edge.va=edge.vb=null):edge=new this.Edge(lSite,rSite),this.edges.push(edge),va&&this.setEdgeStartpoint(edge,lSite,rSite,va),vb&&this.setEdgeEndpoint(edge,lSite,rSite,vb),this.cells[lSite.voronoiId].halfedges.push(this.createHalfedge(edge,lSite,rSite)),this.cells[rSite.voronoiId].halfedges.push(this.createHalfedge(edge,rSite,lSite)),edge},Voronoi.prototype.createBorderEdge=function(lSite,va,vb){var edge=this.edgeJunkyard.pop();return edge?(edge.lSite=lSite,edge.rSite=null):edge=new this.Edge(lSite,null),edge.va=va,edge.vb=vb,this.edges.push(edge),edge},Voronoi.prototype.setEdgeStartpoint=function(edge,lSite,rSite,vertex){edge.va||edge.vb?edge.lSite===rSite?edge.vb=vertex:edge.va=vertex:(edge.va=vertex,edge.lSite=lSite,edge.rSite=rSite)},Voronoi.prototype.setEdgeEndpoint=function(edge,lSite,rSite,vertex){this.setEdgeStartpoint(edge,rSite,lSite,vertex)},Voronoi.prototype.Beachsection=function(){},Voronoi.prototype.createBeachsection=function(site){var beachsection=this.beachsectionJunkyard.pop();return beachsection||(beachsection=new this.Beachsection),beachsection.site=site,beachsection},Voronoi.prototype.leftBreakPoint=function(arc,directrix){var site=arc.site,rfocx=site.x,rfocy=site.y,pby2=rfocy-directrix;if(!pby2)return rfocx;var lArc=arc.rbPrevious;if(!lArc)return-(1/0);site=lArc.site;var lfocx=site.x,lfocy=site.y,plby2=lfocy-directrix;if(!plby2)return lfocx;var hl=lfocx-rfocx,aby2=1/pby2-1/plby2,b=hl/plby2;return aby2?(-b+this.sqrt(b*b-2*aby2*(hl*hl/(-2*plby2)-lfocy+plby2/2+rfocy-pby2/2)))/aby2+rfocx:(rfocx+lfocx)/2},Voronoi.prototype.rightBreakPoint=function(arc,directrix){var rArc=arc.rbNext;if(rArc)return this.leftBreakPoint(rArc,directrix);var site=arc.site;return site.y===directrix?site.x:1/0},Voronoi.prototype.detachBeachsection=function(beachsection){this.detachCircleEvent(beachsection),this.beachline.rbRemoveNode(beachsection),this.beachsectionJunkyard.push(beachsection)},Voronoi.prototype.removeBeachsection=function(beachsection){var circle=beachsection.circleEvent,x=circle.x,y=circle.ycenter,vertex=this.createVertex(x,y),previous=beachsection.rbPrevious,next=beachsection.rbNext,disappearingTransitions=[beachsection],abs_fn=Math.abs;this.detachBeachsection(beachsection);for(var lArc=previous;lArc.circleEvent&&abs_fn(x-lArc.circleEvent.x)<1e-9&&abs_fn(y-lArc.circleEvent.ycenter)<1e-9;)previous=lArc.rbPrevious,disappearingTransitions.unshift(lArc),this.detachBeachsection(lArc),lArc=previous;disappearingTransitions.unshift(lArc),this.detachCircleEvent(lArc);for(var rArc=next;rArc.circleEvent&&abs_fn(x-rArc.circleEvent.x)<1e-9&&abs_fn(y-rArc.circleEvent.ycenter)<1e-9;)next=rArc.rbNext,disappearingTransitions.push(rArc),this.detachBeachsection(rArc),rArc=next;disappearingTransitions.push(rArc),this.detachCircleEvent(rArc);var iArc,nArcs=disappearingTransitions.length;for(iArc=1;iArc<nArcs;iArc++)rArc=disappearingTransitions[iArc],lArc=disappearingTransitions[iArc-1],this.setEdgeStartpoint(rArc.edge,lArc.site,rArc.site,vertex);lArc=disappearingTransitions[0],rArc=disappearingTransitions[nArcs-1],rArc.edge=this.createEdge(lArc.site,rArc.site,void 0,vertex),this.attachCircleEvent(lArc),this.attachCircleEvent(rArc)},Voronoi.prototype.addBeachsection=function(site){for(var lArc,rArc,dxl,dxr,x=site.x,directrix=site.y,node=this.beachline.root;node;)if(dxl=this.leftBreakPoint(node,directrix)-x,dxl>1e-9)node=node.rbLeft;else{if(dxr=x-this.rightBreakPoint(node,directrix),!(dxr>1e-9)){dxl>-1e-9?(lArc=node.rbPrevious,rArc=node):dxr>-1e-9?(lArc=node,rArc=node.rbNext):lArc=rArc=node;break}if(!node.rbRight){lArc=node;break}node=node.rbRight}var newArc=this.createBeachsection(site);if(this.beachline.rbInsertSuccessor(lArc,newArc),lArc||rArc){if(lArc===rArc)return this.detachCircleEvent(lArc),rArc=this.createBeachsection(lArc.site),this.beachline.rbInsertSuccessor(newArc,rArc),newArc.edge=rArc.edge=this.createEdge(lArc.site,newArc.site),this.attachCircleEvent(lArc),void this.attachCircleEvent(rArc);if(lArc&&!rArc)return void(newArc.edge=this.createEdge(lArc.site,newArc.site));if(lArc!==rArc){this.detachCircleEvent(lArc),this.detachCircleEvent(rArc);var lSite=lArc.site,ax=lSite.x,ay=lSite.y,bx=site.x-ax,by=site.y-ay,rSite=rArc.site,cx=rSite.x-ax,cy=rSite.y-ay,d=2*(bx*cy-by*cx),hb=bx*bx+by*by,hc=cx*cx+cy*cy,vertex=this.createVertex((cy*hb-by*hc)/d+ax,(bx*hc-cx*hb)/d+ay);return this.setEdgeStartpoint(rArc.edge,lSite,rSite,vertex),newArc.edge=this.createEdge(lSite,site,void 0,vertex),rArc.edge=this.createEdge(site,rSite,void 0,vertex),this.attachCircleEvent(lArc),void this.attachCircleEvent(rArc)}}},Voronoi.prototype.CircleEvent=function(){this.arc=null,this.rbLeft=null,this.rbNext=null,this.rbParent=null,this.rbPrevious=null,this.rbRed=!1,this.rbRight=null,this.site=null,this.x=this.y=this.ycenter=0},Voronoi.prototype.attachCircleEvent=function(arc){var lArc=arc.rbPrevious,rArc=arc.rbNext;if(lArc&&rArc){var lSite=lArc.site,cSite=arc.site,rSite=rArc.site;if(lSite!==rSite){var bx=cSite.x,by=cSite.y,ax=lSite.x-bx,ay=lSite.y-by,cx=rSite.x-bx,cy=rSite.y-by,d=2*(ax*cy-ay*cx);if(!(d>=-2e-12)){var ha=ax*ax+ay*ay,hc=cx*cx+cy*cy,x=(cy*ha-ay*hc)/d,y=(ax*hc-cx*ha)/d,ycenter=y+by,circleEvent=this.circleEventJunkyard.pop();circleEvent||(circleEvent=new this.CircleEvent),circleEvent.arc=arc,circleEvent.site=cSite,circleEvent.x=x+bx,circleEvent.y=ycenter+this.sqrt(x*x+y*y),circleEvent.ycenter=ycenter,arc.circleEvent=circleEvent;for(var predecessor=null,node=this.circleEvents.root;node;)if(circleEvent.y<node.y||circleEvent.y===node.y&&circleEvent.x<=node.x){if(!node.rbLeft){predecessor=node.rbPrevious;break}node=node.rbLeft}else{if(!node.rbRight){predecessor=node;break}node=node.rbRight}this.circleEvents.rbInsertSuccessor(predecessor,circleEvent),predecessor||(this.firstCircleEvent=circleEvent)}}}},Voronoi.prototype.detachCircleEvent=function(arc){var circleEvent=arc.circleEvent;circleEvent&&(circleEvent.rbPrevious||(this.firstCircleEvent=circleEvent.rbNext),this.circleEvents.rbRemoveNode(circleEvent),this.circleEventJunkyard.push(circleEvent),arc.circleEvent=null)},Voronoi.prototype.connectEdge=function(edge,bbox){var vb=edge.vb;if(vb)return!0;var fm,fb,va=edge.va,xl=bbox.xl,xr=bbox.xr,yt=bbox.yt,yb=bbox.yb,lSite=edge.lSite,rSite=edge.rSite,lx=lSite.x,ly=lSite.y,rx=rSite.x,ry=rSite.y,fx=(lx+rx)/2,fy=(ly+ry)/2;if(this.cells[lSite.voronoiId].closeMe=!0,this.cells[rSite.voronoiId].closeMe=!0,ry!==ly&&(fm=(lx-rx)/(ry-ly),fb=fy-fm*fx),void 0===fm){if(fx<xl||fx>=xr)return!1;if(lx>rx){if(va){if(va.y>=yb)return!1}else va=this.createVertex(fx,yt);vb=this.createVertex(fx,yb)}else{if(va){if(va.y<yt)return!1}else va=this.createVertex(fx,yb);vb=this.createVertex(fx,yt)}}else if(fm<-1||fm>1)if(lx>rx){if(va){if(va.y>=yb)return!1}else va=this.createVertex((yt-fb)/fm,yt);vb=this.createVertex((yb-fb)/fm,yb)}else{if(va){if(va.y<yt)return!1}else va=this.createVertex((yb-fb)/fm,yb);vb=this.createVertex((yt-fb)/fm,yt)}else if(ly<ry){if(va){if(va.x>=xr)return!1}else va=this.createVertex(xl,fm*xl+fb);vb=this.createVertex(xr,fm*xr+fb)}else{if(va){if(va.x<xl)return!1}else va=this.createVertex(xr,fm*xr+fb);vb=this.createVertex(xl,fm*xl+fb)}return edge.va=va,edge.vb=vb,!0},Voronoi.prototype.clipEdge=function(edge,bbox){var ax=edge.va.x,ay=edge.va.y,bx=edge.vb.x,by=edge.vb.y,t0=0,t1=1,dx=bx-ax,dy=by-ay,q=ax-bbox.xl;if(0===dx&&q<0)return!1;var r=-q/dx;if(dx<0){if(r<t0)return!1;r<t1&&(t1=r)}else if(dx>0){if(r>t1)return!1;r>t0&&(t0=r)}if(q=bbox.xr-ax,0===dx&&q<0)return!1;if(r=q/dx,dx<0){if(r>t1)return!1;r>t0&&(t0=r)}else if(dx>0){if(r<t0)return!1;r<t1&&(t1=r)}if(q=ay-bbox.yt,0===dy&&q<0)return!1;if(r=-q/dy,dy<0){if(r<t0)return!1;r<t1&&(t1=r)}else if(dy>0){if(r>t1)return!1;r>t0&&(t0=r)}if(q=bbox.yb-ay,0===dy&&q<0)return!1;if(r=q/dy,dy<0){if(r>t1)return!1;r>t0&&(t0=r)}else if(dy>0){if(r<t0)return!1;r<t1&&(t1=r)}return t0>0&&(edge.va=this.createVertex(ax+t0*dx,ay+t0*dy)),t1<1&&(edge.vb=this.createVertex(ax+t1*dx,ay+t1*dy)),(t0>0||t1<1)&&(this.cells[edge.lSite.voronoiId].closeMe=!0,this.cells[edge.rSite.voronoiId].closeMe=!0),!0},Voronoi.prototype.clipEdges=function(bbox){for(var edge,edges=this.edges,iEdge=edges.length,abs_fn=Math.abs;iEdge--;)edge=edges[iEdge],(!this.connectEdge(edge,bbox)||!this.clipEdge(edge,bbox)||abs_fn(edge.va.x-edge.vb.x)<1e-9&&abs_fn(edge.va.y-edge.vb.y)<1e-9)&&(edge.va=edge.vb=null,edges.splice(iEdge,1))},Voronoi.prototype.closeCells=function(bbox){for(var cell,iLeft,halfedges,nHalfedges,edge,va,vb,vz,lastBorderSegment,xl=bbox.xl,xr=bbox.xr,yt=bbox.yt,yb=bbox.yb,cells=this.cells,iCell=cells.length,abs_fn=Math.abs;iCell--;)if(cell=cells[iCell],cell.prepareHalfedges()&&cell.closeMe){for(halfedges=cell.halfedges,nHalfedges=halfedges.length,iLeft=0;iLeft<nHalfedges&&(va=halfedges[iLeft].getEndpoint(),vz=halfedges[(iLeft+1)%nHalfedges].getStartpoint(),!(abs_fn(va.x-vz.x)>=1e-9||abs_fn(va.y-vz.y)>=1e-9));)iLeft++;if(iLeft!==nHalfedges){switch(!0){case this.equalWithEpsilon(va.x,xl)&&this.lessThanWithEpsilon(va.y,yb):if(lastBorderSegment=this.equalWithEpsilon(vz.x,xl),vb=this.createVertex(xl,lastBorderSegment?vz.y:yb),edge=this.createBorderEdge(cell.site,va,vb),iLeft++,halfedges.splice(iLeft,0,this.createHalfedge(edge,cell.site,null)),lastBorderSegment)break;va=vb;case this.equalWithEpsilon(va.y,yb)&&this.lessThanWithEpsilon(va.x,xr):if(lastBorderSegment=this.equalWithEpsilon(vz.y,yb),vb=this.createVertex(lastBorderSegment?vz.x:xr,yb),edge=this.createBorderEdge(cell.site,va,vb),iLeft++,halfedges.splice(iLeft,0,this.createHalfedge(edge,cell.site,null)),lastBorderSegment)break;va=vb;case this.equalWithEpsilon(va.x,xr)&&this.greaterThanWithEpsilon(va.y,yt):if(lastBorderSegment=this.equalWithEpsilon(vz.x,xr),vb=this.createVertex(xr,lastBorderSegment?vz.y:yt),edge=this.createBorderEdge(cell.site,va,vb),iLeft++,halfedges.splice(iLeft,0,this.createHalfedge(edge,cell.site,null)),lastBorderSegment)break;va=vb;case this.equalWithEpsilon(va.y,yt)&&this.greaterThanWithEpsilon(va.x,xl):if(lastBorderSegment=this.equalWithEpsilon(vz.y,yt),vb=this.createVertex(lastBorderSegment?vz.x:xl,yt),edge=this.createBorderEdge(cell.site,va,vb),iLeft++,halfedges.splice(iLeft,0,this.createHalfedge(edge,cell.site,null)),lastBorderSegment)break;if(va=vb,lastBorderSegment=this.equalWithEpsilon(vz.x,xl),vb=this.createVertex(xl,lastBorderSegment?vz.y:yb),edge=this.createBorderEdge(cell.site,va,vb),iLeft++,halfedges.splice(iLeft,0,this.createHalfedge(edge,cell.site,null)),lastBorderSegment)break;if(va=vb,lastBorderSegment=this.equalWithEpsilon(vz.y,yb),vb=this.createVertex(lastBorderSegment?vz.x:xr,yb),edge=this.createBorderEdge(cell.site,va,vb),iLeft++,halfedges.splice(iLeft,0,this.createHalfedge(edge,cell.site,null)),lastBorderSegment)break;va=vb,lastBorderSegment=this.equalWithEpsilon(vz.x,xr),vb=this.createVertex(xr,lastBorderSegment?vz.y:yt),edge=this.createBorderEdge(cell.site,va,vb),iLeft++,halfedges.splice(iLeft,0,this.createHalfedge(edge,cell.site,null));break;default:throw"Voronoi.closeCells() > this makes no sense!"}if(abs_fn(vb.x-vz.x)>=1e-9||abs_fn(vb.y-vz.y)>=1e-9)throw"Voronoi.closeCells() > Could not close the Voronoi cell!\n  (See https://github.com/gorhill/Javascript-Voronoi/issues/15)"}}},Voronoi.prototype.quantizeSites=function(sites){for(var site,Îµ=this.EPSILON,n=sites.length;n--;)site=sites[n],site.x=Math.floor(site.x/Îµ)*Îµ,site.y=Math.floor(site.y/Îµ)*Îµ},Voronoi.prototype.recycle=function(diagram){if(diagram){if(!(diagram instanceof this.Diagram))throw"Voronoi.recycleDiagram() > Need a Diagram object.";this.toRecycle=diagram}},Voronoi.prototype.compute=function(sites,bbox){var startTime=new Date;this.reset(),this.toRecycle&&(this.vertexJunkyard=this.vertexJunkyard.concat(this.toRecycle.vertices),this.edgeJunkyard=this.edgeJunkyard.concat(this.toRecycle.edges),this.cellJunkyard=this.cellJunkyard.concat(this.toRecycle.cells),this.toRecycle=null);var siteEvents=sites.slice(0);siteEvents.sort(function(a,b){var r=b.y-a.y;return r?r:b.x-a.x});for(var xsitex,xsitey,circle,site=siteEvents.pop(),siteid=0,cells=this.cells;;)if(circle=this.firstCircleEvent,site&&(!circle||site.y<circle.y||site.y===circle.y&&site.x<circle.x))site.x===xsitex&&site.y===xsitey||(cells[siteid]=this.createCell(site),site.voronoiId=siteid++,this.addBeachsection(site),xsitey=site.y,xsitex=site.x),site=siteEvents.pop();else{if(!circle)break;this.removeBeachsection(circle.arc)}this.clipEdges(bbox),this.closeCells(bbox);var stopTime=new Date,diagram=new this.Diagram;return diagram.cells=this.cells,diagram.edges=this.edges,diagram.vertices=this.vertices,diagram.execTime=stopTime.getTime()-startTime.getTime(),this.reset(),diagram};var socket=io(),app=angular.module("conkr",[]).controller("conkrcon",function($scope,chatFact,mapFact){$scope.win={w:.95*$(window).width(),h:.95*$(window).height()},$scope.numCountries=20,$scope.map=mapFact.GetVoronoi($scope.win.h,$scope.win.w,$scope.numCountries),$scope.newMap=function(){var smootz=101-$scope.smoothing,numZones=Math.round($scope.numCountries/.3);$scope.map=mapFact.GetVoronoi($scope.win.h,$scope.win.w,numZones,smootz),$scope.map.init()},$scope.waterAndErf=function(){for(var i=0;i<$scope.map.diagram.cells.length;i++){var col,eCol;$scope.map.diagram.cells[i].isLand?(col="#0c0",eCol="#9c9"):(col="#35a",eCol="#92a8c8"),mapFact.colorCell($scope.map,i,col,eCol)}}});app.factory("chatFact",function($rootScope){return{sendMsg:function(m){}}}),app.factory("mapFact",function($rootScope){var countries={names:["Nasteaburg","Dutralor","Eslos","Oglyae","Cruiria","Whuadal","Ethua","Estaria","Shiod","Skesh","Froe","Glen","Yacluoria","Desmayyae","Oskana","Echea","Pleiles","Ploussau","Usnea","Oprijan","Fleol","Spijan","Flie Stril","Iecheidal","Beplayburg","Raprana","Qescyae","Smeuqua","Tresil","Ospary","Eflary","Bloek","Pral","Cluyx Smea","Cegriydal","Ethoeque","Pacril","Justril","Stoynga","Swuyque","Osnyae","Estron","Flauh","Clyae","Theul Plar","Osmoirus","Osliuji","Qetrington","Cuflus","Brioca","Skuocia","Ashad","Ecrar","Snoyg","Drington","Cresh","Cutraynia","Qechiavania","Pechary","Jadrar","Striurus","Smoiburg","Aspil","Ascington","Thain","Brex","Prax","Gusmaonga","Jestruibia","Woscyae","Vascea","Dreyssau","Flecia","Aglos","Estyae","Shiyk","Thesh","Glaeq","Slea","Fasmiulia","Pagluorhiel","Wachil","Wegrya","Snobar","Smeobar","Athana","Ogresh","Smait","Whus","Zusleuland","Ofleilor","Beflington","Cusmyae","Swobia","Thiostan","Uclain","Adryae","Frio","Spington","Gloir","Star","Fustredor","Pucrourhiel","Quplana","Tasnye","Spoubia","Griycia","Uchos","Achyae","Gruoz","Smijan","Swiur","Crary"],prefs:["East","West","North","South","Republic of","Kingdom of","Empire of"]};return{GetVoronoi:function(hi,wid,numCells,schmooz){var newVor={voronoi:new Voronoi,diagram:null,margin:.1,canvas:null,bbox:{xl:0,xr:wid,yt:0,yb:hi},sites:[],countryNames:[],timeoutDelay:30,numsRelaxed:100,init:function(){this.canvas=document.querySelector("canvas"),this.randomSites(numCells,!0)},clearSites:function(){this.compute([])},randomSites:function(n,clear){var sites=[];clear||(sites=this.sites.slice(0));for(var xmargin=this.canvas.width*this.margin,ymargin=this.canvas.height*this.margin,xo=xmargin,dx=this.canvas.width-2*xmargin,yo=ymargin,dy=this.canvas.height-2*ymargin,i=0;i<n;i++)sites.push({x:self.Math.round(10*(xo+self.Math.random()*dx))/10,y:self.Math.round(10*(yo+self.Math.random()*dy))/10});this.compute(sites),this.timeout&&(clearTimeout(this.timeout),this.timeout=null);var me=this;this.timeout=setTimeout(function(){me.relaxSites()},this.timeoutDelay)},relaxSites:function(){if(this.diagram){for(var cell,site,rn,dist,cells=this.diagram.cells,iCell=cells.length,sites=[],again=!1,p=1/iCell*.1;iCell--;)cell=cells[iCell],rn=Math.random(),rn<p||(site=this.cellCentroid(cell),dist=this.distance(site,cell.site),this.numsRelaxed-=1/(numCells/schmooz),again=this.numsRelaxed>0,dist>2&&(site.x=(site.x+cell.site.x)/2,site.y=(site.y+cell.site.y)/2),rn>1-p&&(dist/=2,sites.push({x:site.x+(site.x-cell.site.x)/dist,y:site.y+(site.y-cell.site.y)/dist})),sites.push(site));if(this.compute(sites),again){var me=this;this.timeout=setTimeout(function(){me.relaxSites()},this.timeoutDelay)}else this.doAllCells(),this.render(),this.getCellNames()}},distance:function(a,b){var dx=a.x-b.x,dy=a.y-b.y;return Math.sqrt(dx*dx+dy*dy)},cellArea:function(cell){for(var halfedge,p1,p2,area=0,halfedges=cell.halfedges,iHalfedge=halfedges.length;iHalfedge--;)halfedge=halfedges[iHalfedge],p1=halfedge.getStartpoint(),p2=halfedge.getEndpoint(),area+=p1.x*p2.y,area-=p1.y*p2.x;return area/=2},cellCentroid:function(cell){for(var halfedge,v,p1,p2,x=0,y=0,halfedges=cell.halfedges,iHalfedge=halfedges.length;iHalfedge--;)halfedge=halfedges[iHalfedge],p1=halfedge.getStartpoint(),p2=halfedge.getEndpoint(),v=p1.x*p2.y-p2.x*p1.y,x+=(p1.x+p2.x)*v,y+=(p1.y+p2.y)*v;return v=6*this.cellArea(cell),{x:x/v,y:y/v}},compute:function(sites){this.sites=sites,this.voronoi.recycle(this.diagram),this.diagram=this.voronoi.compute(sites,this.bbox);for(var i=0;i<this.diagram.cells.length;i++)Math.random()>.7?(this.diagram.cells[i].isLand=!0,console.log("cell",i,"is land")):this.diagram.cells[i].isLand=!1},render:function(){var ctx=this.canvas.getContext("2d");if(ctx.globalAlpha=1,ctx.beginPath(),ctx.strokeStyle="#888",ctx.stroke(),this.diagram){ctx.lineWidth=5;for(var edge,v,edges=this.diagram.edges,iEdge=edges.length,gradArr=[];iEdge--;){ctx.beginPath(),edge=edges[iEdge];var edgeGradLine=this.getEdgeGrad(edge);console.log(edgeGradLine),gradArr.push(ctx.createLinearGradient(edgeGradLine.xi,edgeGradLine.yi,edgeGradLine.xf,edgeGradLine.yf)),gradArr[gradArr.length-1].addColorStop(0,edgeGradLine.start),gradArr[gradArr.length-1].addColorStop(1,edgeGradLine.end),ctx.strokeStyle=gradArr[gradArr.length-1],v=edge.va,ctx.moveTo(v.x,v.y),v=edge.vb,ctx.lineTo(v.x,v.y),ctx.stroke()}ctx.beginPath(),ctx.fillStyle="#44f";for(var sites=this.sites,iSite=sites.length;iSite--;)v=sites[iSite],ctx.rect(v.x-2/3,v.y-2/3,2,2);ctx.fill()}},getEdgeGrad:function(e){if(console.log("EDGEGRAD",e),!e.lSite||!e.rSite)return{xi:0,xf:100,yi:0,yf:0,start:"#0c0",end:"#000"};var grad={xi:null,xf:null,yi:null,yf:null,start:"#35a",end:"#35a"},source=this.findCell(e.lSite.x,e.lSite.y),dest=this.findCell(e.rSite.x,e.rSite.y),ang=Math.atan((e.rSite.y-e.lSite.y)/(e.rSite.x-e.lSite.x))+0*Math.PI/2,midPt={x:(e.rSite.x+e.lSite.x)/2,y:e.rSite.y-e.lSite.y},dh=5*Math.sin(ang),dw=5*Math.cos(ang);return ang>Math.PI&&(ang=Math.PI-ang),console.log("SOURCE",source,"DEST",dest,"src",this.cellIdFromPoint(e.lSite.x,e.lSite.y),"d",this.cellIdFromPoint(e.rSite.x,e.rSite.y),"full input",e),grad.xi=midPt.x-dw,grad.xf=midPt.x+dw,grad.yi=midPt.y-dh,grad.yf=midPt.y+dh,source.isLand&&(grad.start="#9c9"),dest.isLand&&(grad.end="#9c9"),grad},getCellNames:function(){for(var ctx=this.canvas.getContext("2d"),n=0;n<this.diagram.cells.length;n++){var cell=this.diagram.cells[n],newName=null;if(cell.isLand){for(var isUnique=!1;!isUnique;)newName=countries.names[Math.floor(Math.random()*countries.names.length)],Math.random()>.7&&(newName=countries.prefs[Math.floor(Math.random()*countries.prefs.length)]+" "+newName),
isUnique=this.countryNames.indexOf(newName)<0;this.countryNames.push(newName),console.log("creating country ",newName);var textBoxWid=ctx.measureText(newName).width+4;ctx.fillStyle="#fed",console.log("CELL LABEL DIMS FOR CELL",n,":",Math.floor(cell.site.x-textBoxWid/2-2),Math.floor(cell.site.y-13),textBoxWid,13," NAME WID:",textBoxWid),ctx.fillRect(Math.floor(cell.site.x-textBoxWid/2-2),Math.floor(cell.site.y-13),textBoxWid,13),ctx.fillStyle="#000",ctx.font="10px Arial",ctx.fillText(newName,cell.site.x-textBoxWid/2,cell.site.y-2),cell.country=newName}}},findCell:function(x,y){for(var i=0;i<this.diagram.cells.length;i++)if(this.diagram.cells[i].site.x==x&&this.diagram.cells[i].site.y==y)return this.diagram.cells[i];return!1},buildTreemap:function(){for(var treemap=new QuadTree({x:this.bbox.xl,y:this.bbox.yt,width:this.bbox.xr-this.bbox.xl,height:this.bbox.yb-this.bbox.yt}),cells=this.diagram.cells,iCell=cells.length;iCell--;)bbox=cells[iCell].getBbox(),bbox.cellid=iCell,treemap.insert(bbox);return treemap},cellIdFromPoint:function(x,y){this.treemap=this.buildTreemap(),console.log("Treez",this.treemap);for(var cell,cellid,items=this.treemap.retrieve({x:x,y:y}),iItem=items.length,cells=this.diagram.cells;iItem--;)if(cellid=items[iItem].cellid,cell=cells[cellid],cell.pointIntersection(x,y)>0)return cellid},renderCell:function(id,fillStyle,strokeStyle){if(void 0!==id&&this.diagram){var cell=this.diagram.cells[id];if(cell){var ctx=this.canvas.getContext("2d");ctx.globalAlpha=1,ctx.beginPath();var halfedges=cell.halfedges,nHalfedges=halfedges.length,v=halfedges[0].getStartpoint();ctx.moveTo(v.x,v.y);for(var iHalfedge=0;iHalfedge<nHalfedges;iHalfedge++)v=halfedges[iHalfedge].getEndpoint(),ctx.lineTo(v.x,v.y);ctx.fillStyle=fillStyle,ctx.strokeStyle=strokeStyle,ctx.fill(),ctx.stroke(),v=cell.site,ctx.fillStyle="#44f",ctx.beginPath(),ctx.rect(v.x-2/3,v.y-2/3,2,2),ctx.fill()}}},doAllCells:function(){for(var n=0;n<this.diagram.cells.length;n++){var col="#000",eCol="#fff";this.diagram.cells[n].isLand?(col="#0c0",eCol="#9c9"):(col="#35a",eCol="#92a8c8"),this.renderCell(n,col,eCol)}}};return newVor}}}),app.factory("socket",function($rootScope){console.log("socket factory!");var socket=io.connect();return console.log("socket factory!"),{on:function(eventName,callback){socket.on(eventName,function(){var args=arguments;$rootScope.$apply(function(){callback.apply(socket,args)})})},emit:function(eventName,data,callback){socket.emit(eventName,data,function(){var args=arguments;$rootScope.$apply(function(){callback&&callback.apply(socket,args)})})}}});