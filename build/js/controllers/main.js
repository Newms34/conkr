var socket = io(),
    socketRoom = null;
app.controller('conkrcon', function($scope, $http, fightFact, mapFact, miscFact) {
    //before anything, check to see if we're logged in!
    miscFact.chkLoggedStatus().then(function(r) {
        console.log('DATA', r.data);
        if (!r.data.result) window.location.assign('./login');
        $scope.user = r.data.name;
    });
    $scope.win = {
        w: $(window).width() * 0.95,
        h: $(window).height() * 0.95
    };
    $scope.logout = function() {
        miscFact.logout().then(function() {
            window.location.assign('./login');
        });
    };
    window.onkeyup = function(e) {
        if (e.which == 13 && $scope.showChat) {
            $('#msgInp').focus();
        } else if (e.which == 191) {
            $scope.showChat = true;
            $scope.$digest();
            $('#msgInp').focus();
        }
    };
    $scope.gameMenu = true;
    $scope.gameSettingsPanel = 0;
    $scope.newNew = true; //for new game creation, create a completely new map? 
    $scope.numCountries = 20;
    $scope.map = null;
    $scope.gameId = null;
    $scope.potentialMaps = [];
    $scope.loadedMapImg = null;
    $scope.user = null;
    $scope.newMap = function() {
        var smootz = 101 - $scope.smoothing,
            numZones = Math.round($scope.numCountries / 0.3);
        $scope.map = mapFact.GetVoronoi($scope.win.h, $scope.win.w, numZones, smootz);
        $scope.map.init();
        $scope.gameMenu = false;
        sandalchest.confirm("Map okay?", function(r) {
            if (r) {
                $scope.map.save().then(function(sr) {
                    //got id back from mapsave. Put player in this game.
                    sandalchest.confirm("Do you want to start a new game with this map (" + sr.data.id + ")?", function(play) {
                        if (play) {
                            //use sr.id to make a new game.
                            fightFact.newGame(sr.data.id, $scope.user).then((g) => {
                                console.log('Done! Game made!');
                                socket.emit('getGames',{x:true})
                            });
                        }
                    });
                });
            } else {
                //user doesnt like this map(D:). reset
                $scope.map = null;
                $scope.gameMenu = true;
                $scope.$digest();
            }
        });
    };
    socket.emit('getGames',{x:true})
    $scope.loadMaps = function() {
        //load all OLD maps for a NEW game!
        mapFact.loadMaps().then(function(r) {
            console.log('MAPS', r);
            $scope.potentialMaps = r.data;
        });
    };
    socket.on('allGames', function(g) {
        console.log('FROM ALL GAMES', g);
        $scope.allGames = g;
    });
    $scope.joinGame = function(g) {
        fightFact.joinGame(g, $scope.user).then(function(r) {
            console.log('JOINED GAME:', r);
            socket.emit('getGames',{x:true})
        });
    };
    $scope.pickMap = function(m, n) {
        //load an OLD map for a NEW game
        //map is a new map created just now
        $scope.map = mapFact.GetVoronoi(m.bbox.yb, m.bbox.xr, m.countryNames.length, 20);
        for (var p in m) {
            $scope.map[p] = m[p];
        }
        $scope.map.initLoad(m.img);
        $scope.gameMenu = false;
        fightFact.newGame(n, $scope.user).then((x) => {
            socket.emit('getGames',{x:true})
        });
    };
    $scope.toggleNewMode = function() {
        $scope.newNew = !$scope.newNew;
        if (!$scope.newNew) {
            $scope.loadMaps();
        }
    };
    $scope.startGame = function(id) {
        sandalchest.confirm(`Are you sure you wanna start game ${id}? Starting a game is not reversable, and prevents any more players from joining.`, function(r) {
            if (r) {
                fightFact.startGame(id).then(function(r) {
                    socket.emit('gameStarted',r)
                });
            }
        });
    };
    socket.on('putInGame',(c)=>{
        console.log('PUT IN GAME',c)
        if(c.data.players.indexOf($scope.user)>-1){
            socket.emit('putInRoom',{id:c.data.gameId})
        }
    })
    $scope.avgCounInfo = function() {
        sandalchest.alert('Because of how the map is generated, the actual number of countries may or may not be exactly the number here.');
    };
    $scope.smoothInfo = function() {
        sandalchest.alert('Without smoothing, the shapes generated by the map algorithm (a <a href="https://en.wikipedia.org/wiki/Voronoi_diagram" target="_blank">Voronoi Diagram</a>) are very random. Smoothing \'pushes\' the shapes towards being equal size.');
    };
});
