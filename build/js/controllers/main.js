var socket = io();
app.controller('conkrcon', function($scope, fightFact, mapFact,miscFact) {
    //before anything, check to see if we're logged in!
    miscFact.chkLoggedStatus().then(function(r){
        console.log('DATA',r)
        if (!r.data) window.location.assign('./login');
    })
    $scope.win = {
        w: $(window).width() * 0.95,
        h: $(window).height() * 0.95
    };
    $scope.logout=function(){
        miscFact.logout().then(function(){
            window.location.assign('./login');
        })
    }
    $scope.gameCreateLoad = true;
    $scope.gameSettingsPanel = 0;
    $scope.newNew = true; //for new game creation, create a completely new map? 
    $scope.numCountries = 20;
    $scope.map = null;
    $scope.gameId = null;
    $scope.potentialMaps = [];
    $scope.loadedMapImg = null;
    $scope.user = null;
    $scope.newMap = function() {
        var smootz = 101 - $scope.smoothing,
            numZones = Math.round($scope.numCountries / 0.3);
        $scope.map = mapFact.GetVoronoi($scope.win.h, $scope.win.w, numZones, smootz);
        $scope.map.init();
        $scope.gameCreateLoad = false;
        bootbox.confirm("Map okay?", function(r) {
            if (r && r != null) {
                $scope.map.save();
            } else {
                //user doesnt like this map. reset
                $scope.map = null;
                $scope.gameCreateLoad = true;
                $scope.$digest();
            }
        });
    };
    $scope.loadMaps = function() {
        //load all OLD maps for a NEW game!
        mapFact.loadMaps().then(function(r) {
            console.log('MAPS',r);
            $scope.potentialMaps = r.data;
        })
    }
    $scope.pickMap = function(m){    
        $scope.map = mapFact.GetVoronoi(m.bbox.yb, m.bbox.xr, m.countryNames.length, 20);
        console.log($scope.map)
        for (var p in m){
            $scope.map[p] = m[p];
        }
        $scope.map.initLoad(m.img);
        $scope.gameCreateLoad = false;
    }
    $scope.toggleNewMode = function(){
        $scope.newNew = !$scope.newNew;
        if (!$scope.newNew){
            $scope.loadMaps();
        }
    }
    $scope.avgCounInfo = function() {
        bootbox.alert('Because of how the map is generated, the actual number of countries may or may not be exactly the number here.');
    };
    $scope.smoothInfo = function() {
        bootbox.alert('Without smoothing, the shapes generated by the map algorithm (a <a href="https://en.wikipedia.org/wiki/Voronoi_diagram" target="_blank">Voronoi Diagram</a>) are very random. Smoothing \'pushes\' the shapes towards being equal size.');
    };
});
